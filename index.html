<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Rooted ‚Äî Grow Where You're Planted</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,500;9..144,600;9..144,700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
    --root-green: #2d5a47; --root-green-light: #3d7a5f; --root-green-dark: #1e3d30;
    --leaf-green: #7cb083; --leaf-light: #a8d4af;
    --earth-brown: #8b7355; --earth-light: #c4a77d;
    --cream: #faf8f5; --cream-dark: #f0ebe3;
    --slate-900: #1a1a2e; --slate-800: #252538; --slate-700: #3d3d56;
    --slate-600: #5a5a78; --slate-500: #7a7a96; --slate-400: #9e9eb8;
    --slate-300: #c4c4d4; --slate-200: #e2e2ec; --slate-100: #f4f4f8;
    --success: #22c55e; --warning: #f59e0b; --error: #ef4444; --info: #3b82f6;
    --font-display: 'Fraunces', Georgia, serif;
    --font-body: 'DM Sans', -apple-system, sans-serif;
    --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px;
    --space-xl: 32px; --space-2xl: 48px; --space-3xl: 64px;
    --sidebar-width: 280px; --header-height: 64px; --max-content: 1200px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
    --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
    --transition: 0.2s ease;
}
[data-theme="dark"] {
    --bg-primary: var(--slate-900); --bg-secondary: var(--slate-800); --bg-tertiary: var(--slate-700);
    --text-primary: var(--cream); --text-secondary: var(--slate-300); --text-tertiary: var(--slate-400);
    --border-color: rgba(255,255,255,0.1); --card-bg: rgba(255,255,255,0.05); --hover-bg: rgba(255,255,255,0.08);
}
[data-theme="light"] {
    --bg-primary: var(--cream); --bg-secondary: white; --bg-tertiary: var(--cream-dark);
    --text-primary: var(--slate-900); --text-secondary: var(--slate-600); --text-tertiary: var(--slate-500);
    --border-color: rgba(0,0,0,0.08); --card-bg: white; --hover-bg: rgba(0,0,0,0.03);
}
html { font-size: 16px; scroll-behavior: smooth; }
body { font-family: var(--font-body); background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; overflow-x: hidden; }
h1, h2, h3, h4 { font-family: var(--font-display); font-weight: 500; }
a { color: inherit; text-decoration: none; }
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; }

@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
@keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
.fade-up { animation: fadeUp 0.4s ease; }
.stagger > * { animation: fadeUp 0.4s ease backwards; }
.stagger > *:nth-child(1) { animation-delay: 0.05s; }
.stagger > *:nth-child(2) { animation-delay: 0.1s; }
.stagger > *:nth-child(3) { animation-delay: 0.15s; }
.stagger > *:nth-child(4) { animation-delay: 0.2s; }

#app { display: flex; min-height: 100vh; }
.sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; transition: transform 0.3s ease; }
.sidebar-header { padding: var(--space-lg); border-bottom: 1px solid var(--border-color); }
.sidebar-logo { display: flex; align-items: center; gap: var(--space-md); }
.sidebar-logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--root-green), var(--leaf-green)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
.sidebar-logo-text { font-family: var(--font-display); font-size: 1.5rem; font-weight: 600; }
.sidebar-church { margin-top: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--hover-bg); border-radius: var(--radius-md); font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; gap: var(--space-sm); }
.sidebar-nav { flex: 1; padding: var(--space-md); overflow-y: auto; }
.nav-section { margin-bottom: var(--space-lg); }
.nav-section-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-tertiary); padding: var(--space-sm) var(--space-md); }
.nav-item { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-md); color: var(--text-secondary); transition: all var(--transition); cursor: pointer; font-size: 0.95rem; }
.nav-item:hover { background: var(--hover-bg); color: var(--text-primary); }
.nav-item.active { background: linear-gradient(135deg, var(--root-green), var(--root-green-light)); color: white; }
.nav-item-icon { width: 20px; text-align: center; }
.nav-item-badge { margin-left: auto; background: var(--error); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; }
.sidebar-footer { padding: var(--space-md); border-top: 1px solid var(--border-color); }
.user-menu { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-md); cursor: pointer; }
.user-menu:hover { background: var(--hover-bg); }
.user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--earth-brown), var(--earth-light)); display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; }
.user-info { flex: 1; }
.user-name { font-weight: 500; font-size: 0.95rem; }
.user-role { font-size: 0.8rem; color: var(--text-tertiary); }

.main-content { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; }
.main-header { height: var(--header-height); background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 var(--space-xl); position: sticky; top: 0; z-index: 50; }
.header-left { display: flex; align-items: center; gap: var(--space-lg); }
.menu-toggle { display: none; width: 40px; height: 40px; align-items: center; justify-content: center; border-radius: var(--radius-md); color: var(--text-secondary); font-size: 1.25rem; }
.page-title { font-family: var(--font-display); font-size: 1.25rem; }
.header-right { display: flex; align-items: center; gap: var(--space-md); }
.header-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-md); color: var(--text-secondary); transition: all var(--transition); }
.header-btn:hover { background: var(--hover-bg); color: var(--text-primary); }
.main-body { flex: 1; padding: var(--space-xl); max-width: var(--max-content); width: 100%; margin: 0 auto; }

.card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-lg); }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); font-weight: 500; font-size: 0.95rem; transition: all var(--transition); }
.btn-primary { background: linear-gradient(135deg, var(--root-green), var(--root-green-light)); color: white; }
.btn-primary:hover { box-shadow: 0 4px 20px rgba(45, 90, 71, 0.4); transform: translateY(-1px); }
.btn-secondary { background: var(--hover-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
.btn-secondary:hover { border-color: var(--root-green); }
.btn-ghost { color: var(--text-secondary); }
.btn-ghost:hover { background: var(--hover-bg); }
.btn-sm { padding: var(--space-sm) var(--space-md); font-size: 0.85rem; }
.btn-lg { padding: var(--space-lg) var(--space-xl); font-size: 1.05rem; }
.btn-block { width: 100%; }
.btn-danger { background: var(--error); color: white; }

.input-group { margin-bottom: var(--space-lg); }
.input-label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); margin-bottom: var(--space-sm); }
.input-field { width: 100%; padding: var(--space-md); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary); font-size: 1rem; }
.input-field:focus { outline: none; border-color: var(--root-green); box-shadow: 0 0 0 3px rgba(45, 90, 71, 0.15); }
select.input-field { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239e9eb8' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

.grid { display: grid; gap: var(--space-lg); }
.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

.tool-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-xl); padding: var(--space-xl); cursor: pointer; transition: all var(--transition); position: relative; overflow: hidden; }
.tool-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--root-green), var(--leaf-green)); opacity: 0; transition: opacity var(--transition); }
.tool-card:hover { border-color: var(--root-green); box-shadow: var(--shadow-lg); transform: translateY(-4px); }
.tool-card:hover::before { opacity: 1; }
.tool-card.disabled { opacity: 0.5; cursor: not-allowed; }
.tool-card.disabled:hover { transform: none; box-shadow: none; border-color: var(--border-color); }
.tool-icon { width: 56px; height: 56px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; margin-bottom: var(--space-lg); }
.tool-title { font-family: var(--font-display); font-size: 1.2rem; margin-bottom: var(--space-sm); }
.tool-description { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: var(--space-lg); }
.tool-meta { display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap; }
.tool-tag { padding: var(--space-xs) var(--space-sm); background: var(--hover-bg); border-radius: var(--radius-sm); font-size: 0.75rem; }

.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--space-lg); }
.stat-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-lg); }
.stat-label { font-size: 0.8rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-sm); }
.stat-value { font-family: var(--font-display); font-size: 2rem; font-weight: 600; }

.welcome-banner { background: linear-gradient(135deg, var(--root-green), var(--root-green-dark)); border-radius: var(--radius-xl); padding: var(--space-2xl); color: white; margin-bottom: var(--space-xl); position: relative; overflow: hidden; }
.welcome-banner::after { content: 'üå±'; position: absolute; right: var(--space-2xl); bottom: -20px; font-size: 8rem; opacity: 0.15; }
.welcome-title { font-size: 1.75rem; margin-bottom: var(--space-sm); }
.welcome-subtitle { opacity: 0.9; max-width: 500px; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); }
.section-title { font-family: var(--font-display); font-size: 1.25rem; }

.empty-state { text-align: center; padding: var(--space-3xl); }
.empty-state-icon { font-size: 4rem; margin-bottom: var(--space-lg); }
.empty-state-title { font-size: 1.5rem; margin-bottom: var(--space-md); }
.empty-state-description { color: var(--text-secondary); max-width: 400px; margin: 0 auto; }

.auth-container { min-height: 100vh; display: flex; }
.auth-left { flex: 1; background: linear-gradient(135deg, var(--root-green), var(--root-green-dark)); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: var(--space-3xl); color: white; }
.auth-brand { text-align: center; }
.auth-logo { font-size: 4rem; margin-bottom: var(--space-lg); }
.auth-brand-name { font-family: var(--font-display); font-size: 3rem; font-weight: 600; margin-bottom: var(--space-md); }
.auth-tagline { font-size: 1.25rem; opacity: 0.9; }
.auth-right { flex: 1; display: flex; align-items: center; justify-content: center; padding: var(--space-2xl); background: var(--bg-primary); }
.auth-form-container { width: 100%; max-width: 400px; }
.auth-form-title { font-size: 2rem; margin-bottom: var(--space-sm); text-align: center; }
.auth-form-subtitle { color: var(--text-secondary); text-align: center; margin-bottom: var(--space-xl); }
.auth-divider { display: flex; align-items: center; gap: var(--space-md); margin: var(--space-lg) 0; color: var(--text-tertiary); font-size: 0.85rem; }
.auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg); }
.modal { background: var(--bg-secondary); border-radius: var(--radius-xl); max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; animation: scaleIn 0.3s ease; }
.modal-header { padding: var(--space-lg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
.modal-title { font-family: var(--font-display); font-size: 1.25rem; }
.modal-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); color: var(--text-tertiary); }
.modal-close:hover { background: var(--hover-bg); }
.modal-body { padding: var(--space-lg); }
.modal-footer { padding: var(--space-lg); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: var(--space-md); }

.toast-container { position: fixed; bottom: var(--space-lg); right: var(--space-lg); z-index: 2000; }
.toast { background: var(--slate-800); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); margin-top: var(--space-sm); animation: fadeUp 0.3s ease; }
.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--error); }
.toast.info { border-left: 4px solid var(--info); }

.admin-tool-item { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); background: var(--hover-bg); border-radius: var(--radius-md); margin-bottom: var(--space-sm); }
.admin-tool-item:hover { background: var(--bg-tertiary); }
.admin-tool-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
.admin-tool-info { flex: 1; }
.admin-tool-name { font-weight: 500; }
.admin-tool-path { font-size: 0.8rem; color: var(--text-tertiary); font-family: monospace; }
.admin-tool-actions { display: flex; gap: var(--space-sm); }

.sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
.sidebar-overlay.show { display: block; }

@media (max-width: 1024px) {
    .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .auth-left { display: none; }
}
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); width: 85%; max-width: 320px; }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .menu-toggle { display: flex; }
    .main-body { padding: var(--space-md); }
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    .welcome-banner { padding: var(--space-lg); }
    .welcome-banner::after { display: none; }
}
    </style>
</head>
<body data-theme="dark">
    <div id="app"></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
    <div class="toast-container" id="toastContainer"></div>
    <div id="modalContainer"></div>
<script>
// ========== CONFIGURATION ==========
const CONFIG = {
    siteName: 'Rooted',
    tagline: 'Grow Where You\'re Planted',
    // Base URL for tools - set this to your GitHub Pages URL
    toolsBasePath: './tools/',
    version: '1.0.0'
};

// ========== BUILT-IN TOOLS ==========
// These are registered in the admin and stored in the database
const DEFAULT_TOOLS = [
    { id: 'seasons', name: 'Discover Your Season', description: 'Find which biblical character\'s journey mirrors your current spiritual season.', icon: 'üå±', color: '#2d5a47', category: 'assessment', duration: '5 min', type: 'internal', path: '', status: 'active' },
    { id: 'formation', name: 'Spiritual Formation Dashboard', description: '100-question assessment across 25 categories for spiritual growth.', icon: 'üìä', color: '#f59e0b', category: 'assessment', duration: '20 min', type: 'external', path: 'spiritual-formation.html', status: 'active' }
];

// ========== DATABASE ==========
const DB = {
    data: null,
    
    init() {
        const stored = localStorage.getItem('rooted_db');
        if (stored) {
            this.data = JSON.parse(stored);
        } else {
            this.data = {
                users: [],
                sessions: {},
                churches: [
                    { id: 'ff001', name: 'Faith Fellowship', city: 'San Leandro', state: 'CA', logo: '‚õ™', color: '#2d5a47' },
                    { id: 'gc002', name: 'Grace Community', city: 'Hayward', state: 'CA', logo: '‚úùÔ∏è', color: '#7c3aed' }
                ],
                tools: [...DEFAULT_TOOLS],
                toolProgress: {},
                resources: {},
                settings: {
                    githubRepo: '',
                    toolsBasePath: './tools/'
                }
            };
            this.save();
        }
        return this.data;
    },
    
    save() {
        localStorage.setItem('rooted_db', JSON.stringify(this.data));
    },
    
    // User methods
    createUser(userData) {
        const user = { id: 'user_' + Date.now(), ...userData, createdAt: new Date().toISOString(), role: 'member' };
        this.data.users.push(user);
        this.save();
        return user;
    },
    
    findUser(email) {
        return this.data.users.find(u => u.email === email);
    },
    
    updateUser(userId, updates) {
        const user = this.data.users.find(u => u.id === userId);
        if (user) Object.assign(user, updates);
        this.save();
        return user;
    },
    
    // Session methods
    createSession(userId) {
        const token = 'sess_' + Date.now();
        this.data.sessions[token] = { userId, createdAt: new Date().toISOString() };
        this.save();
        localStorage.setItem('rooted_session', token);
        return token;
    },
    
    getSession() {
        const token = localStorage.getItem('rooted_session');
        if (!token) return null;
        const session = this.data.sessions[token];
        if (!session) return null;
        return this.data.users.find(u => u.id === session.userId);
    },
    
    logout() {
        const token = localStorage.getItem('rooted_session');
        if (token) delete this.data.sessions[token];
        localStorage.removeItem('rooted_session');
        this.save();
    },
    
    // Church methods
    getChurches(search = '') {
        if (!search) return this.data.churches;
        const s = search.toLowerCase();
        return this.data.churches.filter(c => c.name.toLowerCase().includes(s) || c.city.toLowerCase().includes(s));
    },
    
    getChurch(id) {
        return this.data.churches.find(c => c.id === id);
    },
    
    // Tool methods
    getTools() {
        return this.data.tools || [];
    },
    
    getTool(id) {
        return this.data.tools.find(t => t.id === id);
    },
    
    addTool(tool) {
        const newTool = { id: 'tool_' + Date.now(), ...tool, status: 'active' };
        this.data.tools.push(newTool);
        this.save();
        return newTool;
    },
    
    updateTool(id, updates) {
        const tool = this.data.tools.find(t => t.id === id);
        if (tool) Object.assign(tool, updates);
        this.save();
        return tool;
    },
    
    deleteTool(id) {
        this.data.tools = this.data.tools.filter(t => t.id !== id);
        this.save();
    },
    
    // Settings
    getSettings() {
        return this.data.settings || {};
    },
    
    updateSettings(updates) {
        this.data.settings = { ...this.data.settings, ...updates };
        this.save();
    },
    
    // Tool progress
    saveToolProgress(userId, toolId, progress) {
        if (!this.data.toolProgress[userId]) this.data.toolProgress[userId] = {};
        this.data.toolProgress[userId][toolId] = { ...progress, updatedAt: new Date().toISOString() };
        this.save();
    },
    
    getToolProgress(userId, toolId) {
        return this.data.toolProgress[userId]?.[toolId];
    },
    
    getAllToolProgress(userId) {
        return this.data.toolProgress[userId] || {};
    },
    
    // Resources
    getResources(churchId) {
        return this.data.resources[churchId] || { links: {}, items: [] };
    },
    
    saveResources(churchId, resources) {
        this.data.resources[churchId] = resources;
        this.save();
    },
    
    // Export/Import
    exportData() {
        return JSON.stringify(this.data, null, 2);
    },
    
    importData(jsonStr) {
        try {
            this.data = JSON.parse(jsonStr);
            this.save();
            return true;
        } catch (e) {
            return false;
        }
    }
};

// ========== STATE ==========
const State = {
    current: {
        screen: 'loading',
        user: null,
        church: null,
        activeNav: 'dashboard',
        sidebarOpen: false
    },
    listeners: [],
    
    set(updates) {
        this.current = { ...this.current, ...updates };
        this.listeners.forEach(fn => fn(this.current));
    },
    
    subscribe(fn) {
        this.listeners.push(fn);
    }
};

// ========== HELPERS ==========
function toast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = message;
    container.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function toggleSidebar(open) {
    State.set({ sidebarOpen: open });
    document.querySelector('.sidebar')?.classList.toggle('open', open);
    document.getElementById('sidebarOverlay')?.classList.toggle('show', open);
}

function navigate(page) {
    State.set({ activeNav: page });
    toggleSidebar(false);
}

function toggleTheme() {
    const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    document.body.dataset.theme = theme;
    localStorage.setItem('rooted_theme', theme);
    render();
}

function showModal(content) {
    document.getElementById('modalContainer').innerHTML = `<div class="modal-overlay" onclick="closeModal()">${content}</div>`;
}

function closeModal() {
    document.getElementById('modalContainer').innerHTML = '';
}

// ========== ROUTER ==========
function initRouter() {
    const user = DB.getSession();
    if (user) {
        const church = DB.getChurch(user.churchId);
        State.set({ screen: 'app', user, church, activeNav: 'dashboard' });
    } else {
        State.set({ screen: 'welcome' });
    }
}

// ========== RENDER ==========
function render() {
    const app = document.getElementById('app');
    const { screen } = State.current;
    
    switch(screen) {
        case 'loading':
            app.innerHTML = `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center"><div style="text-align:center"><div style="font-size:4rem;animation:pulse 1.5s infinite">üå±</div><p style="margin-top:16px;color:var(--text-secondary)">Loading...</p></div></div>`;
            break;
        case 'welcome':
            app.innerHTML = renderWelcome();
            break;
        case 'find-church':
            app.innerHTML = renderFindChurch();
            break;
        case 'signup':
            app.innerHTML = renderSignup();
            break;
        case 'login':
            app.innerHTML = renderLogin();
            break;
        case 'app':
            app.innerHTML = renderApp();
            break;
        case 'tool-seasons':
            app.innerHTML = renderSeasonsTool();
            setTimeout(initQuiz, 50);
            break;
    }
}

function renderWelcome() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">${CONFIG.siteName}</h1>
                <p class="auth-tagline">${CONFIG.tagline}</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <h2 class="auth-form-title">Welcome</h2>
                <p class="auth-form-subtitle">Connect with your church and grow in your faith.</p>
                <button class="btn btn-primary btn-lg btn-block" onclick="State.set({screen:'find-church'})">Find Your Church</button>
                <div class="auth-divider">or</div>
                <button class="btn btn-secondary btn-lg btn-block" onclick="State.set({screen:'login'})">Sign In</button>
                <div class="auth-divider">try it out</div>
                <button class="btn btn-ghost btn-lg btn-block" onclick="demoMode()" style="border:2px dashed var(--border-color)">üöÄ Demo Mode</button>
            </div>
        </div>
    </div>`;
}

function demoMode() {
    const church = DB.getChurch('ff001');
    const user = { id: 'demo', name: 'Demo User', email: 'demo@rooted.app', role: 'admin', churchId: 'ff001' };
    toast('Welcome to Demo Mode!', 'success');
    State.set({ screen: 'app', user, church, activeNav: 'dashboard' });
}

function renderFindChurch() {
    const churches = DB.getChurches();
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">‚õ™</div>
                <h1 class="auth-brand-name" style="font-size:2rem">Find Your Church</h1>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container" style="max-width:500px">
                <button class="btn btn-ghost" onclick="State.set({screen:'welcome'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
                <h2 class="auth-form-title">Find Your Church</h2>
                <div class="input-group">
                    <input type="text" class="input-field" placeholder="Search churches..." oninput="filterChurches(this.value)" id="churchSearch">
                </div>
                <div id="churchList" style="max-height:300px;overflow-y:auto">
                    ${churches.map(c => `
                        <div onclick="selectChurch('${c.id}')" style="display:flex;align-items:center;gap:var(--space-md);padding:var(--space-md);border:1px solid var(--border-color);border-radius:var(--radius-md);margin-bottom:var(--space-sm);cursor:pointer">
                            <div style="width:48px;height:48px;background:${c.color};border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.5rem">${c.logo}</div>
                            <div><div style="font-weight:500">${c.name}</div><div style="font-size:0.85rem;color:var(--text-tertiary)">${c.city}, ${c.state}</div></div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    </div>`;
}

function filterChurches(q) {
    const churches = DB.getChurches(q);
    document.getElementById('churchList').innerHTML = churches.map(c => `
        <div onclick="selectChurch('${c.id}')" style="display:flex;align-items:center;gap:var(--space-md);padding:var(--space-md);border:1px solid var(--border-color);border-radius:var(--radius-md);margin-bottom:var(--space-sm);cursor:pointer">
            <div style="width:48px;height:48px;background:${c.color};border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.5rem">${c.logo}</div>
            <div><div style="font-weight:500">${c.name}</div><div style="font-size:0.85rem;color:var(--text-tertiary)">${c.city}, ${c.state}</div></div>
        </div>
    `).join('') || '<p style="text-align:center;color:var(--text-tertiary);padding:var(--space-lg)">No churches found</p>';
}

function selectChurch(id) {
    State.set({ selectedChurch: DB.getChurch(id), screen: 'signup' });
}

function renderSignup() {
    const church = State.current.selectedChurch;
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">${church?.logo}</div>
                <h1 class="auth-brand-name" style="font-size:2rem">${church?.name}</h1>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'find-church'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
                <h2 class="auth-form-title">Create Account</h2>
                <form onsubmit="handleSignup(event)">
                    <div class="input-group"><label class="input-label">Name</label><input type="text" class="input-field" id="signupName" required></div>
                    <div class="input-group"><label class="input-label">Email</label><input type="email" class="input-field" id="signupEmail" required></div>
                    <div class="input-group"><label class="input-label">Password</label><input type="password" class="input-field" id="signupPassword" required></div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Create Account</button>
                </form>
            </div>
        </div>
    </div>`;
}

function handleSignup(e) {
    e.preventDefault();
    const church = State.current.selectedChurch;
    if (DB.findUser(document.getElementById('signupEmail').value)) {
        toast('Email already exists', 'error');
        return;
    }
    const user = DB.createUser({
        name: document.getElementById('signupName').value,
        email: document.getElementById('signupEmail').value,
        password: document.getElementById('signupPassword').value,
        churchId: church.id,
        role: 'member'
    });
    DB.createSession(user.id);
    toast('Welcome to Rooted! üå±', 'success');
    State.set({ screen: 'app', user, church, activeNav: 'dashboard' });
}

function renderLogin() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">${CONFIG.siteName}</h1>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'welcome'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
                <h2 class="auth-form-title">Sign In</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="input-group"><label class="input-label">Email</label><input type="email" class="input-field" id="loginEmail" required></div>
                    <div class="input-group"><label class="input-label">Password</label><input type="password" class="input-field" id="loginPassword" required></div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Sign In</button>
                </form>
            </div>
        </div>
    </div>`;
}

function handleLogin(e) {
    e.preventDefault();
    const user = DB.findUser(document.getElementById('loginEmail').value);
    if (!user || user.password !== document.getElementById('loginPassword').value) {
        toast('Invalid credentials', 'error');
        return;
    }
    DB.createSession(user.id);
    const church = DB.getChurch(user.churchId);
    toast('Welcome back!', 'success');
    State.set({ screen: 'app', user, church, activeNav: 'dashboard' });
}

function handleLogout() {
    DB.logout();
    State.set({ screen: 'welcome', user: null, church: null });
}

// ========== MAIN APP ==========
function renderApp() {
    const { user, church, activeNav } = State.current;
    const isAdmin = user?.role === 'admin';
    
    return `
    <aside class="sidebar ${State.current.sidebarOpen ? 'open' : ''}">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üå±</div>
                <span class="sidebar-logo-text">${CONFIG.siteName}</span>
            </div>
            ${church ? `<div class="sidebar-church"><span>${church.logo}</span> ${church.name}</div>` : ''}
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <div class="nav-item ${activeNav === 'dashboard' ? 'active' : ''}" onclick="navigate('dashboard')"><span class="nav-item-icon">üè†</span> Dashboard</div>
                <div class="nav-item ${activeNav === 'tools' ? 'active' : ''}" onclick="navigate('tools')"><span class="nav-item-icon">üß∞</span> Growth Tools</div>
                <div class="nav-item ${activeNav === 'resources' ? 'active' : ''}" onclick="navigate('resources')"><span class="nav-item-icon">üìö</span> Resources</div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Community</div>
                <div class="nav-item ${activeNav === 'groups' ? 'active' : ''}" onclick="navigate('groups')"><span class="nav-item-icon">üë•</span> Groups</div>
                <div class="nav-item ${activeNav === 'prayer' ? 'active' : ''}" onclick="navigate('prayer')"><span class="nav-item-icon">üôè</span> Prayer Wall</div>
            </div>
            ${isAdmin ? `
            <div class="nav-section">
                <div class="nav-section-title">Admin</div>
                <div class="nav-item ${activeNav === 'admin-tools' ? 'active' : ''}" onclick="navigate('admin-tools')"><span class="nav-item-icon">‚öôÔ∏è</span> Manage Tools</div>
                <div class="nav-item ${activeNav === 'admin-settings' ? 'active' : ''}" onclick="navigate('admin-settings')"><span class="nav-item-icon">üîß</span> Settings</div>
            </div>
            ` : ''}
        </nav>
        <div class="sidebar-footer">
            <div class="user-menu" onclick="handleLogout()">
                <div class="user-avatar">${user?.name?.charAt(0) || 'U'}</div>
                <div class="user-info">
                    <div class="user-name">${user?.name || 'User'}</div>
                    <div class="user-role">${isAdmin ? 'Admin' : 'Member'}</div>
                </div>
            </div>
        </div>
    </aside>
    <main class="main-content">
        <header class="main-header">
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleSidebar(true)">‚ò∞</button>
                <h1 class="page-title">${getPageTitle(activeNav)}</h1>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="toggleTheme()">${document.body.dataset.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}</button>
            </div>
        </header>
        <div class="main-body">${renderPage(activeNav)}</div>
    </main>`;
}

function getPageTitle(nav) {
    const titles = {
        dashboard: 'Dashboard', tools: 'Growth Tools', resources: 'Resources',
        groups: 'Groups', prayer: 'Prayer Wall', 'admin-tools': 'Manage Tools', 'admin-settings': 'Settings'
    };
    return titles[nav] || 'Dashboard';
}

function renderPage(page) {
    switch(page) {
        case 'dashboard': return renderDashboard();
        case 'tools': return renderTools();
        case 'resources': return renderResources();
        case 'groups': return renderComingSoon('üë•', 'Groups');
        case 'prayer': return renderComingSoon('üôè', 'Prayer Wall');
        case 'admin-tools': return renderAdminTools();
        case 'admin-settings': return renderAdminSettings();
        default: return renderDashboard();
    }
}

function renderComingSoon(icon, title) {
    return `<div class="empty-state fade-up"><div class="empty-state-icon">${icon}</div><h3 class="empty-state-title">${title} Coming Soon</h3><p class="empty-state-description">This feature is under development.</p></div>`;
}

function renderDashboard() {
    const { user, church } = State.current;
    const progress = DB.getAllToolProgress(user?.id);
    const tools = DB.getTools().filter(t => t.status === 'active');
    
    return `
    <div class="fade-up">
        <div class="welcome-banner">
            <h2 class="welcome-title">Welcome back, ${user?.name?.split(' ')[0]}!</h2>
            <p class="welcome-subtitle">Continue growing in your faith with ${church?.name}.</p>
        </div>
        
        <div class="stat-grid stagger" style="margin-bottom:var(--space-2xl)">
            <div class="stat-card"><div class="stat-label">Tools Available</div><div class="stat-value">${tools.length}</div></div>
            <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value">${Object.keys(progress).length}</div></div>
            <div class="stat-card"><div class="stat-label">Streak</div><div class="stat-value">7 days</div></div>
        </div>
        
        <div class="section-header">
            <h3 class="section-title">Continue Growing</h3>
            <button class="btn btn-ghost btn-sm" onclick="navigate('tools')">View All ‚Üí</button>
        </div>
        <div class="grid grid-2 stagger">
            ${tools.slice(0, 2).map(t => renderToolCard(t)).join('')}
        </div>
    </div>`;
}

function renderTools() {
    const tools = DB.getTools();
    const categories = [...new Set(tools.map(t => t.category))];
    
    return `
    <div class="fade-up">
        <p style="color:var(--text-secondary);margin-bottom:var(--space-xl)">Discover tools designed to help you grow in your faith.</p>
        ${categories.map(cat => `
            <div class="section-header"><h3 class="section-title" style="text-transform:capitalize">${cat}</h3></div>
            <div class="grid grid-3 stagger" style="margin-bottom:var(--space-2xl)">
                ${tools.filter(t => t.category === cat).map(t => renderToolCard(t)).join('')}
            </div>
        `).join('')}
    </div>`;
}

function renderToolCard(tool) {
    const isActive = tool.status === 'active';
    const isExternal = tool.type === 'external';
    
    return `
    <div class="tool-card ${!isActive ? 'disabled' : ''}" onclick="${isActive ? `openTool('${tool.id}')` : ''}">
        <div class="tool-icon" style="background:linear-gradient(135deg, ${tool.color}, ${tool.color}dd)">${tool.icon}</div>
        <h4 class="tool-title">${tool.name}</h4>
        <p class="tool-description">${tool.description}</p>
        <div class="tool-meta">
            <span class="tool-tag">${tool.duration}</span>
            ${isExternal ? '<span class="tool-tag" style="background:var(--info);color:white">‚Üó External</span>' : ''}
            ${!isActive ? '<span class="tool-tag">Coming Soon</span>' : ''}
        </div>
    </div>`;
}

function openTool(toolId) {
    const tool = DB.getTool(toolId);
    if (!tool) return;
    
    if (tool.type === 'internal') {
        // Built-in tool
        if (toolId === 'seasons') {
            State.set({ screen: 'tool-seasons' });
        }
    } else if (tool.type === 'external' && tool.path) {
        // External tool - open relative path
        const basePath = DB.getSettings().toolsBasePath || './tools/';
        const url = basePath + tool.path;
        window.open(url, '_blank');
    }
}

// ========== ADMIN: MANAGE TOOLS ==========
function renderAdminTools() {
    const tools = DB.getTools();
    
    return `
    <div class="fade-up">
        <div class="card" style="margin-bottom:var(--space-lg)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-lg)">
                <div>
                    <h3 style="margin-bottom:var(--space-xs)">üß∞ Growth Tools</h3>
                    <p style="color:var(--text-tertiary);font-size:0.9rem">${tools.length} tools configured</p>
                </div>
                <button class="btn btn-primary" onclick="openAddToolModal()">+ Add Tool</button>
            </div>
            
            <div id="toolsList">
                ${tools.map(t => `
                    <div class="admin-tool-item">
                        <div class="admin-tool-icon" style="background:linear-gradient(135deg, ${t.color}, ${t.color}dd)">${t.icon}</div>
                        <div class="admin-tool-info">
                            <div class="admin-tool-name">${t.name}</div>
                            <div class="admin-tool-path">${t.type === 'internal' ? 'Built-in' : t.path || 'No path set'}</div>
                        </div>
                        <div style="margin-right:var(--space-md)">
                            <span class="tool-tag" style="${t.status === 'active' ? 'background:var(--success);color:white' : ''}">${t.status}</span>
                        </div>
                        <div class="admin-tool-actions">
                            <button class="btn btn-sm btn-secondary" onclick="openEditToolModal('${t.id}')">Edit</button>
                            ${t.type !== 'internal' ? `<button class="btn btn-sm btn-ghost" onclick="deleteTool('${t.id}')" style="color:var(--error)">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:var(--space-md)">üìÅ Tools Folder Structure</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-md)">Place your tool HTML files in the <code style="background:var(--hover-bg);padding:2px 6px;border-radius:4px">/tools/</code> folder of your GitHub repository:</p>
            <pre style="background:var(--bg-primary);padding:var(--space-md);border-radius:var(--radius-md);font-size:0.85rem;overflow-x:auto">
your-repo/
‚îú‚îÄ‚îÄ index.html          ‚Üê Rooted Platform (this file)
‚îî‚îÄ‚îÄ tools/
    ‚îú‚îÄ‚îÄ spiritual-formation.html
    ‚îú‚îÄ‚îÄ bible-reading.html
    ‚îî‚îÄ‚îÄ (your other tools...)
            </pre>
        </div>
    </div>`;
}

function openAddToolModal() {
    showModal(`
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Add New Tool</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Tool Name</label>
                    <input type="text" class="input-field" id="toolName" placeholder="e.g., Bible Reading Plan">
                </div>
                <div class="input-group">
                    <label class="input-label">Description</label>
                    <textarea class="input-field" id="toolDesc" rows="2" placeholder="Brief description..."></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">Icon (emoji)</label>
                    <input type="text" class="input-field" id="toolIcon" placeholder="üìñ" maxlength="2">
                </div>
                <div class="input-group">
                    <label class="input-label">Color</label>
                    <input type="color" class="input-field" id="toolColor" value="#2d5a47" style="height:50px;padding:8px">
                </div>
                <div class="input-group">
                    <label class="input-label">Category</label>
                    <select class="input-field" id="toolCategory">
                        <option value="assessment">Assessment</option>
                        <option value="bible">Bible Study</option>
                        <option value="devotional">Devotional</option>
                        <option value="discipleship">Discipleship</option>
                        <option value="community">Community</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Duration</label>
                    <input type="text" class="input-field" id="toolDuration" placeholder="e.g., 10 min, Daily, 6 weeks">
                </div>
                <div class="input-group">
                    <label class="input-label">File Path (in /tools/ folder)</label>
                    <input type="text" class="input-field" id="toolPath" placeholder="e.g., bible-reading.html">
                </div>
                <div class="input-group">
                    <label class="input-label">Status</label>
                    <select class="input-field" id="toolStatus">
                        <option value="active">Active</option>
                        <option value="coming">Coming Soon</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTool()">Add Tool</button>
            </div>
        </div>
    `);
}

function openEditToolModal(toolId) {
    const tool = DB.getTool(toolId);
    if (!tool) return;
    
    showModal(`
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Edit Tool</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Tool Name</label>
                    <input type="text" class="input-field" id="toolName" value="${tool.name}">
                </div>
                <div class="input-group">
                    <label class="input-label">Description</label>
                    <textarea class="input-field" id="toolDesc" rows="2">${tool.description}</textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">Icon (emoji)</label>
                    <input type="text" class="input-field" id="toolIcon" value="${tool.icon}" maxlength="2">
                </div>
                <div class="input-group">
                    <label class="input-label">Color</label>
                    <input type="color" class="input-field" id="toolColor" value="${tool.color}" style="height:50px;padding:8px">
                </div>
                <div class="input-group">
                    <label class="input-label">Category</label>
                    <select class="input-field" id="toolCategory">
                        <option value="assessment" ${tool.category === 'assessment' ? 'selected' : ''}>Assessment</option>
                        <option value="bible" ${tool.category === 'bible' ? 'selected' : ''}>Bible Study</option>
                        <option value="devotional" ${tool.category === 'devotional' ? 'selected' : ''}>Devotional</option>
                        <option value="discipleship" ${tool.category === 'discipleship' ? 'selected' : ''}>Discipleship</option>
                        <option value="community" ${tool.category === 'community' ? 'selected' : ''}>Community</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Duration</label>
                    <input type="text" class="input-field" id="toolDuration" value="${tool.duration}">
                </div>
                ${tool.type === 'external' ? `
                <div class="input-group">
                    <label class="input-label">File Path (in /tools/ folder)</label>
                    <input type="text" class="input-field" id="toolPath" value="${tool.path || ''}">
                </div>
                ` : '<input type="hidden" id="toolPath" value="">'}
                <div class="input-group">
                    <label class="input-label">Status</label>
                    <select class="input-field" id="toolStatus">
                        <option value="active" ${tool.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="coming" ${tool.status === 'coming' ? 'selected' : ''}>Coming Soon</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="updateTool('${toolId}')">Save Changes</button>
            </div>
        </div>
    `);
}

function saveTool() {
    const tool = {
        name: document.getElementById('toolName').value,
        description: document.getElementById('toolDesc').value,
        icon: document.getElementById('toolIcon').value || 'üìå',
        color: document.getElementById('toolColor').value,
        category: document.getElementById('toolCategory').value,
        duration: document.getElementById('toolDuration').value,
        path: document.getElementById('toolPath').value,
        type: 'external',
        status: document.getElementById('toolStatus').value
    };
    
    if (!tool.name) {
        toast('Please enter a tool name', 'error');
        return;
    }
    
    DB.addTool(tool);
    closeModal();
    toast('Tool added!', 'success');
    render();
}

function updateTool(toolId) {
    const updates = {
        name: document.getElementById('toolName').value,
        description: document.getElementById('toolDesc').value,
        icon: document.getElementById('toolIcon').value,
        color: document.getElementById('toolColor').value,
        category: document.getElementById('toolCategory').value,
        duration: document.getElementById('toolDuration').value,
        path: document.getElementById('toolPath').value,
        status: document.getElementById('toolStatus').value
    };
    
    DB.updateTool(toolId, updates);
    closeModal();
    toast('Tool updated!', 'success');
    render();
}

function deleteTool(toolId) {
    if (!confirm('Delete this tool?')) return;
    DB.deleteTool(toolId);
    toast('Tool deleted', 'info');
    render();
}

// ========== ADMIN: SETTINGS ==========
function renderAdminSettings() {
    const settings = DB.getSettings();
    
    return `
    <div class="fade-up">
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">üîß Site Settings</h3>
            
            <div class="input-group">
                <label class="input-label">Tools Base Path</label>
                <input type="text" class="input-field" id="settingsToolsPath" value="${settings.toolsBasePath || './tools/'}" placeholder="./tools/">
                <p style="font-size:0.8rem;color:var(--text-tertiary);margin-top:var(--space-xs)">Relative path to your tools folder</p>
            </div>
            
            <div class="input-group">
                <label class="input-label">GitHub Repository URL (optional)</label>
                <input type="text" class="input-field" id="settingsGithubRepo" value="${settings.githubRepo || ''}" placeholder="https://github.com/username/repo">
            </div>
            
            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
        
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">üì¶ Data Management</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">Export your data for backup or import from a backup file.</p>
            <div style="display:flex;gap:var(--space-md);flex-wrap:wrap">
                <button class="btn btn-secondary" onclick="exportData()">üì• Export Data</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
        </div>
        
        <div class="card" style="border-color:var(--error)">
            <h3 style="margin-bottom:var(--space-md);color:var(--error)">‚ö†Ô∏è Danger Zone</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">This will delete all local data and reset the app.</p>
            <button class="btn btn-danger" onclick="resetApp()">Reset App</button>
        </div>
    </div>`;
}

function saveSettings() {
    DB.updateSettings({
        toolsBasePath: document.getElementById('settingsToolsPath').value,
        githubRepo: document.getElementById('settingsGithubRepo').value
    });
    toast('Settings saved!', 'success');
}

function exportData() {
    const data = DB.exportData();
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rooted-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Data exported!', 'success');
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        if (DB.importData(e.target.result)) {
            toast('Data imported! Reloading...', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            toast('Invalid file', 'error');
        }
    };
    reader.readAsText(file);
}

function resetApp() {
    if (!confirm('Delete ALL data and reset? This cannot be undone!')) return;
    localStorage.clear();
    location.reload();
}

// ========== RESOURCES ==========
function renderResources() {
    const { church } = State.current;
    const resources = DB.getResources(church?.id);
    const links = resources.links || {};
    const items = resources.items || [];
    
    return `
    <div class="fade-up">
        <div class="card" style="margin-bottom:var(--space-lg)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-lg)">
                <h3>‚õ™ Church Links</h3>
                <button class="btn btn-sm btn-secondary" onclick="openLinksModal()">Edit</button>
            </div>
            <div class="grid grid-2" style="gap:var(--space-md)">
                ${links.website ? `<a href="${links.website}" target="_blank" class="btn btn-secondary" style="justify-content:flex-start"><span>üåê</span> Website</a>` : ''}
                ${links.youtube ? `<a href="${links.youtube}" target="_blank" class="btn btn-secondary" style="justify-content:flex-start"><span>üì∫</span> YouTube</a>` : ''}
                ${links.facebook ? `<a href="${links.facebook}" target="_blank" class="btn btn-secondary" style="justify-content:flex-start"><span>üìò</span> Facebook</a>` : ''}
                ${links.instagram ? `<a href="${links.instagram}" target="_blank" class="btn btn-secondary" style="justify-content:flex-start"><span>üì∏</span> Instagram</a>` : ''}
                ${links.giving ? `<a href="${links.giving}" target="_blank" class="btn btn-secondary" style="justify-content:flex-start"><span>üíù</span> Give</a>` : ''}
                ${!links.website && !links.youtube && !links.facebook && !links.instagram && !links.giving ? '<p style="color:var(--text-tertiary);grid-column:1/-1">No links added yet. Click Edit to add your church links.</p>' : ''}
            </div>
        </div>
        
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-lg)">
                <h3>üìö Resources</h3>
                <button class="btn btn-sm btn-primary" onclick="openAddResourceModal()">+ Add</button>
            </div>
            ${items.length > 0 ? `
                <div style="display:flex;flex-direction:column;gap:var(--space-sm)">
                    ${items.map((r, i) => `
                        <div style="display:flex;align-items:center;gap:var(--space-md);padding:var(--space-md);background:var(--hover-bg);border-radius:var(--radius-md)">
                            <span style="font-size:1.5rem">${r.icon || 'üìÑ'}</span>
                            <div style="flex:1"><div style="font-weight:500">${r.title}</div><div style="font-size:0.8rem;color:var(--text-tertiary)">${r.type}</div></div>
                            <a href="${r.url}" target="_blank" class="btn btn-sm btn-secondary">Open</a>
                            <button class="btn btn-sm btn-ghost" onclick="deleteResource(${i})" style="color:var(--error)">üóëÔ∏è</button>
                        </div>
                    `).join('')}
                </div>
            ` : '<p style="color:var(--text-tertiary)">No resources added yet.</p>'}
        </div>
    </div>`;
}

function openLinksModal() {
    const { church } = State.current;
    const links = DB.getResources(church?.id).links || {};
    
    showModal(`
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header"><h3 class="modal-title">Edit Church Links</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>
            <div class="modal-body">
                <div class="input-group"><label class="input-label">üåê Website</label><input type="url" class="input-field" id="linkWebsite" value="${links.website || ''}"></div>
                <div class="input-group"><label class="input-label">üì∫ YouTube</label><input type="url" class="input-field" id="linkYoutube" value="${links.youtube || ''}"></div>
                <div class="input-group"><label class="input-label">üìò Facebook</label><input type="url" class="input-field" id="linkFacebook" value="${links.facebook || ''}"></div>
                <div class="input-group"><label class="input-label">üì∏ Instagram</label><input type="url" class="input-field" id="linkInstagram" value="${links.instagram || ''}"></div>
                <div class="input-group"><label class="input-label">üíù Giving</label><input type="url" class="input-field" id="linkGiving" value="${links.giving || ''}"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveLinks()">Save</button></div>
        </div>
    `);
}

function saveLinks() {
    const { church } = State.current;
    const resources = DB.getResources(church?.id);
    resources.links = {
        website: document.getElementById('linkWebsite').value,
        youtube: document.getElementById('linkYoutube').value,
        facebook: document.getElementById('linkFacebook').value,
        instagram: document.getElementById('linkInstagram').value,
        giving: document.getElementById('linkGiving').value
    };
    DB.saveResources(church.id, resources);
    closeModal();
    toast('Links saved!', 'success');
    render();
}

function openAddResourceModal() {
    showModal(`
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header"><h3 class="modal-title">Add Resource</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>
            <div class="modal-body">
                <div class="input-group"><label class="input-label">Title</label><input type="text" class="input-field" id="resTitle"></div>
                <div class="input-group"><label class="input-label">URL</label><input type="url" class="input-field" id="resUrl"></div>
                <div class="input-group"><label class="input-label">Type</label>
                    <select class="input-field" id="resType">
                        <option value="Sermon">üé§ Sermon</option>
                        <option value="Study">üìñ Study Guide</option>
                        <option value="Document">üìÑ Document</option>
                        <option value="Video">üé¨ Video</option>
                        <option value="Other">üîó Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveResource()">Add</button></div>
        </div>
    `);
}

function saveResource() {
    const { church } = State.current;
    const resources = DB.getResources(church?.id);
    if (!resources.items) resources.items = [];
    const icons = { Sermon: 'üé§', Study: 'üìñ', Document: 'üìÑ', Video: 'üé¨', Other: 'üîó' };
    const type = document.getElementById('resType').value;
    resources.items.push({
        title: document.getElementById('resTitle').value,
        url: document.getElementById('resUrl').value,
        type: type,
        icon: icons[type]
    });
    DB.saveResources(church.id, resources);
    closeModal();
    toast('Resource added!', 'success');
    render();
}

function deleteResource(index) {
    const { church } = State.current;
    const resources = DB.getResources(church?.id);
    resources.items.splice(index, 1);
    DB.saveResources(church.id, resources);
    toast('Deleted', 'info');
    render();
}

// ========== DISCOVER YOUR SEASON (INTERNAL TOOL) ==========
const CHARACTERS = {
    moses: { name: "Moses", title: "The Reluctant Leader", icon: "üî•", color: "#b45309", description: "You're in a season of being called to something bigger than yourself, even though you feel inadequate." },
    david: { name: "David", title: "The Worshiper's Heart", icon: "üéµ", color: "#7c3aed", description: "You're in a season where intimacy with God matters more than success. Your heart quickly returns to worship." },
    abraham: { name: "Abraham", title: "The Faith Walker", icon: "‚≠ê", color: "#0284c7", description: "You're in a season of stepping into the unknown, trusting God without seeing the full picture." },
    esther: { name: "Esther", title: "The Strategic Intercessor", icon: "üëë", color: "#db2777", description: "You're in a season of divine positioning. God has placed you where you are for such a time as this." },
    joseph: { name: "Joseph", title: "The Faithful Sufferer", icon: "üåæ", color: "#059669", description: "You're in a season of private pain and unseen faithfulness. God is building character in hidden places." },
    peter: { name: "Peter", title: "The Restored Leader", icon: "ü™®", color: "#64748b", description: "You're in a season of restoration after failure. Jesus is turning your shame into ministry." },
    paul: { name: "Paul", title: "The Transformed Missionary", icon: "‚úùÔ∏è", color: "#dc2626", description: "You're in a season of radical transformation. God has dramatically changed your direction." },
    ruth: { name: "Ruth", title: "The Faithful Outsider", icon: "üåø", color: "#84cc16", description: "You're in a season of faithfulness in ordinary life. Your steadfast love is writing you into God's story." }
};

const QUESTIONS = [
    { q: "When facing a major decision, what is your primary inner struggle?", a: [
        { text: "I feel unqualified and make excuses", chars: { moses: 3, peter: 1 } },
        { text: "I'm torn between trusting God's timing and making it happen myself", chars: { abraham: 3, joseph: 2 } },
        { text: "I want to act but fear the cost", chars: { esther: 3, paul: 1 } },
        { text: "I seek counsel and try to discern God's direction", chars: { ruth: 2, david: 1 } }
    ]},
    { q: "How do you respond when you've failed?", a: [
        { text: "I return to God in honest, emotional repentance", chars: { david: 3, peter: 2 } },
        { text: "I feel disqualified and wonder if God can still use me", chars: { peter: 3, moses: 2 } },
        { text: "I process privately, trusting God is still working", chars: { joseph: 3, ruth: 2 } },
        { text: "I remember what Jesus delivered me from", chars: { paul: 3, david: 1 } }
    ]},
    { q: "What best describes your relationship with waiting on God?", a: [
        { text: "I'm holding unfulfilled promises", chars: { abraham: 3, joseph: 2 } },
        { text: "I'm being prepared in hiddenness", chars: { moses: 3, david: 1 } },
        { text: "I sense I'm positioned for something specific", chars: { esther: 3, ruth: 1 } },
        { text: "I'm learning through others' investment in me", chars: { ruth: 2, peter: 1 } }
    ]},
    { q: "When others look to you for leadership, how do you feel?", a: [
        { text: "Inadequate‚Äîwho am I to lead?", chars: { moses: 3, peter: 1 } },
        { text: "Responsible‚ÄîGod positioned me here", chars: { esther: 3, joseph: 1 } },
        { text: "Restored‚Äîmy failures give me something to offer", chars: { peter: 3, paul: 2 } },
        { text: "Quiet confidence‚ÄîI'd rather develop others", chars: { ruth: 2, abraham: 1 } }
    ]},
    { q: "What has suffering produced most in your life?", a: [
        { text: "Deeper intimacy with God and quicker return to worship", chars: { david: 3, paul: 1 } },
        { text: "Character and ability to see God's redemptive purposes", chars: { joseph: 3, ruth: 2 } },
        { text: "Boldness‚ÄîI'm no longer afraid to risk", chars: { paul: 3, esther: 2 } },
        { text: "Compassion for others in pain", chars: { moses: 2, peter: 2 } }
    ]}
];

let quizState = { screen: 'start', qIndex: 0, answer: null, scores: {} };

function renderSeasonsTool() {
    return `
    <div style="min-height:100vh;background:linear-gradient(135deg,var(--bg-primary),var(--slate-900));padding:var(--space-lg)">
        <div style="max-width:600px;margin:0 auto">
            <button class="btn btn-ghost" onclick="State.set({screen:'app',activeNav:'tools'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
            <div id="quizContainer"></div>
        </div>
    </div>`;
}

function initQuiz() {
    quizState = { screen: 'start', qIndex: 0, answer: null, scores: {} };
    renderQuiz();
}

function renderQuiz() {
    const container = document.getElementById('quizContainer');
    if (!container) return;
    
    if (quizState.screen === 'start') {
        container.innerHTML = `
            <div class="card fade-up" style="text-align:center;padding:var(--space-2xl)">
                <div style="font-size:4rem;margin-bottom:var(--space-lg)">üå±</div>
                <h2 style="font-size:2rem;margin-bottom:var(--space-md)">Discover Your Season</h2>
                <p style="color:var(--text-secondary);margin-bottom:var(--space-xl)">Which biblical character's journey mirrors yours?</p>
                <button class="btn btn-primary btn-lg" onclick="startQuiz()">Begin</button>
            </div>`;
    } else if (quizState.screen === 'quiz') {
        const q = QUESTIONS[quizState.qIndex];
        container.innerHTML = `
            <div class="card fade-up">
                <div style="display:flex;justify-content:space-between;color:var(--text-tertiary);margin-bottom:var(--space-md)">
                    <span>Question ${quizState.qIndex + 1}/${QUESTIONS.length}</span>
                    <span>${Math.round((quizState.qIndex / QUESTIONS.length) * 100)}%</span>
                </div>
                <div style="height:6px;background:var(--border-color);border-radius:3px;margin-bottom:var(--space-xl)">
                    <div style="height:100%;width:${(quizState.qIndex / QUESTIONS.length) * 100}%;background:var(--root-green);border-radius:3px"></div>
                </div>
                <h3 style="margin-bottom:var(--space-xl)">${q.q}</h3>
                <div style="display:flex;flex-direction:column;gap:var(--space-md)">
                    ${q.a.map((a, i) => `
                        <button class="btn btn-secondary ${quizState.answer === i ? 'btn-primary' : ''}" style="justify-content:flex-start;text-align:left;padding:var(--space-lg)" onclick="selectAnswer(${i})">${a.text}</button>
                    `).join('')}
                </div>
                <button class="btn btn-primary btn-lg btn-block" style="margin-top:var(--space-xl)" onclick="nextQuestion()" ${quizState.answer === null ? 'disabled' : ''}>${quizState.qIndex === QUESTIONS.length - 1 ? 'See Results' : 'Next'}</button>
            </div>`;
    } else if (quizState.screen === 'result') {
        const sorted = Object.entries(quizState.scores).sort((a, b) => b[1] - a[1]);
        const topId = sorted[0][0];
        const char = CHARACTERS[topId];
        container.innerHTML = `
            <div class="card fade-up" style="text-align:center;padding:var(--space-2xl)">
                <div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,${char.color},${char.color}aa);display:flex;align-items:center;justify-content:center;font-size:3rem;margin:0 auto var(--space-lg)">${char.icon}</div>
                <p style="color:var(--root-green);text-transform:uppercase;letter-spacing:2px;font-size:0.85rem">Your Season</p>
                <h2 style="font-size:2rem;margin-bottom:var(--space-xs)">${char.name}</h2>
                <p style="color:var(--leaf-green);margin-bottom:var(--space-lg)">${char.title}</p>
                <p style="color:var(--text-secondary);margin-bottom:var(--space-xl)">${char.description}</p>
                <div style="display:flex;gap:var(--space-md);justify-content:center;flex-wrap:wrap">
                    <button class="btn btn-secondary" onclick="initQuiz()">Retake Quiz</button>
                    <button class="btn btn-primary" onclick="State.set({screen:'app',activeNav:'tools'})">Done</button>
                </div>
            </div>`;
    }
}

function startQuiz() {
    quizState.screen = 'quiz';
    renderQuiz();
}

function selectAnswer(i) {
    quizState.answer = i;
    renderQuiz();
}

function nextQuestion() {
    if (quizState.answer === null) return;
    const chars = QUESTIONS[quizState.qIndex].a[quizState.answer].chars;
    Object.entries(chars).forEach(([c, s]) => {
        quizState.scores[c] = (quizState.scores[c] || 0) + s;
    });
    
    if (quizState.qIndex < QUESTIONS.length - 1) {
        quizState.qIndex++;
        quizState.answer = null;
        renderQuiz();
    } else {
        quizState.screen = 'result';
        renderQuiz();
    }
}

// ========== INIT ==========
document.body.dataset.theme = localStorage.getItem('rooted_theme') || 'dark';
DB.init();
State.subscribe(render);
initRouter();

</script>
</body>
</html>
