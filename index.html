<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Rooted ‚Äî Grow Where You're Planted</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,500;9..144,600;9..144,700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
/* ========== CSS RESET & VARIABLES ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --root-green: #2d5a47; --root-green-light: #3d7a5f; --root-green-dark: #1e3d30;
    --leaf-green: #7cb083; --leaf-light: #a8d4af;
    --earth-brown: #8b7355; --earth-light: #c4a77d;
    --cream: #faf8f5; --cream-dark: #f0ebe3;
    --slate-900: #1a1a2e; --slate-800: #252538; --slate-700: #3d3d56;
    --slate-600: #5a5a78; --slate-500: #7a7a96; --slate-400: #9e9eb8;
    --slate-300: #c4c4d4; --slate-200: #e2e2ec; --slate-100: #f4f4f8;
    --success: #22c55e; --warning: #f59e0b; --error: #ef4444; --info: #3b82f6;
    --font-display: 'Fraunces', Georgia, serif;
    --font-body: 'DM Sans', -apple-system, sans-serif;
    --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px;
    --space-xl: 32px; --space-2xl: 48px; --space-3xl: 64px;
    --sidebar-width: 280px; --header-height: 64px; --max-content: 1200px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
    --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
    --transition: 0.2s ease;
}

[data-theme="dark"] {
    --bg-primary: var(--slate-900); --bg-secondary: var(--slate-800); --bg-tertiary: var(--slate-700);
    --text-primary: var(--cream); --text-secondary: var(--slate-300); --text-tertiary: var(--slate-400);
    --border-color: rgba(255,255,255,0.1); --card-bg: rgba(255,255,255,0.05); --hover-bg: rgba(255,255,255,0.08);
}
[data-theme="light"] {
    --bg-primary: var(--cream); --bg-secondary: white; --bg-tertiary: var(--cream-dark);
    --text-primary: var(--slate-900); --text-secondary: var(--slate-600); --text-tertiary: var(--slate-500);
    --border-color: rgba(0,0,0,0.08); --card-bg: white; --hover-bg: rgba(0,0,0,0.03);
}

html { font-size: 16px; scroll-behavior: smooth; }
body { font-family: var(--font-body); background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; overflow-x: hidden; }
h1, h2, h3, h4 { font-family: var(--font-display); font-weight: 500; line-height: 1.3; }
a { color: inherit; text-decoration: none; }
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; }

/* Animations */
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
@keyframes spin { to { transform: rotate(360deg); } }
.fade-up { animation: fadeUp 0.4s ease; }
.fade-in { animation: fadeIn 0.3s ease; }

/* Layout */
#app { display: flex; min-height: 100vh; }
.sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; transition: transform 0.3s ease; }
.sidebar-header { padding: var(--space-lg); border-bottom: 1px solid var(--border-color); }
.sidebar-logo { display: flex; align-items: center; gap: var(--space-md); }
.sidebar-logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--root-green), var(--leaf-green)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
.sidebar-logo-text { font-family: var(--font-display); font-size: 1.5rem; font-weight: 600; }
.sidebar-nav { flex: 1; padding: var(--space-md); overflow-y: auto; }
.nav-section { margin-bottom: var(--space-lg); }
.nav-section-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-tertiary); padding: var(--space-sm) var(--space-md); }
.nav-item { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-md); color: var(--text-secondary); transition: all var(--transition); cursor: pointer; font-size: 0.95rem; }
.nav-item:hover { background: var(--hover-bg); color: var(--text-primary); }
.nav-item.active { background: linear-gradient(135deg, var(--root-green), var(--root-green-light)); color: white; }
.nav-item-icon { width: 20px; text-align: center; }
.sidebar-footer { padding: var(--space-md); border-top: 1px solid var(--border-color); }
.user-menu { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-md); cursor: pointer; }
.user-menu:hover { background: var(--hover-bg); }
.user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--root-green), var(--leaf-green)); display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; overflow: hidden; }
.user-avatar img { width: 100%; height: 100%; object-fit: cover; }
.user-info { flex: 1; min-width: 0; }
.user-name { font-weight: 500; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-email { font-size: 0.75rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.main-content { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; }
.main-header { height: var(--header-height); background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 var(--space-xl); position: sticky; top: 0; z-index: 50; }
.header-left { display: flex; align-items: center; gap: var(--space-lg); }
.menu-toggle { display: none; width: 40px; height: 40px; align-items: center; justify-content: center; border-radius: var(--radius-md); color: var(--text-secondary); font-size: 1.25rem; }
.page-title { font-family: var(--font-display); font-size: 1.25rem; }
.header-right { display: flex; align-items: center; gap: var(--space-md); }
.header-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-md); color: var(--text-secondary); transition: all var(--transition); }
.header-btn:hover { background: var(--hover-bg); color: var(--text-primary); }
.main-body { flex: 1; padding: var(--space-xl); max-width: var(--max-content); width: 100%; margin: 0 auto; }

/* Components */
.card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-lg); }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); font-weight: 500; font-size: 0.95rem; transition: all var(--transition); }
.btn-primary { background: linear-gradient(135deg, var(--root-green), var(--root-green-light)); color: white; }
.btn-primary:hover { box-shadow: 0 4px 20px rgba(45, 90, 71, 0.4); transform: translateY(-1px); }
.btn-secondary { background: var(--hover-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
.btn-secondary:hover { border-color: var(--root-green); }
.btn-ghost { color: var(--text-secondary); }
.btn-ghost:hover { background: var(--hover-bg); color: var(--text-primary); }
.btn-google { background: white; color: #333; border: 1px solid #ddd; }
.btn-google:hover { background: #f5f5f5; box-shadow: var(--shadow-md); }
.btn-sm { padding: var(--space-sm) var(--space-md); font-size: 0.85rem; }
.btn-lg { padding: var(--space-lg) var(--space-xl); font-size: 1.05rem; }
.btn-block { width: 100%; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

.input-group { margin-bottom: var(--space-lg); }
.input-label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); margin-bottom: var(--space-sm); }
.input-field { width: 100%; padding: var(--space-md); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary); font-size: 1rem; transition: all var(--transition); }
.input-field:focus { outline: none; border-color: var(--root-green); box-shadow: 0 0 0 3px rgba(45, 90, 71, 0.15); }
.input-field::placeholder { color: var(--text-tertiary); }
.input-error { border-color: var(--error); }
.error-text { color: var(--error); font-size: 0.85rem; margin-top: var(--space-xs); }

/* Auth Screens */
.auth-container { min-height: 100vh; display: flex; }
.auth-left { flex: 1; background: linear-gradient(135deg, var(--root-green), var(--root-green-dark)); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: var(--space-3xl); color: white; position: relative; overflow: hidden; }
.auth-left::before { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); }
.auth-brand { text-align: center; position: relative; z-index: 1; }
.auth-logo { font-size: 5rem; margin-bottom: var(--space-lg); }
.auth-brand-name { font-family: var(--font-display); font-size: 3.5rem; font-weight: 600; margin-bottom: var(--space-md); }
.auth-tagline { font-size: 1.25rem; opacity: 0.9; }
.auth-right { flex: 1; display: flex; align-items: center; justify-content: center; padding: var(--space-2xl); background: var(--bg-primary); }
.auth-form-container { width: 100%; max-width: 420px; }
.auth-form-title { font-size: 2rem; margin-bottom: var(--space-sm); text-align: center; }
.auth-form-subtitle { color: var(--text-secondary); text-align: center; margin-bottom: var(--space-xl); }
.auth-divider { display: flex; align-items: center; gap: var(--space-md); margin: var(--space-xl) 0; color: var(--text-tertiary); font-size: 0.85rem; }
.auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }
.auth-footer { text-align: center; margin-top: var(--space-xl); color: var(--text-secondary); font-size: 0.9rem; }
.auth-footer a { color: var(--root-green); font-weight: 500; }
.auth-footer a:hover { text-decoration: underline; }

/* Tool Cards */
.tool-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-xl); padding: var(--space-xl); cursor: pointer; transition: all var(--transition); position: relative; overflow: hidden; }
.tool-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--root-green), var(--leaf-green)); opacity: 0; transition: opacity var(--transition); }
.tool-card:hover { border-color: var(--root-green); box-shadow: var(--shadow-lg); transform: translateY(-4px); }
.tool-card:hover::before { opacity: 1; }
.tool-card.coming-soon { opacity: 0.6; cursor: not-allowed; }
.tool-card.coming-soon:hover { transform: none; box-shadow: none; border-color: var(--border-color); }
.tool-icon { width: 56px; height: 56px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; margin-bottom: var(--space-lg); }
.tool-title { font-family: var(--font-display); font-size: 1.15rem; margin-bottom: var(--space-sm); }
.tool-description { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: var(--space-lg); }
.tool-meta { display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap; }
.tool-tag { padding: var(--space-xs) var(--space-sm); background: var(--hover-bg); border-radius: var(--radius-sm); font-size: 0.75rem; color: var(--text-secondary); }

/* Grids */
.grid { display: grid; gap: var(--space-lg); }
.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

/* Stats */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--space-lg); }
.stat-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-lg); }
.stat-label { font-size: 0.8rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-sm); }
.stat-value { font-family: var(--font-display); font-size: 2rem; font-weight: 600; }

/* Welcome Banner */
.welcome-banner { background: linear-gradient(135deg, var(--root-green), var(--root-green-dark)); border-radius: var(--radius-xl); padding: var(--space-2xl); color: white; margin-bottom: var(--space-xl); position: relative; overflow: hidden; }
.welcome-banner::after { content: 'üå±'; position: absolute; right: var(--space-2xl); bottom: -20px; font-size: 8rem; opacity: 0.15; }
.welcome-title { font-size: 1.75rem; margin-bottom: var(--space-sm); }
.welcome-subtitle { opacity: 0.9; max-width: 500px; }

/* Section Headers */
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); }
.section-title { font-family: var(--font-display); font-size: 1.25rem; }

/* Empty State */
.empty-state { text-align: center; padding: var(--space-3xl); }
.empty-state-icon { font-size: 4rem; margin-bottom: var(--space-lg); }
.empty-state-title { font-size: 1.5rem; margin-bottom: var(--space-md); }
.empty-state-description { color: var(--text-secondary); max-width: 400px; margin: 0 auto; }

/* Toast */
.toast-container { position: fixed; bottom: var(--space-lg); right: var(--space-lg); z-index: 2000; }
.toast { background: var(--slate-800); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); margin-top: var(--space-sm); animation: fadeUp 0.3s ease; display: flex; align-items: center; gap: var(--space-sm); }
.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--error); }
.toast.info { border-left: 4px solid var(--info); }

/* Loading */
.loading-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: var(--space-lg); }
.loading-spinner { width: 48px; height: 48px; border: 3px solid var(--border-color); border-top-color: var(--root-green); border-radius: 50%; animation: spin 1s linear infinite; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg); }
.modal { background: var(--bg-secondary); border-radius: var(--radius-xl); max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: fadeUp 0.3s ease; }
.modal-header { padding: var(--space-lg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
.modal-title { font-family: var(--font-display); font-size: 1.25rem; }
.modal-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); color: var(--text-tertiary); }
.modal-close:hover { background: var(--hover-bg); }
.modal-body { padding: var(--space-lg); }
.modal-footer { padding: var(--space-lg); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: var(--space-md); }

/* Coming Soon Badge */
.coming-soon-badge { display: inline-flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); background: linear-gradient(135deg, var(--warning), #fbbf24); color: #333; border-radius: var(--radius-md); font-size: 0.8rem; font-weight: 600; }

/* Sidebar Overlay (mobile) */
.sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
.sidebar-overlay.show { display: block; }

/* Responsive */
@media (max-width: 1024px) {
    .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .auth-left { display: none; }
}
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); width: 85%; max-width: 320px; }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .menu-toggle { display: flex; }
    .main-body { padding: var(--space-md); }
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    .welcome-banner { padding: var(--space-lg); }
    .welcome-banner::after { display: none; }
}
    </style>
</head>
<body data-theme="dark">
    <div id="app"></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
    <div class="toast-container" id="toastContainer"></div>
    <div id="modalContainer"></div>

<script>
// ========== FIREBASE CONFIGURATION ==========
// IMPORTANT: Replace with your own Firebase config from console.firebase.google.com
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
let firebaseInitialized = false;
let auth = null;
let db = null;

function initFirebase() {
    try {
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.warn("Firebase not configured - running in local mode");
            return false;
        }
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        firebaseInitialized = true;
        return true;
    } catch (e) {
        console.error("Firebase init error:", e);
        return false;
    }
}

// ========== AUTH SERVICE ==========
const Auth = {
    currentUser: null,
    
    async init() {
        if (!firebaseInitialized) {
            // Local mode - check localStorage
            const localUser = localStorage.getItem('rooted_user');
            if (localUser) {
                this.currentUser = JSON.parse(localUser);
                return this.currentUser;
            }
            return null;
        }
        
        return new Promise((resolve) => {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    this.currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email?.split('@')[0] || 'User',
                        photoURL: user.photoURL,
                        provider: user.providerData[0]?.providerId || 'email'
                    };
                    // Ensure user document exists
                    await UserDB.ensureUserDoc(this.currentUser);
                    localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
                } else {
                    this.currentUser = null;
                    localStorage.removeItem('rooted_user');
                }
                resolve(this.currentUser);
            });
        });
    },
    
    async signUpWithEmail(email, password, name) {
        if (!firebaseInitialized) {
            // Local mode
            const user = { uid: 'local_' + Date.now(), email, name, photoURL: null, provider: 'local' };
            this.currentUser = user;
            localStorage.setItem('rooted_user', JSON.stringify(user));
            await UserDB.ensureUserDoc(user);
            return user;
        }
        
        const result = await auth.createUserWithEmailAndPassword(email, password);
        await result.user.updateProfile({ displayName: name });
        this.currentUser = {
            uid: result.user.uid,
            email: result.user.email,
            name: name,
            photoURL: null,
            provider: 'email'
        };
        await UserDB.ensureUserDoc(this.currentUser);
        localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
        return this.currentUser;
    },
    
    async signInWithEmail(email, password) {
        if (!firebaseInitialized) {
            // Local mode - check local storage for existing user
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            if (users[email] && users[email].password === password) {
                this.currentUser = users[email].user;
                localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
                return this.currentUser;
            }
            throw new Error('Invalid email or password');
        }
        
        const result = await auth.signInWithEmailAndPassword(email, password);
        this.currentUser = {
            uid: result.user.uid,
            email: result.user.email,
            name: result.user.displayName || result.user.email?.split('@')[0],
            photoURL: result.user.photoURL,
            provider: 'email'
        };
        localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
        return this.currentUser;
    },
    
    async signInWithGoogle() {
        if (!firebaseInitialized) {
            toast('Google Sign-In requires Firebase configuration', 'error');
            throw new Error('Firebase not configured');
        }
        
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        const result = await auth.signInWithPopup(provider);
        this.currentUser = {
            uid: result.user.uid,
            email: result.user.email,
            name: result.user.displayName,
            photoURL: result.user.photoURL,
            provider: 'google.com'
        };
        await UserDB.ensureUserDoc(this.currentUser);
        localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
        return this.currentUser;
    },
    
    async signOut() {
        if (firebaseInitialized) {
            await auth.signOut();
        }
        this.currentUser = null;
        localStorage.removeItem('rooted_user');
        localStorage.removeItem('rooted_nav');
    },
    
    async resetPassword(email) {
        if (!firebaseInitialized) {
            toast('Password reset requires Firebase configuration', 'error');
            throw new Error('Firebase not configured');
        }
        await auth.sendPasswordResetEmail(email);
    },
    
    async updateProfile(updates) {
        if (firebaseInitialized && auth.currentUser) {
            await auth.currentUser.updateProfile(updates);
        }
        Object.assign(this.currentUser, updates);
        localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
        await UserDB.updateUser(this.currentUser.uid, updates);
    }
};

// ========== USER DATABASE ==========
const UserDB = {
    async ensureUserDoc(user) {
        if (!firebaseInitialized) {
            // Local storage mode
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            if (!users[user.email]) {
                users[user.email] = {
                    user: user,
                    profile: { name: user.name, email: user.email, createdAt: new Date().toISOString() },
                    toolProgress: {},
                    quizResults: {},
                    settings: {}
                };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        const docRef = db.collection('users').doc(user.uid);
        const doc = await docRef.get();
        if (!doc.exists) {
            await docRef.set({
                profile: {
                    name: user.name,
                    email: user.email,
                    photoURL: user.photoURL,
                    provider: user.provider,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                toolProgress: {},
                quizResults: {},
                settings: {}
            });
        }
    },
    
    async getUserData(uid) {
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const user = Object.values(users).find(u => u.user.uid === uid);
            return user || null;
        }
        
        const doc = await db.collection('users').doc(uid).get();
        return doc.exists ? doc.data() : null;
    },
    
    async updateUser(uid, updates) {
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const userKey = Object.keys(users).find(k => users[k].user.uid === uid);
            if (userKey) {
                users[userKey] = { ...users[userKey], ...updates };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        await db.collection('users').doc(uid).update(updates);
    },
    
    async saveToolProgress(uid, toolId, progress) {
        const key = `toolProgress.${toolId}`;
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const userKey = Object.keys(users).find(k => users[k].user.uid === uid);
            if (userKey) {
                if (!users[userKey].toolProgress) users[userKey].toolProgress = {};
                users[userKey].toolProgress[toolId] = { ...progress, updatedAt: new Date().toISOString() };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        await db.collection('users').doc(uid).update({
            [key]: { ...progress, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        });
    },
    
    async getToolProgress(uid, toolId) {
        const data = await this.getUserData(uid);
        return data?.toolProgress?.[toolId] || null;
    },
    
    async getAllToolProgress(uid) {
        const data = await this.getUserData(uid);
        return data?.toolProgress || {};
    },
    
    async saveQuizResult(uid, quizId, result) {
        const key = `quizResults.${quizId}`;
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const userKey = Object.keys(users).find(k => users[k].user.uid === uid);
            if (userKey) {
                if (!users[userKey].quizResults) users[userKey].quizResults = {};
                users[userKey].quizResults[quizId] = { ...result, completedAt: new Date().toISOString() };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        await db.collection('users').doc(uid).update({
            [key]: { ...result, completedAt: firebase.firestore.FieldValue.serverTimestamp() }
        });
    },
    
    async saveSettings(uid, settings) {
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const userKey = Object.keys(users).find(k => users[k].user.uid === uid);
            if (userKey) {
                users[userKey].settings = { ...users[userKey].settings, ...settings };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        await db.collection('users').doc(uid).update({ settings });
    }
};

// ========== TOOLS REGISTRY ==========
const TOOLS_BASE_PATH = './tools/';

const TOOLS = {
    seasons: { id: 'seasons', name: 'Discover Your Season', description: 'Find which biblical character\'s journey mirrors your current spiritual season.', icon: 'üå±', color: 'linear-gradient(135deg, #2d5a47, #7cb083)', category: 'assessment', duration: '5 min', status: 'active', type: 'internal' },
    formation: { id: 'formation', name: 'Spiritual Formation Dashboard', description: 'A comprehensive 100-question assessment across 25 categories to evaluate your spiritual growth journey.', icon: 'üìä', color: 'linear-gradient(135deg, #f59e0b, #fbbf24)', category: 'assessment', duration: '20 min', status: 'active', type: 'external', path: 'spiritual-formation.html' },
    gifts: { id: 'gifts', name: 'Spiritual Gifts Assessment', description: 'Discover your unique spiritual gifts and how God has equipped you to serve.', icon: 'üéÅ', color: 'linear-gradient(135deg, #7c3aed, #a78bfa)', category: 'assessment', duration: '15 min', status: 'active', type: 'external', path: 'spiritual-gifts.html' },
    bible_reading: { id: 'bible_reading', name: 'Bible Reading Plans', description: 'Structured reading plans to journey through Scripture.', icon: 'üìñ', color: 'linear-gradient(135deg, #dc2626, #f87171)', category: 'bible', duration: 'Daily', status: 'active', type: 'external', path: 'bible-reading.html' },
    verse_memory: { id: 'verse_memory', name: 'Scripture Memory', description: 'Memorize key verses with flashcards and spaced repetition.', icon: 'üß†', color: 'linear-gradient(135deg, #8b5cf6, #a78bfa)', category: 'bible', duration: '5 min/day', status: 'active', type: 'external', path: 'scripture-memory.html' },
    bible_study: { id: 'bible_study', name: 'Inductive Bible Study', description: 'Learn the Observation-Interpretation-Application method.', icon: 'üîç', color: 'linear-gradient(135deg, #0891b2, #22d3ee)', category: 'bible', duration: '30 min', status: 'active', type: 'external', path: 'inductive-study.html' },
    prayer: { id: 'prayer', name: 'Prayer Journal', description: 'Track prayers using ACTS method. Record answers!', icon: 'üôè', color: 'linear-gradient(135deg, #ec4899, #f472b6)', category: 'devotional', duration: 'Daily', status: 'active', type: 'external', path: 'prayer-journal.html' },
    lectio: { id: 'lectio', name: 'Lectio Divina', description: 'Ancient practice of divine reading: Read, Reflect, Respond, Rest.', icon: '‚ú®', color: 'linear-gradient(135deg, #6366f1, #818cf8)', category: 'devotional', duration: '15 min', status: 'active', type: 'external', path: 'lectio-divina.html' },
    psalms: { id: 'psalms', name: 'Praying the Psalms', description: 'Use the Psalms as your prayer guide.', icon: 'üéµ', color: 'linear-gradient(135deg, #f59e0b, #fbbf24)', category: 'devotional', duration: '10 min', status: 'active', type: 'external', path: 'praying-psalms.html' },
    theology: { id: 'theology', name: 'Core Doctrines', description: 'Learn essential Christian beliefs.', icon: '‚õ™', color: 'linear-gradient(135deg, #475569, #64748b)', category: 'discipleship', duration: '8 weeks', status: 'active', type: 'external', path: 'core-doctrines.html' },
    growth: { id: 'growth', name: 'New Believer Track', description: 'Foundation course for new believers.', icon: 'üåü', color: 'linear-gradient(135deg, #d97706, #fbbf24)', category: 'discipleship', duration: '6 weeks', status: 'active', type: 'external', path: 'new-believer.html' },
    fruit: { id: 'fruit', name: 'Fruit of the Spirit', description: 'Growth plan for Galatians 5:22-23.', icon: 'üçá', color: 'linear-gradient(135deg, #84cc16, #a3e635)', category: 'discipleship', duration: '9 weeks', status: 'active', type: 'external', path: 'fruit-spirit.html' },
    armor: { id: 'armor', name: 'Armor of God', description: 'Ephesians 6:10-18 study.', icon: 'üõ°Ô∏è', color: 'linear-gradient(135deg, #78716c, #a8a29e)', category: 'discipleship', duration: '7 days', status: 'active', type: 'external', path: 'armor-god.html' },
    community: { id: 'community', name: 'Small Groups', description: 'Connect with others for study and accountability.', icon: 'üë•', color: 'linear-gradient(135deg, #14b8a6, #2dd4bf)', category: 'community', duration: 'Weekly', status: 'active', type: 'external', path: 'small-groups.html' },
    testimony: { id: 'testimony', name: 'Share Your Story', description: 'Craft your testimony: Before, How, After.', icon: 'üì£', color: 'linear-gradient(135deg, #ef4444, #f87171)', category: 'community', duration: '30 min', status: 'active', type: 'external', path: 'share-story.html' }
};

// ========== STATE ==========
const State = {
    current: { screen: 'loading', user: null, activeNav: 'dashboard', sidebarOpen: false, accountType: 'user', userChurch: null, signupStep: 1, churchSearchResults: [] },
    listeners: [],
    set(updates) { this.current = { ...this.current, ...updates }; this.notify(); },
    subscribe(fn) { this.listeners.push(fn); },
    notify() { this.listeners.forEach(fn => fn(this.current)); }
};

// ========== CHURCH DATABASE (Beta) ==========
const CHURCH_ADMIN_ACCOUNTS = {
    'admin': { password: '1234', churchId: 'faith-fellowship', churchName: 'Faith Fellowship Church' }
};

const CHURCHES_DB = {
    'faith-fellowship': {
        id: 'faith-fellowship',
        name: 'Faith Fellowship Church',
        address: '123 Main St, Hayward, CA 94541',
        phone: '(510) 555-0123',
        website: 'https://faithfellowship.example.com',
        socialMedia: {
            facebook: 'https://facebook.com/faithfellowship',
            instagram: 'https://instagram.com/faithfellowship',
            youtube: 'https://youtube.com/@faithfellowship'
        },
        announcements: [
            { id: 1, title: 'Wednesday Night Discipleship', date: '2026-01-29', content: 'Join us for our weekly study at 7pm!' },
            { id: 2, title: 'Youth Group Winter Retreat', date: '2026-02-15', content: 'Sign up deadline is Feb 1st. See Pastor Mike for details.' }
        ],
        resources: [
            { id: 1, title: 'Wednesday Discipleship Study - Week 4', type: 'pdf', date: '2026-01-22', url: '#study-week4' },
            { id: 2, title: 'Sunday Sermon Notes - January 19', type: 'pdf', date: '2026-01-19', url: '#sermon-notes' }
        ],
        enabledTools: ['seasons', 'spiritual-formation', 'bible-reading', 'prayer-journal', 'scripture-memory']
    }
};

// Store user church selections
function getUserChurch(userId) {
    const data = JSON.parse(localStorage.getItem('rooted_user_churches') || '{}');
    return data[userId] || null;
}

function setUserChurch(userId, churchId) {
    const data = JSON.parse(localStorage.getItem('rooted_user_churches') || '{}');
    data[userId] = churchId;
    localStorage.setItem('rooted_user_churches', JSON.stringify(data));
}

// Store church data (for admin uploads)
function getChurchData(churchId) {
    const stored = JSON.parse(localStorage.getItem('rooted_church_data') || '{}');
    return { ...CHURCHES_DB[churchId], ...stored[churchId] };
}

function updateChurchData(churchId, updates) {
    const stored = JSON.parse(localStorage.getItem('rooted_church_data') || '{}');
    stored[churchId] = { ...stored[churchId], ...updates };
    localStorage.setItem('rooted_church_data', JSON.stringify(stored));
}

// ========== HELPERS ==========
function toast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<span>${message}</span>`;
    container.appendChild(t);
    setTimeout(() => t.remove(), 4000);
}

function toggleSidebar(open) {
    State.set({ sidebarOpen: open });
    document.getElementById('sidebarOverlay')?.classList.toggle('show', open);
    document.querySelector('.sidebar')?.classList.toggle('open', open);
}

function toggleTheme() {
    const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    document.body.dataset.theme = theme;
    localStorage.setItem('rooted_theme', theme);
}

function navigate(nav) {
    State.set({ activeNav: nav });
    toggleSidebar(false);
}

function showModal(content) {
    document.getElementById('modalContainer').innerHTML = `<div class="modal-overlay" onclick="if(event.target===this)closeModal()">${content}</div>`;
}

function closeModal() {
    document.getElementById('modalContainer').innerHTML = '';
}

// ========== RENDER ==========
function render() {
    const app = document.getElementById('app');
    const { screen, accountType } = State.current;
    
    switch(screen) {
        case 'loading':
            app.innerHTML = `<div class="loading-screen"><div class="loading-spinner"></div><p style="color:var(--text-secondary)">Loading...</p></div>`;
            break;
        case 'welcome':
            app.innerHTML = renderWelcome();
            break;
        case 'login':
            app.innerHTML = renderLogin();
            break;
        case 'church-login':
            app.innerHTML = renderChurchLogin();
            break;
        case 'signup':
            app.innerHTML = renderSignup();
            break;
        case 'signup-church':
            app.innerHTML = renderSignupChurchSelection();
            break;
        case 'forgot-password':
            app.innerHTML = renderForgotPassword();
            break;
        case 'app':
            app.innerHTML = accountType === 'church' ? renderChurchAdminApp() : renderApp();
            break;
        case 'tool-seasons':
            app.innerHTML = renderSeasonsTool();
            setTimeout(initQuiz, 50);
            break;
    }
}

function renderWelcome() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">Rooted</h1>
                <p class="auth-tagline">Grow Where You're Planted</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <h2 class="auth-form-title">Welcome</h2>
                <p class="auth-form-subtitle">Your personal spiritual growth companion</p>
                
                <button class="btn btn-primary btn-lg btn-block" onclick="State.set({screen:'signup'})">
                    Create Account
                </button>
                
                <div class="auth-divider">or</div>
                
                <button class="btn btn-secondary btn-lg btn-block" onclick="State.set({screen:'login'})">
                    Sign In
                </button>
                
                <div style="margin-top:var(--space-2xl);padding:var(--space-lg);background:var(--hover-bg);border-radius:var(--radius-lg);text-align:center">
                    <div style="display:flex;align-items:center;justify-content:center;gap:var(--space-sm);margin-bottom:var(--space-sm)">
                        <span>‚õ™</span>
                        <strong style="font-size:0.9rem">Church Admin?</strong>
                    </div>
                    <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:var(--space-md)">Manage your church's discipleship content and connect with your congregation.</p>
                    <button class="btn btn-ghost" onclick="State.set({screen:'church-login'})" style="font-size:0.9rem">
                        Church Admin Login ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>`;
}

function renderChurchLogin() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">‚õ™</div>
                <h1 class="auth-brand-name">Rooted</h1>
                <p class="auth-tagline">Church Admin Portal</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'welcome'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
                
                <h2 class="auth-form-title">Church Admin Login</h2>
                <p class="auth-form-subtitle">Manage your church's discipleship content</p>
                
                <form onsubmit="handleChurchAdminLogin(event)">
                    <div class="input-group">
                        <label class="input-label">Admin Username</label>
                        <input type="text" class="input-field" id="churchUsername" placeholder="admin" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <input type="password" class="input-field" id="churchPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block" id="churchLoginBtn">Sign In as Admin</button>
                </form>
                
                <div class="auth-footer" style="margin-top:var(--space-xl)">
                    <p style="font-size:0.85rem;color:var(--text-tertiary)">Church accounts are available for premium subscribers. Contact us to set up your church.</p>
                </div>
            </div>
        </div>
    </div>`;
}

function handleChurchAdminLogin(e) {
    e.preventDefault();
    const username = document.getElementById('churchUsername').value;
    const password = document.getElementById('churchPassword').value;
    
    const admin = CHURCH_ADMIN_ACCOUNTS[username];
    if (admin && admin.password === password) {
        const church = getChurchData(admin.churchId);
        State.set({ 
            screen: 'app', 
            accountType: 'church',
            user: { name: church.name, email: 'admin@' + admin.churchId, churchId: admin.churchId },
            activeNav: 'church-dashboard'
        });
        toast('Welcome, ' + church.name + ' Admin! ‚õ™', 'success');
    } else {
        toast('Invalid admin credentials', 'error');
    }
}

function renderLogin() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">Rooted</h1>
                <p class="auth-tagline">Grow Where You're Planted</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'welcome'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
                
                <h2 class="auth-form-title">Welcome Back</h2>
                <p class="auth-form-subtitle">Sign in to continue your journey</p>
                
                <button class="btn btn-google btn-lg btn-block" onclick="handleGoogleSignIn()">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>
                
                <div class="auth-divider">or sign in with email</div>
                
                <form onsubmit="handleEmailSignIn(event)">
                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="loginEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <input type="password" class="input-field" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block" id="loginBtn">Sign In</button>
                </form>
                
                <div class="auth-footer">
                    <a href="#" onclick="State.set({screen:'forgot-password'});return false;">Forgot password?</a>
                    <span style="margin:0 var(--space-sm)">‚Ä¢</span>
                    <a href="#" onclick="State.set({screen:'signup'});return false;">Create account</a>
                </div>
            </div>
        </div>
    </div>`;
}

function renderSignup() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">Rooted</h1>
                <p class="auth-tagline">Grow Where You're Planted</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'welcome'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
                
                <h2 class="auth-form-title">Create Account</h2>
                <p class="auth-form-subtitle">Start your spiritual growth journey</p>
                
                <button class="btn btn-google btn-lg btn-block" onclick="handleGoogleSignIn()">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>
                
                <div class="auth-divider">or sign up with email</div>
                
                <form onsubmit="handleEmailSignUp(event)">
                    <div class="input-group">
                        <label class="input-label">Name</label>
                        <input type="text" class="input-field" id="signupName" placeholder="Your name" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <input type="password" class="input-field" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
                        <p style="font-size:0.8rem;color:var(--text-tertiary);margin-top:var(--space-xs)">At least 6 characters</p>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block" id="signupBtn">Create Account</button>
                </form>
                
                <div class="auth-footer">
                    Already have an account? <a href="#" onclick="State.set({screen:'login'});return false;">Sign in</a>
                </div>
            </div>
        </div>
    </div>`;
}

function renderForgotPassword() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">Rooted</h1>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'login'})" style="margin-bottom:var(--space-lg)">‚Üê Back to Sign In</button>
                
                <h2 class="auth-form-title">Reset Password</h2>
                <p class="auth-form-subtitle">Enter your email and we'll send you a reset link</p>
                
                <form onsubmit="handlePasswordReset(event)">
                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="resetEmail" placeholder="your@email.com" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Send Reset Link</button>
                </form>
            </div>
        </div>
    </div>`;
}

// ========== AUTH HANDLERS ==========
async function handleGoogleSignIn() {
    try {
        await Auth.signInWithGoogle();
        toast('Welcome to Rooted! üå±', 'success');
        State.set({ screen: 'app', user: Auth.currentUser, activeNav: 'dashboard' });
    } catch (e) {
        toast(e.message || 'Google sign-in failed', 'error');
    }
}

async function handleEmailSignIn(e) {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    btn.disabled = true;
    btn.textContent = 'Signing in...';
    
    try {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        await Auth.signInWithEmail(email, password);
        toast('Welcome back! üå±', 'success');
        State.set({ screen: 'app', user: Auth.currentUser, activeNav: 'dashboard' });
    } catch (e) {
        toast(e.message || 'Sign in failed', 'error');
        btn.disabled = false;
        btn.textContent = 'Sign In';
    }
}

async function handleEmailSignUp(e) {
    e.preventDefault();
    const btn = document.getElementById('signupBtn');
    btn.disabled = true;
    btn.textContent = 'Creating account...';
    
    try {
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            if (users[email]) {
                throw new Error('Email already exists');
            }
        }
        
        await Auth.signUpWithEmail(email, password, name);
        
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            users[email].password = password;
            localStorage.setItem('rooted_users', JSON.stringify(users));
        }
        
        toast('Welcome to Rooted! üå±', 'success');
        State.set({ screen: 'app', user: Auth.currentUser, activeNav: 'dashboard' });
    } catch (e) {
        toast(e.message || 'Sign up failed', 'error');
        btn.disabled = false;
        btn.textContent = 'Create Account';
    }
}

async function handlePasswordReset(e) {
    e.preventDefault();
    try {
        const email = document.getElementById('resetEmail').value;
        await Auth.resetPassword(email);
        toast('Password reset email sent!', 'success');
        State.set({ screen: 'login' });
    } catch (e) {
        toast(e.message || 'Failed to send reset email', 'error');
    }
}

async function handleSignOut() {
    await Auth.signOut();
    toast('Signed out', 'info');
    State.set({ screen: 'welcome', user: null, accountType: 'user' });
}

// ========== CHURCH ADMIN PORTAL ==========
function renderChurchAdminApp() {
    const { user, activeNav } = State.current;
    const church = getChurchData(user.churchId);
    
    return `
    <aside class="sidebar ${State.current.sidebarOpen ? 'open' : ''}">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon" style="background:linear-gradient(135deg,#7c3aed,#a78bfa)">‚õ™</div>
                <span class="sidebar-logo-text">Rooted</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Church Admin</div>
                <div class="nav-item ${activeNav === 'church-dashboard' ? 'active' : ''}" onclick="navigate('church-dashboard')">
                    <span class="nav-item-icon">üìä</span> Dashboard
                </div>
                <div class="nav-item ${activeNav === 'church-resources' ? 'active' : ''}" onclick="navigate('church-resources')">
                    <span class="nav-item-icon">üìÑ</span> Resources & PDFs
                </div>
                <div class="nav-item ${activeNav === 'church-announcements' ? 'active' : ''}" onclick="navigate('church-announcements')">
                    <span class="nav-item-icon">üì¢</span> Announcements
                </div>
                <div class="nav-item ${activeNav === 'church-social' ? 'active' : ''}" onclick="navigate('church-social')">
                    <span class="nav-item-icon">üîó</span> Social Media
                </div>
                <div class="nav-item ${activeNav === 'church-tools' ? 'active' : ''}" onclick="navigate('church-tools')">
                    <span class="nav-item-icon">üß∞</span> Enabled Tools
                </div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-menu" onclick="handleSignOut()">
                <div class="user-avatar" style="background:linear-gradient(135deg,#7c3aed,#a78bfa)">‚õ™</div>
                <div class="user-info">
                    <div class="user-name">${church.name}</div>
                    <div class="user-email">Church Admin</div>
                </div>
            </div>
        </div>
    </aside>
    <main class="main-content">
        <header class="main-header">
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleSidebar(true)">‚ò∞</button>
                <h1 class="page-title">${getChurchPageTitle(activeNav)}</h1>
            </div>
            <div class="header-right">
                <span class="coming-soon-badge" style="background:linear-gradient(135deg,#7c3aed,#a78bfa)">Admin Mode</span>
            </div>
        </header>
        <div class="main-body">
            ${renderChurchPage(activeNav)}
        </div>
    </main>`;
}

function getChurchPageTitle(nav) {
    const titles = { 
        'church-dashboard': 'Church Dashboard', 
        'church-resources': 'Resources & PDFs', 
        'church-announcements': 'Announcements',
        'church-social': 'Social Media Links',
        'church-tools': 'Enabled Tools'
    };
    return titles[nav] || 'Dashboard';
}

function renderChurchPage(page) {
    switch(page) {
        case 'church-dashboard': return renderChurchDashboard();
        case 'church-resources': return renderChurchResources();
        case 'church-announcements': return renderChurchAnnouncements();
        case 'church-social': return renderChurchSocial();
        case 'church-tools': return renderChurchTools();
        default: return renderChurchDashboard();
    }
}

function renderChurchDashboard() {
    const church = getChurchData(State.current.user.churchId);
    return `
    <div class="fade-up">
        <div class="welcome-banner" style="background:linear-gradient(135deg,#7c3aed,#a78bfa)">
            <h2 class="welcome-title">‚õ™ ${church.name}</h2>
            <p class="welcome-subtitle">Manage your church's digital discipleship content</p>
        </div>
        
        <div class="stat-grid" style="margin:var(--space-xl) 0">
            <div class="stat-card">
                <div class="stat-label">Resources</div>
                <div class="stat-value">${church.resources?.length || 0}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Announcements</div>
                <div class="stat-value">${church.announcements?.length || 0}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Enabled Tools</div>
                <div class="stat-value">${church.enabledTools?.length || 0}</div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-md)">Quick Actions</h3>
            <div style="display:grid;gap:var(--space-md);grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
                <button class="btn btn-primary" onclick="navigate('church-resources')">üìÑ Upload New Resource</button>
                <button class="btn btn-secondary" onclick="navigate('church-announcements')">üì¢ Post Announcement</button>
                <button class="btn btn-secondary" onclick="navigate('church-social')">üîó Update Social Links</button>
            </div>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:var(--space-md)">Church Information</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-sm)"><strong>Address:</strong> ${church.address}</p>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-sm)"><strong>Phone:</strong> ${church.phone}</p>
            <p style="color:var(--text-secondary)"><strong>Website:</strong> <a href="${church.website}" target="_blank" style="color:var(--root-green)">${church.website}</a></p>
        </div>
    </div>`;
}

function renderChurchResources() {
    const church = getChurchData(State.current.user.churchId);
    return `
    <div class="fade-up">
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-md)">üìÑ Upload New Resource</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">Upload PDF files for your congregation to access (discipleship materials, study guides, sermon notes, etc.)</p>
            
            <form onsubmit="handleResourceUpload(event)">
                <div class="input-group">
                    <label class="input-label">Resource Title</label>
                    <input type="text" class="input-field" id="resourceTitle" placeholder="e.g. Wednesday Night Discipleship - Week 5" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Resource Type</label>
                    <select class="input-field" id="resourceType">
                        <option value="pdf">PDF Document</option>
                        <option value="study">Bible Study Guide</option>
                        <option value="sermon">Sermon Notes</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Upload File (PDF)</label>
                    <input type="file" class="input-field" id="resourceFile" accept=".pdf" style="padding:var(--space-md)">
                    <p style="font-size:0.8rem;color:var(--text-tertiary);margin-top:var(--space-xs)">Max 10MB. PDF files only.</p>
                </div>
                <button type="submit" class="btn btn-primary">Upload Resource</button>
            </form>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:var(--space-lg)">Current Resources</h3>
            ${church.resources?.length ? church.resources.map(r => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-md);background:var(--hover-bg);border-radius:var(--radius-md);margin-bottom:var(--space-sm)">
                    <div>
                        <strong>${r.title}</strong>
                        <p style="font-size:0.85rem;color:var(--text-tertiary)">${r.type.toUpperCase()} ‚Ä¢ Added ${r.date}</p>
                    </div>
                    <button class="btn btn-ghost" style="color:var(--error)" onclick="deleteResource(${r.id})">üóëÔ∏è</button>
                </div>
            `).join('') : '<p style="color:var(--text-tertiary)">No resources uploaded yet.</p>'}
        </div>
    </div>`;
}

function handleResourceUpload(e) {
    e.preventDefault();
    const title = document.getElementById('resourceTitle').value;
    const type = document.getElementById('resourceType').value;
    const file = document.getElementById('resourceFile').files[0];
    
    if (!file) {
        toast('Please select a file to upload', 'error');
        return;
    }
    
    // In a real app, this would upload to cloud storage
    // For demo, we'll store metadata locally
    const church = getChurchData(State.current.user.churchId);
    const resources = church.resources || [];
    resources.push({
        id: Date.now(),
        title,
        type,
        date: new Date().toISOString().split('T')[0],
        url: URL.createObjectURL(file),
        fileName: file.name
    });
    
    updateChurchData(State.current.user.churchId, { resources });
    toast('Resource uploaded successfully! üìÑ', 'success');
    render();
}

function deleteResource(id) {
    const church = getChurchData(State.current.user.churchId);
    const resources = (church.resources || []).filter(r => r.id !== id);
    updateChurchData(State.current.user.churchId, { resources });
    toast('Resource deleted', 'info');
    render();
}

function renderChurchAnnouncements() {
    const church = getChurchData(State.current.user.churchId);
    return `
    <div class="fade-up">
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-md)">üì¢ Post New Announcement</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">Announcements will appear on your members' church feed.</p>
            
            <form onsubmit="handleAnnouncementPost(event)">
                <div class="input-group">
                    <label class="input-label">Title</label>
                    <input type="text" class="input-field" id="announcementTitle" placeholder="e.g. Youth Group Winter Retreat" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Content</label>
                    <textarea class="input-field" id="announcementContent" rows="4" placeholder="Details about the announcement..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Post Announcement</button>
            </form>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:var(--space-lg)">Current Announcements</h3>
            ${church.announcements?.length ? church.announcements.map(a => `
                <div style="padding:var(--space-md);background:var(--hover-bg);border-radius:var(--radius-md);margin-bottom:var(--space-sm)">
                    <div style="display:flex;justify-content:space-between;align-items:start">
                        <div>
                            <strong>${a.title}</strong>
                            <p style="font-size:0.85rem;color:var(--text-tertiary)">${a.date}</p>
                            <p style="margin-top:var(--space-sm);color:var(--text-secondary)">${a.content}</p>
                        </div>
                        <button class="btn btn-ghost" style="color:var(--error)" onclick="deleteAnnouncement(${a.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('') : '<p style="color:var(--text-tertiary)">No announcements posted yet.</p>'}
        </div>
    </div>`;
}

function handleAnnouncementPost(e) {
    e.preventDefault();
    const title = document.getElementById('announcementTitle').value;
    const content = document.getElementById('announcementContent').value;
    
    const church = getChurchData(State.current.user.churchId);
    const announcements = church.announcements || [];
    announcements.unshift({
        id: Date.now(),
        title,
        content,
        date: new Date().toISOString().split('T')[0]
    });
    
    updateChurchData(State.current.user.churchId, { announcements });
    toast('Announcement posted! üì¢', 'success');
    render();
}

function deleteAnnouncement(id) {
    const church = getChurchData(State.current.user.churchId);
    const announcements = (church.announcements || []).filter(a => a.id !== id);
    updateChurchData(State.current.user.churchId, { announcements });
    toast('Announcement deleted', 'info');
    render();
}

function renderChurchSocial() {
    const church = getChurchData(State.current.user.churchId);
    const social = church.socialMedia || {};
    return `
    <div class="fade-up">
        <div class="card">
            <h3 style="margin-bottom:var(--space-md)">üîó Social Media Links</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">These links will be displayed on your members' app for easy access.</p>
            
            <form onsubmit="handleSocialUpdate(event)">
                <div class="input-group">
                    <label class="input-label">üìò Facebook Page</label>
                    <input type="url" class="input-field" id="socialFacebook" placeholder="https://facebook.com/yourchurch" value="${social.facebook || ''}">
                </div>
                <div class="input-group">
                    <label class="input-label">üì∏ Instagram</label>
                    <input type="url" class="input-field" id="socialInstagram" placeholder="https://instagram.com/yourchurch" value="${social.instagram || ''}">
                </div>
                <div class="input-group">
                    <label class="input-label">üé• YouTube Channel</label>
                    <input type="url" class="input-field" id="socialYoutube" placeholder="https://youtube.com/@yourchurch" value="${social.youtube || ''}">
                </div>
                <div class="input-group">
                    <label class="input-label">üåê Church Website</label>
                    <input type="url" class="input-field" id="socialWebsite" placeholder="https://yourchurch.com" value="${church.website || ''}">
                </div>
                <button type="submit" class="btn btn-primary">Save Social Links</button>
            </form>
        </div>
    </div>`;
}

function handleSocialUpdate(e) {
    e.preventDefault();
    const socialMedia = {
        facebook: document.getElementById('socialFacebook').value,
        instagram: document.getElementById('socialInstagram').value,
        youtube: document.getElementById('socialYoutube').value
    };
    const website = document.getElementById('socialWebsite').value;
    
    updateChurchData(State.current.user.churchId, { socialMedia, website });
    toast('Social links updated! üîó', 'success');
}

function renderChurchTools() {
    const church = getChurchData(State.current.user.churchId);
    const enabledTools = church.enabledTools || [];
    
    return `
    <div class="fade-up">
        <div class="card">
            <h3 style="margin-bottom:var(--space-md)">üß∞ Enabled Tools</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">Select which spiritual growth tools your members can access.</p>
            
            <form onsubmit="handleToolsUpdate(event)">
                <div style="display:grid;gap:var(--space-md)">
                    ${Object.entries(TOOLS).map(([id, tool]) => `
                        <label style="display:flex;align-items:center;gap:var(--space-md);padding:var(--space-md);background:var(--hover-bg);border-radius:var(--radius-md);cursor:pointer">
                            <input type="checkbox" id="tool-${id}" ${enabledTools.includes(id) ? 'checked' : ''} style="width:20px;height:20px">
                            <span style="font-size:1.5rem">${tool.icon}</span>
                            <div>
                                <strong>${tool.name}</strong>
                                <p style="font-size:0.85rem;color:var(--text-tertiary)">${tool.desc}</p>
                            </div>
                        </label>
                    `).join('')}
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top:var(--space-lg)">Save Tool Settings</button>
            </form>
        </div>
    </div>`;
}

function handleToolsUpdate(e) {
    e.preventDefault();
    const enabledTools = Object.keys(TOOLS).filter(id => document.getElementById('tool-' + id)?.checked);
    updateChurchData(State.current.user.churchId, { enabledTools });
    toast('Tool settings updated! üß∞', 'success');
}

// ========== MAIN APP ==========
function renderApp() {
    const { user, activeNav } = State.current;
    
    return `
    <aside class="sidebar ${State.current.sidebarOpen ? 'open' : ''}">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üå±</div>
                <span class="sidebar-logo-text">Rooted</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <div class="nav-item ${activeNav === 'dashboard' ? 'active' : ''}" onclick="navigate('dashboard')">
                    <span class="nav-item-icon">üè†</span> Dashboard
                </div>
                <div class="nav-item ${activeNav === 'tools' ? 'active' : ''}" onclick="navigate('tools')">
                    <span class="nav-item-icon">üß∞</span> Growth Tools
                </div>
                <div class="nav-item ${activeNav === 'progress' ? 'active' : ''}" onclick="navigate('progress')">
                    <span class="nav-item-icon">üìà</span> My Progress
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <div class="nav-item ${activeNav === 'profile' ? 'active' : ''}" onclick="navigate('profile')">
                    <span class="nav-item-icon">üë§</span> Profile
                </div>
                <div class="nav-item ${activeNav === 'settings' ? 'active' : ''}" onclick="navigate('settings')">
                    <span class="nav-item-icon">‚öôÔ∏è</span> Settings
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">My Church</div>
                <div class="nav-item ${activeNav === 'my-church' ? 'active' : ''}" onclick="navigate('my-church')">
                    <span class="nav-item-icon">‚õ™</span> Church Feed
                </div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-menu" onclick="showUserMenu()">
                <div class="user-avatar">
                    ${user?.photoURL ? `<img src="${user.photoURL}" alt="">` : (user?.name?.charAt(0) || 'U')}
                </div>
                <div class="user-info">
                    <div class="user-name">${user?.name || 'User'}</div>
                    <div class="user-email">${user?.email || ''}</div>
                </div>
            </div>
        </div>
    </aside>
    <main class="main-content">
        <header class="main-header">
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleSidebar(true)">‚ò∞</button>
                <h1 class="page-title">${getPageTitle(activeNav)}</h1>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="toggleTheme()" title="Toggle theme">
                    ${document.body.dataset.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
                </button>
            </div>
        </header>
        <div class="main-body">
            ${renderPage(activeNav)}
        </div>
    </main>`;
}

function getPageTitle(nav) {
    const titles = { dashboard: 'Dashboard', tools: 'Growth Tools', progress: 'My Progress', profile: 'Profile', settings: 'Settings', 'my-church': 'My Church' };
    return titles[nav] || 'Dashboard';
}

function renderPage(page) {
    switch(page) {
        case 'dashboard': return renderDashboard();
        case 'tools': return renderTools();
        case 'progress': return renderProgress();
        case 'profile': return renderProfile();
        case 'settings': return renderSettings();
        case 'my-church': return renderMyChurch();
        default: return renderDashboard();
    }
}

function showUserMenu() {
    showModal(`
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Account</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center;margin-bottom:var(--space-lg)">
                    <div class="user-avatar" style="width:80px;height:80px;font-size:2rem;margin:0 auto var(--space-md)">
                        ${Auth.currentUser?.photoURL ? `<img src="${Auth.currentUser.photoURL}" alt="">` : (Auth.currentUser?.name?.charAt(0) || 'U')}
                    </div>
                    <h3>${Auth.currentUser?.name || 'User'}</h3>
                    <p style="color:var(--text-secondary)">${Auth.currentUser?.email || ''}</p>
                </div>
                <button class="btn btn-secondary btn-block" onclick="closeModal();navigate('profile')">Edit Profile</button>
                <button class="btn btn-secondary btn-block" onclick="closeModal();navigate('settings')" style="margin-top:var(--space-sm)">Settings</button>
                <hr style="border:none;border-top:1px solid var(--border-color);margin:var(--space-lg) 0">
                <button class="btn btn-ghost btn-block" onclick="closeModal();handleSignOut()" style="color:var(--error)">Sign Out</button>
            </div>
        </div>
    `);
}

function renderDashboard() {
    const user = Auth.currentUser;
    return `
    <div class="fade-up">
        <div class="welcome-banner">
            <h2 class="welcome-title">Welcome${user?.name ? ', ' + user.name.split(' ')[0] : ''}! üå±</h2>
            <p class="welcome-subtitle">Continue growing in your faith journey. Your progress is saved automatically.</p>
        </div>
        <div class="stat-grid" style="margin-bottom:var(--space-2xl)">
            <div class="stat-card">
                <div class="stat-label">Tools Available</div>
                <div class="stat-value">${Object.values(TOOLS).filter(t => t.status === 'active').length}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Coming Soon</div>
                <div class="stat-value">${Object.values(TOOLS).filter(t => t.status === 'coming').length}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Account</div>
                <div class="stat-value" style="font-size:1rem">${user?.provider === 'google.com' ? 'üîó Google' : 'üìß Email'}</div>
            </div>
        </div>
        <div class="section-header">
            <h3 class="section-title">Start Growing</h3>
            <button class="btn btn-ghost btn-sm" onclick="navigate('tools')">View All ‚Üí</button>
        </div>
        <div class="grid grid-2">
            ${Object.values(TOOLS).filter(t => t.status === 'active').slice(0, 2).map(t => renderToolCard(t)).join('')}
        </div>
    </div>`;
}

function renderTools() {
    const tools = Object.values(TOOLS);
    const categories = [...new Set(tools.map(t => t.category))];
    return `
    <div class="fade-up">
        <p style="color:var(--text-secondary);margin-bottom:var(--space-xl)">Discover tools designed to help you grow in your faith.</p>
        ${categories.map(cat => `
            <div class="section-header"><h3 class="section-title" style="text-transform:capitalize">${cat}</h3></div>
            <div class="grid grid-3" style="margin-bottom:var(--space-2xl)">
                ${tools.filter(t => t.category === cat).map(t => renderToolCard(t)).join('')}
            </div>
        `).join('')}
    </div>`;
}

function renderToolCard(tool) {
    const isActive = tool.status === 'active';
    return `
    <div class="tool-card ${!isActive ? 'coming-soon' : ''}" onclick="${isActive ? `openTool('${tool.id}')` : ''}">
        <div class="tool-icon" style="background:${tool.color}">${tool.icon}</div>
        <h4 class="tool-title">${tool.name}</h4>
        <p class="tool-description">${tool.description}</p>
        <div class="tool-meta">
            <span class="tool-tag">${tool.duration}</span>
            ${!isActive ? '<span class="tool-tag">Coming Soon</span>' : ''}
        </div>
    </div>`;
}

function openTool(toolId) {
    const tool = TOOLS[toolId];
    if (!tool) return;
    if (tool.type === 'internal') {
        State.set({ screen: 'tool-seasons' });
    } else if (tool.type === 'external' && tool.path) {
        localStorage.setItem('rooted_nav', 'tools');
        window.open(TOOLS_BASE_PATH + tool.path, '_blank');
    }
}

function renderProgress() {
    return `
    <div class="fade-up">
        <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3 class="empty-state-title">Track Your Growth</h3>
            <p class="empty-state-description">Complete tools and assessments to see your progress here.</p>
            <button class="btn btn-primary" style="margin-top:var(--space-lg)" onclick="navigate('tools')">Start a Tool</button>
        </div>
    </div>`;
}

function renderProfile() {
    const user = Auth.currentUser;
    return `
    <div class="fade-up">
        <div class="card" style="max-width:500px">
            <div style="text-align:center;margin-bottom:var(--space-xl)">
                <div class="user-avatar" style="width:100px;height:100px;font-size:2.5rem;margin:0 auto var(--space-md)">
                    ${user?.photoURL ? `<img src="${user.photoURL}" alt="">` : (user?.name?.charAt(0) || 'U')}
                </div>
                ${user?.provider === 'google.com' ? '<p style="color:var(--text-tertiary);font-size:0.85rem">Connected with Google</p>' : ''}
            </div>
            <div class="input-group">
                <label class="input-label">Name</label>
                <input type="text" class="input-field" id="profileName" value="${user?.name || ''}">
            </div>
            <div class="input-group">
                <label class="input-label">Email</label>
                <input type="email" class="input-field" value="${user?.email || ''}" disabled style="opacity:0.6">
                <p style="font-size:0.8rem;color:var(--text-tertiary);margin-top:var(--space-xs)">Email cannot be changed</p>
            </div>
            <button class="btn btn-primary btn-block" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>`;
}

async function saveProfile() {
    const name = document.getElementById('profileName').value.trim();
    if (!name) { toast('Name is required', 'error'); return; }
    await Auth.updateProfile({ name, displayName: name });
    toast('Profile updated!', 'success');
    render();
}

function renderSettings() {
    const userChurchId = Auth.currentUser ? getUserChurch(Auth.currentUser.uid) : null;
    const userChurch = userChurchId ? getChurchData(userChurchId) : null;
    
    return `
    <div class="fade-up">
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">‚õ™ My Church</h3>
            ${userChurch ? `
                <div style="display:flex;align-items:center;gap:var(--space-md);padding:var(--space-md);background:var(--hover-bg);border-radius:var(--radius-md);margin-bottom:var(--space-md)">
                    <div style="width:50px;height:50px;background:linear-gradient(135deg,var(--root-green),var(--leaf-green));border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.5rem">‚õ™</div>
                    <div>
                        <strong>${userChurch.name}</strong>
                        <p style="font-size:0.85rem;color:var(--text-tertiary)">${userChurch.address}</p>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="showChurchSearch()">Change Church</button>
            ` : `
                <p style="color:var(--text-secondary);margin-bottom:var(--space-md)">Connect with your local church to access discipleship materials, announcements, and more.</p>
                <button class="btn btn-primary" onclick="showChurchSearch()">Find My Church</button>
            `}
        </div>
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">üé® Appearance</h3>
            <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                    <p style="font-weight:500">Theme</p>
                    <p style="font-size:0.85rem;color:var(--text-tertiary)">Choose light or dark mode</p>
                </div>
                <button class="btn btn-secondary" onclick="toggleTheme();render()">
                    ${document.body.dataset.theme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode'}
                </button>
            </div>
        </div>
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">üì¶ Data</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">Your data is ${firebaseInitialized ? 'synced to the cloud' : 'stored locally on this device'}.</p>
            <button class="btn btn-secondary" onclick="exportUserData()">üì• Export My Data</button>
        </div>
        <div class="card" style="border-color:var(--error)">
            <h3 style="margin-bottom:var(--space-md);color:var(--error)">‚ö†Ô∏è Danger Zone</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">Permanently delete your account and all data.</p>
            <button class="btn btn-secondary" style="color:var(--error);border-color:var(--error)" onclick="confirmDeleteAccount()">Delete Account</button>
        </div>
    </div>`;
}

function showChurchSearch() {
    showModal(`
        <div class="modal" onclick="event.stopPropagation()" style="max-width:500px">
            <div class="modal-header">
                <h3 class="modal-title">‚õ™ Find Your Church</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Search by Address or Church Name</label>
                    <input type="text" class="input-field" id="churchSearchInput" placeholder="e.g. Hayward, CA or Faith Fellowship" onkeyup="searchChurches()">
                </div>
                <div id="churchSearchResults" style="margin-top:var(--space-lg);max-height:300px;overflow-y:auto"></div>
            </div>
        </div>
    `);
}

function searchChurches() {
    const query = document.getElementById('churchSearchInput').value.toLowerCase();
    const results = document.getElementById('churchSearchResults');
    
    if (query.length < 2) {
        results.innerHTML = '<p style="color:var(--text-tertiary);text-align:center">Enter at least 2 characters to search...</p>';
        return;
    }
    
    // Search in our church database
    const matches = Object.entries(CHURCHES_DB).filter(([id, church]) => 
        church.name.toLowerCase().includes(query) || 
        church.address.toLowerCase().includes(query)
    );
    
    if (matches.length === 0) {
        results.innerHTML = `
            <div style="text-align:center;padding:var(--space-lg)">
                <p style="color:var(--text-tertiary);margin-bottom:var(--space-md)">No churches found.</p>
                <p style="font-size:0.85rem;color:var(--text-tertiary)">Your church may not be on Rooted yet. Contact us to get your church added!</p>
            </div>`;
        return;
    }
    
    results.innerHTML = matches.map(([id, church]) => `
        <div style="display:flex;align-items:center;gap:var(--space-md);padding:var(--space-md);background:var(--hover-bg);border-radius:var(--radius-md);margin-bottom:var(--space-sm);cursor:pointer" onclick="selectChurch('${id}')">
            <div style="width:50px;height:50px;background:linear-gradient(135deg,var(--root-green),var(--leaf-green));border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0">‚õ™</div>
            <div style="flex:1;min-width:0">
                <strong style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${church.name}</strong>
                <p style="font-size:0.85rem;color:var(--text-tertiary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${church.address}</p>
            </div>
            <span style="color:var(--root-green)">‚Üí</span>
        </div>
    `).join('');
}

function selectChurch(churchId) {
    if (Auth.currentUser) {
        setUserChurch(Auth.currentUser.uid, churchId);
        closeModal();
        toast('Church connected! ‚õ™', 'success');
        render();
    }
}

function renderMyChurch() {
    const userChurchId = Auth.currentUser ? getUserChurch(Auth.currentUser.uid) : null;
    
    if (!userChurchId) {
        return `
        <div class="fade-up">
            <div class="card" style="text-align:center;padding:var(--space-2xl)">
                <div style="font-size:4rem;margin-bottom:var(--space-lg)">‚õ™</div>
                <h2 style="margin-bottom:var(--space-md)">Connect to Your Church</h2>
                <p style="color:var(--text-secondary);margin-bottom:var(--space-xl);max-width:400px;margin-left:auto;margin-right:auto">
                    Link your account to your local church to access discipleship materials, announcements, and stay connected with your congregation.
                </p>
                <button class="btn btn-primary btn-lg" onclick="showChurchSearch()">Find My Church</button>
            </div>
        </div>`;
    }
    
    const church = getChurchData(userChurchId);
    const social = church.socialMedia || {};
    
    return `
    <div class="fade-up">
        <!-- Church Header -->
        <div class="welcome-banner" style="background:linear-gradient(135deg,var(--root-green),var(--leaf-green))">
            <h2 class="welcome-title">‚õ™ ${church.name}</h2>
            <p class="welcome-subtitle">${church.address}</p>
        </div>
        
        <!-- Social Media Links -->
        <div class="card" style="margin:var(--space-lg) 0">
            <h3 style="margin-bottom:var(--space-md)">üîó Connect With Us</h3>
            <div style="display:flex;flex-wrap:wrap;gap:var(--space-sm)">
                ${social.facebook ? `<a href="${social.facebook}" target="_blank" class="btn btn-secondary" style="flex:1;min-width:120px;justify-content:center">üìò Facebook</a>` : ''}
                ${social.instagram ? `<a href="${social.instagram}" target="_blank" class="btn btn-secondary" style="flex:1;min-width:120px;justify-content:center">üì∏ Instagram</a>` : ''}
                ${social.youtube ? `<a href="${social.youtube}" target="_blank" class="btn btn-secondary" style="flex:1;min-width:120px;justify-content:center">üé• YouTube</a>` : ''}
                ${church.website ? `<a href="${church.website}" target="_blank" class="btn btn-secondary" style="flex:1;min-width:120px;justify-content:center">üåê Website</a>` : ''}
            </div>
        </div>
        
        <!-- Announcements -->
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">üì¢ Announcements</h3>
            ${church.announcements?.length ? church.announcements.map(a => `
                <div style="padding:var(--space-md);background:var(--hover-bg);border-radius:var(--radius-md);margin-bottom:var(--space-sm);border-left:4px solid var(--root-green)">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:var(--space-sm)">
                        <strong>${a.title}</strong>
                        <span style="font-size:0.8rem;color:var(--text-tertiary)">${a.date}</span>
                    </div>
                    <p style="color:var(--text-secondary);font-size:0.95rem">${a.content}</p>
                </div>
            `).join('') : '<p style="color:var(--text-tertiary)">No announcements at this time.</p>'}
        </div>
        
        <!-- Resources / Discipleship Materials -->
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">üìÑ Discipleship Resources</h3>
            ${church.resources?.length ? church.resources.map(r => `
                <a href="${r.url}" target="_blank" style="display:flex;align-items:center;gap:var(--space-md);padding:var(--space-md);background:var(--hover-bg);border-radius:var(--radius-md);margin-bottom:var(--space-sm);text-decoration:none;color:inherit">
                    <div style="width:50px;height:50px;background:linear-gradient(135deg,#ef4444,#f97316);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0">üìÑ</div>
                    <div style="flex:1;min-width:0">
                        <strong style="display:block">${r.title}</strong>
                        <p style="font-size:0.85rem;color:var(--text-tertiary)">${r.type.toUpperCase()} ‚Ä¢ ${r.date}</p>
                    </div>
                    <span style="color:var(--root-green)">‚Üì</span>
                </a>
            `).join('') : '<p style="color:var(--text-tertiary)">No resources available yet. Check back soon!</p>'}
        </div>
        
        <!-- Church Info -->
        <div class="card">
            <h3 style="margin-bottom:var(--space-md)">üìç Contact Information</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-sm)"><strong>Address:</strong> ${church.address}</p>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-sm)"><strong>Phone:</strong> ${church.phone}</p>
            ${church.website ? `<p style="color:var(--text-secondary)"><strong>Website:</strong> <a href="${church.website}" target="_blank" style="color:var(--root-green)">${church.website}</a></p>` : ''}
        </div>
    </div>`;
}

async function exportUserData() {
    const data = await UserDB.getUserData(Auth.currentUser.uid);
    const exportData = { profile: Auth.currentUser, data: data, exportedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rooted-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Data exported!', 'success');
}

function confirmDeleteAccount() {
    showModal(`
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" style="color:var(--error)">‚ö†Ô∏è Delete Account</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:var(--space-lg)">Are you sure? This cannot be undone.</p>
                <div class="input-group">
                    <label class="input-label">Type "DELETE" to confirm</label>
                    <input type="text" class="input-field" id="deleteConfirm" placeholder="DELETE">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" style="background:var(--error)" onclick="deleteAccount()">Delete Forever</button>
            </div>
        </div>
    `);
}

async function deleteAccount() {
    if (document.getElementById('deleteConfirm').value !== 'DELETE') {
        toast('Please type DELETE to confirm', 'error');
        return;
    }
    try {
        if (firebaseInitialized) {
            await db.collection('users').doc(Auth.currentUser.uid).delete();
            await auth.currentUser.delete();
        } else {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            delete users[Auth.currentUser.email];
            localStorage.setItem('rooted_users', JSON.stringify(users));
        }
        await Auth.signOut();
        closeModal();
        toast('Account deleted', 'info');
        State.set({ screen: 'welcome', user: null });
    } catch (e) {
        toast(e.message || 'Failed to delete account', 'error');
    }
}

// ========== SEASONS QUIZ ==========
const CHARACTERS = {
    moses: { name: "Moses", title: "The Reluctant Leader", icon: "üî•", color: "#b45309", c: "from-amber-600 to-orange-700", description: "You're called to something bigger than yourself, though you feel inadequate. God is preparing you for leadership.", whyMatch: ["You feel unqualified for what God asks", "You've been in 'wilderness' seasons", "You make excuses about limitations", "You care about justice", "You intercede for others"], scriptures: [{r:"Exodus 3:11",t:"Moses said, 'Who am I that I should go to Pharaoh?'"},{r:"Exodus 4:11-12",t:"The LORD said, 'Who gave humans mouths? Now go; I will help you.'"},{r:"Numbers 12:3",t:"Moses was very humble, more than anyone on earth."},{r:"Hebrews 11:24-27",t:"By faith Moses refused to be called son of Pharaoh's daughter."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"The Hidden Years",p:"Exodus 2:1-15",q:"How is God using your hidden season?"},{d:"Day 2",t:"The Burning Bush",p:"Exodus 3:1-12",q:"Where is God calling you?"},{d:"Day 3",t:"Excuses vs. Obedience",p:"Exodus 4:1-17",q:"What excuses are you making?"},{d:"Day 4",t:"Confronting Fear",p:"Exodus 5:1-9; 6:1-8",q:"What are you afraid to confront?"},{d:"Day 5",t:"The Intercessor",p:"Exodus 32:1-14",q:"Who needs your prayers today?"},{d:"Day 6",t:"God's Presence",p:"Exodus 33:12-23",q:"How do you seek God's presence?"},{d:"Day 7",t:"Finishing Faithful",p:"Deuteronomy 34:1-12",q:"What legacy are you building?"}], memoryVerse:"Exodus 4:12 ‚Äî 'Now go; I will help you speak and teach you what to say.'", keyTruth:"God doesn't call the equipped‚ÄîHe equips the called."} },
    david: { name: "David", title: "The Worshiper's Heart", icon: "üéµ", color: "#7c3aed", c: "from-purple-600 to-indigo-700", description: "Intimacy with God matters more than success. Your heart quickly returns to worship despite failures.", whyMatch: ["Your first response is worship", "You've failed but won't let it define you", "You're emotionally honest with God", "You value intimacy over recognition", "Repentance matters more than perfection"], scriptures: [{r:"Psalm 51:10",t:"Create in me a pure heart, O God."},{r:"1 Samuel 13:14",t:"The LORD sought a man after his own heart."},{r:"Psalm 27:4",t:"One thing I ask: to dwell in the house of the LORD."},{r:"Acts 13:22",t:"I found David, a man after my own heart."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Chosen in Obscurity",p:"1 Samuel 16:1-13",q:"How has God seen you when others didn't?"},{d:"Day 2",t:"Facing Your Giant",p:"1 Samuel 17:32-50",q:"What giant are you facing today?"},{d:"Day 3",t:"Friendship & Loyalty",p:"1 Samuel 18:1-4; 20:1-17",q:"Who is your Jonathan?"},{d:"Day 4",t:"When You Fall",p:"2 Samuel 11:1-17; 12:1-13",q:"Is there hidden sin to confess?"},{d:"Day 5",t:"True Repentance",p:"Psalm 51:1-19",q:"What does genuine repentance look like?"},{d:"Day 6",t:"Undignified Worship",p:"2 Samuel 6:12-22",q:"What holds back your worship?"},{d:"Day 7",t:"A Heart That Returns",p:"Psalm 23:1-6",q:"How quickly do you return to God?"}], memoryVerse:"Psalm 51:10 ‚Äî 'Create in me a pure heart, O God, and renew a steadfast spirit within me.'", keyTruth:"God measures your heart by how quickly you return."} },
    abraham: { name: "Abraham", title: "The Faith Walker", icon: "‚≠ê", color: "#0284c7", c: "from-sky-600 to-blue-700", description: "You're asked to trust God without seeing the full picture. Step out‚Äîno roadmap, just faith.", whyMatch: ["You're in transition or uncertainty", "God asks you to leave comfort", "You hold unfulfilled promises", "You struggle between faith and control", "God's timing differs from yours"], scriptures: [{r:"Hebrews 11:8",t:"By faith Abraham went, not knowing where."},{r:"Genesis 15:6",t:"Abram believed the LORD; it was credited as righteousness."},{r:"Romans 4:20-21",t:"He did not waver but was strengthened in faith."},{r:"Hebrews 11:17-19",t:"By faith Abraham offered Isaac."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"The Call to Go",p:"Genesis 12:1-9",q:"What is God asking you to leave?"},{d:"Day 2",t:"Faith Despite Fear",p:"Genesis 12:10-20; 20:1-18",q:"When has fear compromised your faith?"},{d:"Day 3",t:"Waiting on Promise",p:"Genesis 15:1-6",q:"What promises are you waiting on?"},{d:"Day 4",t:"Helping God Out",p:"Genesis 16:1-16",q:"When have you tried to force God's hand?"},{d:"Day 5",t:"New Identity",p:"Genesis 17:1-8, 15-22",q:"How has God changed your identity?"},{d:"Day 6",t:"The Ultimate Test",p:"Genesis 22:1-14",q:"What is your 'Isaac'?"},{d:"Day 7",t:"Legacy of Faith",p:"Hebrews 11:8-19",q:"What faith legacy will you leave?"}], memoryVerse:"Hebrews 11:8 ‚Äî 'By faith Abraham obeyed and went, even though he did not know where he was going.'", keyTruth:"Faith is knowing Who leads, not where you're going."} },
    esther: { name: "Esther", title: "The Strategic Intercessor", icon: "üëë", color: "#db2777", c: "from-rose-500 to-pink-700", description: "You've been positioned for such a time as this. Use your influence courageously.", whyMatch: ["You sense divine positioning", "You wrestle with speaking up", "You advocate for others unseen", "You have unique influence", "Courage means risking comfort"], scriptures: [{r:"Esther 4:14",t:"Who knows if you came for such a time as this?"},{r:"Esther 4:16",t:"If I perish, I perish."},{r:"Esther 7:3-4",t:"Grant me my life‚Äîspare my people."},{r:"Proverbs 31:8-9",t:"Speak up for those who cannot speak."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Positioned by God",p:"Esther 2:1-18",q:"How has God positioned you?"},{d:"Day 2",t:"Hidden Identity",p:"Esther 2:19-23; 3:1-6",q:"When must identity be revealed?"},{d:"Day 3",t:"The Crisis Moment",p:"Esther 3:7-15; 4:1-8",q:"What crisis needs your voice?"},{d:"Day 4",t:"For Such a Time",p:"Esther 4:9-17",q:"What were you made for?"},{d:"Day 5",t:"Strategic Wisdom",p:"Esther 5:1-14",q:"How do you approach difficult people?"},{d:"Day 6",t:"Speaking Truth",p:"Esther 7:1-10",q:"What truth must you speak?"},{d:"Day 7",t:"Lasting Impact",p:"Esther 8:1-17",q:"How will your courage impact others?"}], memoryVerse:"Esther 4:14 ‚Äî 'Who knows but that you have come to your royal position for such a time as this?'", keyTruth:"You are not where you are by accident."} },
    joseph: { name: "Joseph", title: "The Faithful Sufferer", icon: "üåæ", color: "#059669", c: "from-emerald-600 to-teal-700", description: "Private pain and unseen faithfulness. God builds character in hidden places for future influence.", whyMatch: ["You've experienced betrayal", "You do right but face setbacks", "You maintain unseen integrity", "Your dreams seem impossible", "You're learning God's timing"], scriptures: [{r:"Genesis 50:20",t:"You meant harm; God meant it for good."},{r:"Genesis 39:2-3",t:"The LORD was with Joseph; he prospered."},{r:"Genesis 39:21-23",t:"In prison, the LORD was with him."},{r:"Psalm 105:17-19",t:"Till God's word proved him true."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Dreams from God",p:"Genesis 37:1-11",q:"What dreams has God given you?"},{d:"Day 2",t:"Betrayed by Family",p:"Genesis 37:12-36",q:"How do you handle betrayal?"},{d:"Day 3",t:"Integrity in Temptation",p:"Genesis 39:1-18",q:"Where is integrity being tested?"},{d:"Day 4",t:"Faithful in Prison",p:"Genesis 39:19-23; 40:1-23",q:"Can you serve faithfully when forgotten?"},{d:"Day 5",t:"God's Perfect Timing",p:"Genesis 41:1-40",q:"Are you trusting God's timing?"},{d:"Day 6",t:"Forgiveness & Healing",p:"Genesis 45:1-15",q:"Who do you need to forgive?"},{d:"Day 7",t:"Meant for Good",p:"Genesis 50:15-21",q:"Can you see God's hand in your pain?"}], memoryVerse:"Genesis 50:20 ‚Äî 'You intended to harm me, but God intended it for good.'", keyTruth:"Your pit is preparation, not destination."} },
    deborah: { name: "Deborah", title: "The Spirit-Led Authority", icon: "‚ö°", color: "#eab308", c: "from-yellow-500 to-amber-600", description: "Stepping into leadership with confidence rooted in obedience. Lead boldly.", whyMatch: ["People seek your wisdom", "Your call is rooted in God's authority", "You lead without seeking spotlight", "You speak prophetically", "You lead by going first"], scriptures: [{r:"Judges 4:4-5",t:"Deborah, a prophet, was leading Israel."},{r:"Judges 4:14",t:"Go! The LORD has given Sisera into your hands."},{r:"Judges 5:7",t:"Until I, Deborah, arose, a mother in Israel."},{r:"Joel 2:28-29",t:"Your sons and daughters will prophesy."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Called to Lead",p:"Judges 4:1-5",q:"How has God called you to lead?"},{d:"Day 2",t:"Hearing from God",p:"Judges 4:6-7; 1 Samuel 3:1-10",q:"How do you hear God's voice?"},{d:"Day 3",t:"Empowering Others",p:"Judges 4:8-10",q:"Who are you empowering?"},{d:"Day 4",t:"Going First",p:"Judges 4:14-16",q:"Will you go where you call others?"},{d:"Day 5",t:"Unexpected Heroes",p:"Judges 4:17-24",q:"Who are the unexpected heroes around you?"},{d:"Day 6",t:"Songs of Victory",p:"Judges 5:1-12",q:"When did God last give you victory?"},{d:"Day 7",t:"Lasting Peace",p:"Judges 5:31",q:"What legacy of peace will you leave?"}], memoryVerse:"Judges 4:14 ‚Äî 'Go! This is the day the LORD has given Sisera into your hands.'", keyTruth:"Leadership is discerning God's direction and acting."} },
    peter: { name: "Peter", title: "The Restored Leader", icon: "ü™®", color: "#64748b", c: "from-blue-600 to-cyan-700", description: "Restoration after failure. You've stumbled but Jesus isn't done with you. This is your comeback.", whyMatch: ["You fear failure disqualified you", "You act impulsively", "You're passionate, for better or worse", "Jesus' love isn't performance-based", "You're being rebuilt"], scriptures: [{r:"John 21:15-17",t:"'Do you love me?' 'Yes, Lord.' 'Feed my lambs.'"},{r:"Luke 22:31-32",t:"I have prayed that your faith may not fail."},{r:"Matthew 16:18",t:"On this rock I will build my church."},{r:"Acts 2:14, 41",t:"Peter stood up... 3,000 were added."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Called from Ordinary",p:"Luke 5:1-11",q:"How did Jesus call you?"},{d:"Day 2",t:"Walking on Water",p:"Matthew 14:22-33",q:"When has fear caused you to sink?"},{d:"Day 3",t:"The Great Confession",p:"Matthew 16:13-20",q:"Who do you say Jesus is?"},{d:"Day 4",t:"Pride Before the Fall",p:"Matthew 26:31-35",q:"Where might pride be blinding you?"},{d:"Day 5",t:"The Denial",p:"Luke 22:54-62",q:"Have you experienced a breaking failure?"},{d:"Day 6",t:"Restoration",p:"John 21:15-19",q:"How is Jesus restoring you?"},{d:"Day 7",t:"Filled with Power",p:"Acts 2:1-41",q:"What could God do through you?"}], memoryVerse:"Luke 22:32 ‚Äî 'I have prayed for you, that your faith may not fail.'", keyTruth:"Jesus prayed for you before you fell."} },
    paul: { name: "Paul", title: "The Grace-Driven Missionary", icon: "‚úâÔ∏è", color: "#dc2626", c: "from-red-600 to-rose-700", description: "Radical transformation and mission. Your past doesn't define you‚Äîgrace does. Endurance is your theme.", whyMatch: ["You had a dramatic God-encounter", "Your past was transformed by grace", "You're compelled to share", "Suffering is part of calling", "You're driven by mission"], scriptures: [{r:"1 Corinthians 15:10",t:"By grace I am what I am."},{r:"Philippians 3:7-8",t:"I consider everything loss for Christ."},{r:"2 Corinthians 12:9",t:"My power is made perfect in weakness."},{r:"Acts 20:24",t:"My only aim is to finish the race."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Before Grace",p:"Acts 7:54-8:3; Galatians 1:13-14",q:"What was your life before Christ?"},{d:"Day 2",t:"The Encounter",p:"Acts 9:1-19",q:"How did Jesus interrupt your life?"},{d:"Day 3",t:"New Purpose",p:"Acts 9:20-31; Galatians 1:15-24",q:"How has your purpose changed?"},{d:"Day 4",t:"Suffering for the Gospel",p:"2 Corinthians 11:23-33",q:"What have you suffered for faith?"},{d:"Day 5",t:"Power in Weakness",p:"2 Corinthians 12:1-10",q:"How has weakness shown God's power?"},{d:"Day 6",t:"Pressing On",p:"Philippians 3:7-14",q:"What keeps you going?"},{d:"Day 7",t:"Finishing Well",p:"2 Timothy 4:6-8",q:"How will you finish the race?"}], memoryVerse:"1 Corinthians 15:10 ‚Äî 'By the grace of God I am what I am.'", keyTruth:"Grace disqualifies nothing from your past."} },
    maryMagdalene: { name: "Mary Magdalene", title: "The Devoted Witness", icon: "üåÖ", color: "#ec4899", c: "from-fuchsia-600 to-purple-700", description: "Deep gratitude and unwavering devotion. Freedom made you fiercely faithful.", whyMatch: ["You experienced significant deliverance", "Devotion comes from gratitude", "You stay when others flee", "You're drawn to Jesus always", "You testify what you've seen"], scriptures: [{r:"John 20:18",t:"'I have seen the Lord!'"},{r:"Luke 8:2-3",t:"Mary, from whom seven demons came out."},{r:"John 20:11-16",t:"Jesus said, 'Mary.' She cried, 'Rabboni!'"},{r:"Mark 15:40-41",t:"Women watching from a distance."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Set Free",p:"Luke 8:1-3; Mark 5:1-20",q:"What has Jesus freed you from?"},{d:"Day 2",t:"Following Close",p:"Luke 8:1-3; Matthew 27:55-56",q:"How closely do you follow Jesus?"},{d:"Day 3",t:"At the Cross",p:"John 19:25-27; Mark 15:40-41",q:"Have you stayed when others left?"},{d:"Day 4",t:"In the Darkness",p:"Mark 15:42-47; 16:1",q:"How do you worship in dark times?"},{d:"Day 5",t:"First at the Tomb",p:"John 20:1-10",q:"How eager are you for Jesus?"},{d:"Day 6",t:"He Knows Your Name",p:"John 20:11-16",q:"How does Jesus speak to you personally?"},{d:"Day 7",t:"Go and Tell",p:"John 20:17-18",q:"Who needs to hear your testimony?"}], memoryVerse:"John 20:18 ‚Äî 'I have seen the Lord!'", keyTruth:"Gratitude determines devotion depth."} },
    timothy: { name: "Timothy", title: "The Willing Learner", icon: "üìñ", color: "#84cc16", c: "from-lime-600 to-green-700", description: "Growth through mentorship. You may feel young or insecure‚Äîbut God uses the willing.", whyMatch: ["You're being mentored", "You feel too young or inexperienced", "You're hungry to grow", "You lead while still learning", "Formation happens in relationship"], scriptures: [{r:"1 Timothy 4:12",t:"Don't let anyone look down on you because you're young."},{r:"2 Timothy 1:5-7",t:"The Spirit does not make us timid."},{r:"2 Timothy 2:1-2",t:"Be strong in grace that is in Christ."},{r:"Philippians 2:19-22",t:"No one else shows such genuine concern."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Faith Heritage",p:"2 Timothy 1:3-7; 3:14-15",q:"Who passed faith to you?"},{d:"Day 2",t:"Chosen for More",p:"Acts 16:1-5",q:"How is God calling you forward?"},{d:"Day 3",t:"Don't Despise Youth",p:"1 Timothy 4:11-16",q:"What insecurities hold you back?"},{d:"Day 4",t:"Fan the Flame",p:"2 Timothy 1:6-14",q:"What gift needs to be stirred up?"},{d:"Day 5",t:"Approved Worker",p:"2 Timothy 2:14-26",q:"How are you growing in the Word?"},{d:"Day 6",t:"Endure Hardship",p:"2 Timothy 2:1-13",q:"What hardship is forming you?"},{d:"Day 7",t:"Multiply",p:"2 Timothy 2:2; 4:1-5",q:"Who are you investing in?"}], memoryVerse:"1 Timothy 4:12 ‚Äî 'Don't let anyone look down on you because you are young.'", keyTruth:"Inexperience lets God show His strength."} },
    ruth: { name: "Ruth", title: "The Steadfast Loyal", icon: "üåø", color: "#f97316", c: "from-orange-500 to-red-600", description: "Quiet faithfulness in ordinary circumstances. Steady commitment that honors God.", whyMatch: ["You're committed even when costly", "Faithfulness is unglamorous", "You chose loyalty over convenience", "You serve without recognition", "God sees everyday faithfulness"], scriptures: [{r:"Ruth 1:16-17",t:"Where you go I will go. Your God, my God."},{r:"Ruth 2:11-12",t:"May the LORD repay what you've done."},{r:"Ruth 3:10-11",t:"All know you're a woman of noble character."},{r:"Proverbs 31:10",t:"A noble wife is worth more than rubies."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Loss & Decision",p:"Ruth 1:1-14",q:"How do you respond to loss?"},{d:"Day 2",t:"Radical Loyalty",p:"Ruth 1:15-22",q:"Who has God called you to be loyal to?"},{d:"Day 3",t:"Humble Work",p:"Ruth 2:1-13",q:"How do you serve in 'the fields'?"},{d:"Day 4",t:"Noticed by God",p:"Ruth 2:14-23",q:"Do you trust God sees your faithfulness?"},{d:"Day 5",t:"Bold Faith",p:"Ruth 3:1-13",q:"What bold step of faith is needed?"},{d:"Day 6",t:"Redemption",p:"Ruth 4:1-12",q:"How has God redeemed your story?"},{d:"Day 7",t:"Legacy",p:"Ruth 4:13-22; Matthew 1:5",q:"What legacy is your faithfulness building?"}], memoryVerse:"Ruth 1:16 ‚Äî 'Where you go I will go, and where you stay I will stay.'", keyTruth:"Faithfulness in ordinary is never wasted."} },
    priscilla: { name: "Priscilla", title: "The Quiet Multiplier", icon: "ü§ù", color: "#8b5cf6", c: "from-violet-600 to-purple-700", description: "Investing in others. Your calling isn't spotlight‚Äîit's forming future leaders.", whyMatch: ["You find fulfillment developing others", "You prefer people over platform", "You partner well", "You teach truth clearly", "You invest in those who'll go further"], scriptures: [{r:"Acts 18:26",t:"They explained the way of God more adequately."},{r:"Romans 16:3-5",t:"My co-workers who risked their lives for me."},{r:"1 Corinthians 16:19",t:"The church that meets at their house."},{r:"2 Timothy 4:19",t:"Greet Priscilla and Aquila."}], study: {title:"7-Day Study Challenge", days:[{d:"Day 1",t:"Partnership",p:"Acts 18:1-4",q:"Who do you partner with in faith?"},{d:"Day 2",t:"Working Together",p:"Acts 18:18-21; Romans 16:3-4",q:"How do you serve alongside others?"},{d:"Day 3",t:"Teaching Gently",p:"Acts 18:24-26",q:"Who needs patient teaching from you?"},{d:"Day 4",t:"Home as Ministry",p:"Romans 16:3-5; 1 Cor 16:19",q:"How can your home serve others?"},{d:"Day 5",t:"Risk for the Gospel",p:"Romans 16:3-4",q:"What have you risked for faith?"},{d:"Day 6",t:"Multiplying Leaders",p:"2 Timothy 2:2",q:"Who are you developing?"},{d:"Day 7",t:"Lasting Fruit",p:"John 15:16; 3 John 1:4",q:"What fruit will remain?"}], memoryVerse:"Acts 18:26 ‚Äî 'They explained to him the way of God more adequately.'", keyTruth:"Your legacy is the people you develop."} }
};

const QUESTIONS = [
    {q:"When facing a major decision?",a:[{text:"I feel inadequate",chars:{moses:3,timothy:2,peter:1}},{text:"I pray and worship",chars:{david:3,maryMagdalene:2}},{text:"I step out in faith",chars:{abraham:3,ruth:1}},{text:"I consider others",chars:{esther:3,priscilla:2,joseph:1}},{text:"I push forward boldly",chars:{peter:3,paul:2,deborah:1}}]},
    {q:"Your current season?",a:[{text:"Waiting, wondering",chars:{joseph:3,moses:2}},{text:"Recovering from failure",chars:{peter:3,david:2}},{text:"Learning, growing",chars:{timothy:3,ruth:2}},{text:"Stepping up to lead",chars:{deborah:3,esther:2}},{text:"Serving, pouring out",chars:{paul:3,priscilla:2,maryMagdalene:1}}]},
    {q:"When you make a mistake?",a:[{text:"Honest with God immediately",chars:{david:3,peter:2}},{text:"Hide and process alone",chars:{moses:2,joseph:2,timothy:1}},{text:"Use it as fuel",chars:{paul:3,peter:1}},{text:"Lean on mentors",chars:{timothy:3,priscilla:1}},{text:"Stay committed anyway",chars:{ruth:3,maryMagdalene:2}}]},
    {q:"What motivates your faith?",a:[{text:"Gratitude for what God's done",chars:{maryMagdalene:3,paul:2,david:1}},{text:"Positioned for something big",chars:{esther:3,joseph:2}},{text:"Loyalty and love",chars:{ruth:3,maryMagdalene:2}},{text:"Helping others grow",chars:{priscilla:3,deborah:2}},{text:"Believing unfulfilled promises",chars:{abraham:3,moses:2}}]},
    {q:"How do you feel about leadership?",a:[{text:"Rather not, but will if called",chars:{moses:3,timothy:2}},{text:"Lead through worship",chars:{david:3,maryMagdalene:1}},{text:"Naturally step up",chars:{deborah:3,peter:2}},{text:"Lead behind scenes",chars:{priscilla:3,joseph:2,esther:1}},{text:"Driven by experience",chars:{paul:3,peter:2}}]},
    {q:"When others give up?",a:[{text:"Stay faithful anyway",chars:{maryMagdalene:3,ruth:3,joseph:2}},{text:"Rally people",chars:{deborah:3,paul:2}},{text:"Intercede and pray",chars:{moses:3,esther:2}},{text:"Encourage one-on-one",chars:{priscilla:3,timothy:2}},{text:"Sometimes want to quit too",chars:{peter:3,timothy:2,moses:1}}]},
    {q:"What challenge resonates?",a:[{text:"Feeling unqualified",chars:{moses:3,peter:2,timothy:2}},{text:"Trusting without seeing",chars:{abraham:3,joseph:2}},{text:"Needing courage to speak",chars:{esther:3,deborah:2}},{text:"Faithful in boring stuff",chars:{ruth:3,maryMagdalene:2}},{text:"Running on empty",chars:{paul:3,priscilla:2}}]},
    {q:"How do you experience God?",a:[{text:"Worship and creativity",chars:{david:3,maryMagdalene:2}},{text:"Solitude and waiting",chars:{moses:3,joseph:2,abraham:1}},{text:"Studying and teaching",chars:{priscilla:3,paul:2,timothy:1}},{text:"Bold action",chars:{deborah:3,esther:2,peter:1}},{text:"Everyday faithfulness",chars:{ruth:3,maryMagdalene:2}}]},
    {q:"Your life theme right now?",a:[{text:"Preparation",chars:{moses:3,joseph:3,timothy:2}},{text:"Restoration",chars:{peter:3,david:2}},{text:"Breakthrough",chars:{deborah:3,esther:3}},{text:"Endurance",chars:{paul:3,ruth:2,maryMagdalene:1}},{text:"Investment in others",chars:{priscilla:3,timothy:2}}]},
    {q:"What do you want said about you?",a:[{text:"Never gave up",chars:{ruth:3,maryMagdalene:3,joseph:2}},{text:"Led with courage",chars:{esther:3,deborah:2,moses:1}},{text:"Real but always returned to God",chars:{david:3,peter:2}},{text:"Trusted into the unknown",chars:{abraham:3,moses:2}},{text:"Multiplied leaders",chars:{priscilla:3,paul:2,timothy:1}}]}
];

let quizState = { screen: 'start', qIndex: 0, answer: null, scores: {}, expanded: null };

function renderSeasonsTool() {
    return `<div style="min-height:100vh;background:linear-gradient(135deg,#1e293b,#0f172a,#1e293b)"><div style="max-width:600px;margin:0 auto;padding:20px"><button class="btn btn-ghost" onclick="backToTools()" style="margin-bottom:20px;color:#f59e0b">‚Üê Back to Growth Tools</button><div id="quizContent"></div></div><div id="printArea" style="display:none"></div></div>`;
}

function backToTools() { State.set({ screen: 'app', activeNav: 'tools' }); }

function initQuiz() {
    quizState = { screen: 'start', qIndex: 0, answer: null, scores: {}, expanded: null };
    renderQuiz();
}

function toggleExpand(section) {
    quizState.expanded = quizState.expanded === section ? null : section;
    renderQuiz();
}

function shareQuizApp() {
    if (navigator.share) {
        navigator.share({title:'Discover Your Season Quiz',text:'Find out which biblical character reflects your faith journey!',url:window.location.href});
    } else {
        navigator.clipboard.writeText(window.location.href);
        toast('Link copied! Share it with others.', 'success');
    }
}

function shareQuizStudy() {
    const sorted = Object.entries(quizState.scores).sort((a,b)=>b[1]-a[1]);
    const char = CHARACTERS[sorted[0][0]];
    const text = `My 7-Day Study Challenge: ${char.name} - ${char.title}\n\n${char.study.days.map(d=>`${d.d}: ${d.t}\nRead: ${d.p}\nReflect: ${d.q}`).join('\n\n')}\n\nMemory Verse: ${char.study.memoryVerse}\n\nKey Truth: ${char.study.keyTruth}\n\nFree Bible Tools:\n‚Ä¢ BibleGateway.com\n‚Ä¢ BlueLetter Bible.org\n‚Ä¢ YouVersion.com\n‚Ä¢ BibleHub.com`;
    if (navigator.share) {
        navigator.share({title:`${char.name} - 7-Day Study Challenge`,text:text});
    } else {
        navigator.clipboard.writeText(text);
        toast('Study guide copied!', 'success');
    }
}

function printQuizStudy() {
    const sorted = Object.entries(quizState.scores).sort((a,b)=>b[1]-a[1]);
    const r = CHARACTERS[sorted[0][0]];
    const printArea = document.getElementById('printArea');
    printArea.innerHTML = `<div style="font-family:Georgia,serif;max-width:7.5in;margin:0 auto;padding:0.25in;color:#000;">
<div style="text-align:center;border-bottom:3px solid #000;padding-bottom:12px;margin-bottom:16px;">
<div style="font-size:48px;margin-bottom:8px;">${r.icon}</div>
<h1 style="font-size:28px;font-weight:bold;margin:0;">${r.name}</h1>
<p style="font-size:16px;font-style:italic;margin:4px 0 0 0;">${r.title}</p>
</div>
<div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px;">
<p style="font-size:14px;margin:0;line-height:1.4;"><strong>Your Season:</strong> ${r.description}</p>
</div>
<h2 style="font-size:20px;font-weight:bold;margin:0 0 12px 0;text-align:center;background:#000;color:#fff;padding:8px;">üìñ 7-DAY STUDY CHALLENGE</h2>
<table style="width:100%;border-collapse:collapse;font-size:13px;">
<tr style="background:#333;color:#fff;"><th style="padding:8px;text-align:left;width:15%;">DAY</th><th style="padding:8px;text-align:left;width:25%;">TOPIC</th><th style="padding:8px;text-align:left;width:25%;">READ</th><th style="padding:8px;text-align:left;width:35%;">REFLECT</th></tr>
${r.study.days.map((d,i)=>`<tr style="background:${i%2===0?'#fff':'#f0f0f0'};"><td style="padding:8px;font-weight:bold;">${d.d}</td><td style="padding:8px;">${d.t}</td><td style="padding:8px;font-weight:bold;">${d.p}</td><td style="padding:8px;font-style:italic;">${d.q}</td></tr>`).join('')}
</table>
<div style="margin-top:16px;padding:12px;border:2px solid #000;border-radius:8px;">
<p style="margin:0 0 4px 0;font-weight:bold;font-size:13px;">üìù MEMORY VERSE:</p>
<p style="margin:0;font-size:14px;font-style:italic;">${r.study.memoryVerse}</p>
</div>
<div style="margin-top:12px;background:#000;color:#fff;padding:12px;border-radius:8px;">
<p style="margin:0;font-size:14px;font-weight:bold;">üí° KEY TRUTH: ${r.study.keyTruth}</p>
</div>
<div style="margin-top:16px;padding:12px;background:#f5f5f5;border-radius:8px;">
<p style="margin:0 0 8px 0;font-weight:bold;font-size:13px;">üîó FREE BIBLE TOOLS:</p>
<p style="margin:0;font-size:12px;line-height:1.6;">
<strong>BibleGateway.com</strong> ‚Äî Multiple translations & audio<br>
<strong>BlueLetter Bible.org</strong> ‚Äî Greek/Hebrew study tools<br>
<strong>YouVersion.com</strong> ‚Äî Bible app & reading plans<br>
<strong>BibleHub.com</strong> ‚Äî Commentaries & cross-references
</p>
</div>
</div>`;
    window.print();
}

function renderQuiz() {
    const container = document.getElementById('quizContent');
    if (!container) return;
    
    if (quizState.screen === 'start') {
        container.innerHTML = `
            <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:24px;padding:32px;border:1px solid rgba(255,255,255,0.2);text-align:center" class="fade-up">
                <div style="font-size:4rem;margin-bottom:24px">üìú</div>
                <h2 style="font-size:2rem;color:white;margin-bottom:12px">Discover Your Season</h2>
                <p style="color:#94a3b8;margin-bottom:8px">Which Biblical character reflects your faith journey?</p>
                <p style="color:#64748b;font-size:0.9rem;margin-bottom:32px">10 questions ‚Ä¢ 12 characters ‚Ä¢ 7-day study challenge</p>
                <button onclick="startQuiz()" style="width:100%;background:linear-gradient(135deg,#f59e0b,#ea580c);color:white;font-weight:600;padding:16px;border-radius:16px;border:none;font-size:1.1rem;cursor:pointer;box-shadow:0 0 30px rgba(251,191,36,0.3)">Begin Your Journey</button>
            </div>`;
    } else if (quizState.screen === 'quiz') {
        const q = QUESTIONS[quizState.qIndex];
        const progress = (quizState.qIndex / QUESTIONS.length) * 100;
        container.innerHTML = `
            <div class="fade-up">
                <div style="display:flex;justify-content:space-between;color:#64748b;font-size:0.9rem;margin-bottom:8px">
                    <span>Question ${quizState.qIndex + 1}/${QUESTIONS.length}</span>
                    <span>${Math.round(progress)}%</span>
                </div>
                <div style="height:8px;background:rgba(255,255,255,0.1);border-radius:4px;margin-bottom:24px">
                    <div style="height:100%;width:${progress}%;background:linear-gradient(90deg,#f59e0b,#ea580c);border-radius:4px;transition:width 0.3s"></div>
                </div>
                <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:24px;padding:24px;border:1px solid rgba(255,255,255,0.2)">
                    <h3 style="color:white;font-size:1.25rem;margin-bottom:24px">${q.q}</h3>
                    <div style="display:flex;flex-direction:column;gap:12px">
                        ${q.a.map((a, i) => `
                            <button onclick="selectAnswer(${i})" style="width:100%;text-align:left;padding:16px;border-radius:16px;border:2px solid ${quizState.answer === i ? '#f59e0b' : 'transparent'};background:${quizState.answer === i ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.05)'};color:${quizState.answer === i ? 'white' : '#cbd5e1'};cursor:pointer;transition:all 0.2s">
                                <div style="display:flex;align-items:center;gap:12px">
                                    <div style="width:20px;height:20px;border-radius:50%;border:2px solid ${quizState.answer === i ? '#f59e0b' : '#64748b'};background:${quizState.answer === i ? '#f59e0b' : 'transparent'};display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                        ${quizState.answer === i ? '<svg width="12" height="12" viewBox="0 0 20 20" fill="white"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>' : ''}
                                    </div>
                                    <span style="font-size:0.95rem">${a.text}</span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="nextQuestion()" ${quizState.answer === null ? 'disabled' : ''} style="width:100%;margin-top:24px;padding:16px;border-radius:16px;border:none;font-weight:600;cursor:${quizState.answer !== null ? 'pointer' : 'not-allowed'};background:${quizState.answer !== null ? 'linear-gradient(135deg,#f59e0b,#ea580c)' : 'rgba(255,255,255,0.05)'};color:${quizState.answer !== null ? 'white' : '#64748b'}">${quizState.qIndex === QUESTIONS.length - 1 ? 'See My Result' : 'Next'}</button>
                </div>
            </div>`;
    } else if (quizState.screen === 'result') {
        const sorted = Object.entries(quizState.scores).sort((a, b) => b[1] - a[1]);
        const topId = sorted[0][0];
        const char = CHARACTERS[topId];
        const topThree = sorted.slice(0, 3).map(([k]) => CHARACTERS[k]);
        const exp = quizState.expanded;
        
        if (Auth.currentUser) {
            UserDB.saveQuizResult(Auth.currentUser.uid, 'seasons', { character: topId, scores: quizState.scores });
            UserDB.saveToolProgress(Auth.currentUser.uid, 'seasons', { completed: true, character: topId });
        }
        
        container.innerHTML = `
            <div class="fade-up" style="padding-bottom:32px">
                <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:24px;padding:24px;border:1px solid rgba(255,255,255,0.2);text-align:center;margin-bottom:16px">
                    <div style="width:128px;height:128px;margin:0 auto 16px;border-radius:50%;background:linear-gradient(135deg,${char.color},${char.color}aa);display:flex;align-items:center;justify-content:center;font-size:4rem;border:4px solid rgba(255,255,255,0.2)">${char.icon}</div>
                    <p style="color:#f59e0b;font-size:0.85rem;text-transform:uppercase;letter-spacing:2px">Your Season Reflects</p>
                    <h2 style="color:white;font-size:2rem;margin:4px 0">${char.name}</h2>
                    <p style="color:#f59e0b;font-weight:500">${char.title}</p>
                    <p style="color:#94a3b8;margin-top:16px;font-size:0.95rem">${char.description}</p>
                    <div style="margin-top:16px;display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
                        ${topThree.slice(1).map(c => `<span style="background:rgba(255,255,255,0.1);padding:6px 12px;border-radius:20px;color:#94a3b8;font-size:0.8rem">${c.icon} ${c.name}</span>`).join('')}
                    </div>
                </div>

                <!-- Share Buttons -->
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px">
                    <button onclick="shareQuizApp()" style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,0.2);text-align:center;cursor:pointer;color:white">
                        <span style="font-size:1.5rem;display:block;margin-bottom:4px">üîó</span>
                        <span style="font-size:0.85rem;font-weight:500">Share Quiz</span>
                    </button>
                    <button onclick="shareQuizStudy()" style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,0.2);text-align:center;cursor:pointer;color:white">
                        <span style="font-size:1.5rem;display:block;margin-bottom:4px">üì§</span>
                        <span style="font-size:0.85rem;font-weight:500">Share Study</span>
                    </button>
                    <button onclick="printQuizStudy()" style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,0.2);text-align:center;cursor:pointer;color:white">
                        <span style="font-size:1.5rem;display:block;margin-bottom:4px">üñ®Ô∏è</span>
                        <span style="font-size:0.85rem;font-weight:500">Print Guide</span>
                    </button>
                    <button onclick="printQuizStudy()" style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,0.2);text-align:center;cursor:pointer;color:white">
                        <span style="font-size:1.5rem;display:block;margin-bottom:4px">üìÑ</span>
                        <span style="font-size:0.85rem;font-weight:500">Save as PDF</span>
                    </button>
                </div>

                <!-- Why You Match Accordion -->
                <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;border:1px solid rgba(255,255,255,0.2);margin-bottom:12px;overflow:hidden">
                    <button onclick="toggleExpand('why')" style="width:100%;padding:18px 20px;background:transparent;border:none;color:white;font-weight:600;font-size:1rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                        <span>üéØ Why You Match</span>
                        <span>${exp === 'why' ? '‚àí' : '+'}</span>
                    </button>
                    ${exp === 'why' ? `<div style="padding:0 20px 20px"><ul style="list-style:none;padding:0;margin:0">${char.whyMatch.map(w => `<li style="color:#94a3b8;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)">‚úì ${w}</li>`).join('')}</ul></div>` : ''}
                </div>

                <!-- Key Scriptures Accordion -->
                <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;border:1px solid rgba(255,255,255,0.2);margin-bottom:12px;overflow:hidden">
                    <button onclick="toggleExpand('scrip')" style="width:100%;padding:18px 20px;background:transparent;border:none;color:white;font-weight:600;font-size:1rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                        <span>üìñ Key Scriptures</span>
                        <span>${exp === 'scrip' ? '‚àí' : '+'}</span>
                    </button>
                    ${exp === 'scrip' ? `<div style="padding:0 20px 20px">${char.scriptures.map(s => `<div style="border-left:4px solid #f59e0b;background:linear-gradient(90deg,rgba(255,255,255,0.05),transparent);padding:12px;border-radius:0 8px 8px 0;margin-bottom:12px"><p style="color:#94a3b8;font-style:italic;font-size:0.9rem;margin:0">"${s.t}"</p><p style="color:#f59e0b;font-size:0.8rem;margin-top:6px">‚Äî ${s.r}</p></div>`).join('')}</div>` : ''}
                </div>

                <!-- 7-Day Study Challenge Accordion -->
                <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;border:1px solid rgba(255,255,255,0.2);margin-bottom:12px;overflow:hidden">
                    <button onclick="toggleExpand('study')" style="width:100%;padding:18px 20px;background:transparent;border:none;color:white;font-weight:600;font-size:1rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                        <span>üó∫Ô∏è 7-Day Study Challenge</span>
                        <span>${exp === 'study' ? '‚àí' : '+'}</span>
                    </button>
                    ${exp === 'study' ? `<div style="padding:0 20px 20px">
                        <h3 style="color:white;font-weight:bold;margin-bottom:16px">${char.study.title}</h3>
                        ${char.study.days.map((d, i) => `<div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;margin-bottom:12px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <span style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,${char.color},${char.color}aa);display:flex;align-items:center;justify-content:center;color:white;font-size:0.9rem;font-weight:bold">${i + 1}</span>
                                <span style="color:white;font-weight:500;font-size:0.95rem">${d.d}: ${d.t}</span>
                            </div>
                            <p style="color:#f59e0b;font-size:0.85rem;margin-bottom:6px">üìñ ${d.p}</p>
                            <p style="color:#94a3b8;font-size:0.85rem;font-style:italic;background:rgba(255,255,255,0.05);padding:8px;border-radius:6px">üí≠ ${d.q}</p>
                        </div>`).join('')}
                        <div style="background:rgba(255,255,255,0.1);border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid rgba(245,158,11,0.5)">
                            <p style="color:#f59e0b;font-size:0.8rem;margin-bottom:4px">üìù Memory Verse</p>
                            <p style="color:white;font-size:0.95rem">${char.study.memoryVerse}</p>
                        </div>
                        <div style="background:linear-gradient(135deg,${char.color},${char.color}aa);border-radius:12px;padding:16px;margin-bottom:16px">
                            <p style="color:rgba(255,255,255,0.8);font-size:0.8rem;margin-bottom:4px">üí° Key Truth</p>
                            <p style="color:white;font-weight:500;font-size:0.95rem">${char.study.keyTruth}</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px">
                            <p style="color:white;font-weight:500;font-size:0.95rem;margin-bottom:12px">üîó Free Bible Tools</p>
                            <p style="color:#94a3b8;font-size:0.85rem;line-height:1.8">
                                ‚Ä¢ <a href="https://www.biblegateway.com" target="_blank" style="color:#f59e0b;text-decoration:underline">BibleGateway.com</a> ‚Äî Multiple translations<br>
                                ‚Ä¢ <a href="https://www.blueletterbible.org" target="_blank" style="color:#f59e0b;text-decoration:underline">BlueLetter Bible.org</a> ‚Äî Study tools<br>
                                ‚Ä¢ <a href="https://www.youversion.com" target="_blank" style="color:#f59e0b;text-decoration:underline">YouVersion.com</a> ‚Äî Bible app<br>
                                ‚Ä¢ <a href="https://biblehub.com" target="_blank" style="color:#f59e0b;text-decoration:underline">BibleHub.com</a> ‚Äî Commentaries
                            </p>
                        </div>
                    </div>` : ''}
                </div>

                <button onclick="initQuiz()" style="width:100%;background:rgba(255,255,255,0.1);color:white;font-weight:600;padding:16px;border-radius:16px;border:1px solid rgba(255,255,255,0.2);cursor:pointer">Take Quiz Again</button>
            </div>`;
    }
}

function startQuiz() { quizState.screen = 'quiz'; renderQuiz(); }
function selectAnswer(i) { quizState.answer = i; renderQuiz(); }

function nextQuestion() {
    if (quizState.answer === null) return;
    const chars = QUESTIONS[quizState.qIndex].a[quizState.answer].chars;
    Object.entries(chars).forEach(([c, s]) => {
        quizState.scores[c] = (quizState.scores[c] || 0) + s;
    });
    if (quizState.qIndex < QUESTIONS.length - 1) {
        quizState.qIndex++;
        quizState.answer = null;
        renderQuiz();
    } else {
        quizState.screen = 'result';
        renderQuiz();
    }
}

// ========== INIT ==========
async function init() {
    document.body.dataset.theme = localStorage.getItem('rooted_theme') || 'dark';
    
    initFirebase();
    State.subscribe(render);
    const savedNav = localStorage.getItem('rooted_nav');
    const user = await Auth.init();
    if (user) {
        const activeNav = savedNav || 'dashboard';
        localStorage.removeItem('rooted_nav');
        State.set({ screen: 'app', user, activeNav });
    } else {
        State.set({ screen: 'welcome' });
    }
}

init();
</script>
</body>
</html>
