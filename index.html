<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Rooted ‚Äî Grow Where You're Planted</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,500;9..144,600;9..144,700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
/* ========== CSS RESET & VARIABLES ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --root-green: #2d5a47; --root-green-light: #3d7a5f; --root-green-dark: #1e3d30;
    --leaf-green: #7cb083; --leaf-light: #a8d4af;
    --earth-brown: #8b7355; --earth-light: #c4a77d;
    --cream: #faf8f5; --cream-dark: #f0ebe3;
    --slate-900: #1a1a2e; --slate-800: #252538; --slate-700: #3d3d56;
    --slate-600: #5a5a78; --slate-500: #7a7a96; --slate-400: #9e9eb8;
    --slate-300: #c4c4d4; --slate-200: #e2e2ec; --slate-100: #f4f4f8;
    --success: #22c55e; --warning: #f59e0b; --error: #ef4444; --info: #3b82f6;
    --font-display: 'Fraunces', Georgia, serif;
    --font-body: 'DM Sans', -apple-system, sans-serif;
    --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px;
    --space-xl: 32px; --space-2xl: 48px; --space-3xl: 64px;
    --sidebar-width: 280px; --header-height: 64px; --max-content: 1200px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
    --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
    --transition: 0.2s ease;
}

[data-theme="dark"] {
    --bg-primary: var(--slate-900); --bg-secondary: var(--slate-800); --bg-tertiary: var(--slate-700);
    --text-primary: var(--cream); --text-secondary: var(--slate-300); --text-tertiary: var(--slate-400);
    --border-color: rgba(255,255,255,0.1); --card-bg: rgba(255,255,255,0.05); --hover-bg: rgba(255,255,255,0.08);
}
[data-theme="light"] {
    --bg-primary: var(--cream); --bg-secondary: white; --bg-tertiary: var(--cream-dark);
    --text-primary: var(--slate-900); --text-secondary: var(--slate-600); --text-tertiary: var(--slate-500);
    --border-color: rgba(0,0,0,0.08); --card-bg: white; --hover-bg: rgba(0,0,0,0.03);
}

html { font-size: 16px; scroll-behavior: smooth; }
body { font-family: var(--font-body); background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; overflow-x: hidden; }
h1, h2, h3, h4 { font-family: var(--font-display); font-weight: 500; line-height: 1.3; }
a { color: inherit; text-decoration: none; }
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; }

/* Animations */
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
@keyframes spin { to { transform: rotate(360deg); } }
.fade-up { animation: fadeUp 0.4s ease; }
.fade-in { animation: fadeIn 0.3s ease; }

/* Layout */
#app { display: flex; min-height: 100vh; }
.sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; transition: transform 0.3s ease; }
.sidebar-header { padding: var(--space-lg); border-bottom: 1px solid var(--border-color); }
.sidebar-logo { display: flex; align-items: center; gap: var(--space-md); }
.sidebar-logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--root-green), var(--leaf-green)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
.sidebar-logo-text { font-family: var(--font-display); font-size: 1.5rem; font-weight: 600; }
.sidebar-nav { flex: 1; padding: var(--space-md); overflow-y: auto; }
.nav-section { margin-bottom: var(--space-lg); }
.nav-section-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-tertiary); padding: var(--space-sm) var(--space-md); }
.nav-item { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-md); color: var(--text-secondary); transition: all var(--transition); cursor: pointer; font-size: 0.95rem; }
.nav-item:hover { background: var(--hover-bg); color: var(--text-primary); }
.nav-item.active { background: linear-gradient(135deg, var(--root-green), var(--root-green-light)); color: white; }
.nav-item-icon { width: 20px; text-align: center; }
.sidebar-footer { padding: var(--space-md); border-top: 1px solid var(--border-color); }
.user-menu { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-md); cursor: pointer; }
.user-menu:hover { background: var(--hover-bg); }
.user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--root-green), var(--leaf-green)); display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; overflow: hidden; }
.user-avatar img { width: 100%; height: 100%; object-fit: cover; }
.user-info { flex: 1; min-width: 0; }
.user-name { font-weight: 500; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-email { font-size: 0.75rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.main-content { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; }
.main-header { height: var(--header-height); background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 var(--space-xl); position: sticky; top: 0; z-index: 50; }
.header-left { display: flex; align-items: center; gap: var(--space-lg); }
.menu-toggle { display: none; width: 40px; height: 40px; align-items: center; justify-content: center; border-radius: var(--radius-md); color: var(--text-secondary); font-size: 1.25rem; }
.page-title { font-family: var(--font-display); font-size: 1.25rem; }
.header-right { display: flex; align-items: center; gap: var(--space-md); }
.header-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-md); color: var(--text-secondary); transition: all var(--transition); }
.header-btn:hover { background: var(--hover-bg); color: var(--text-primary); }
.main-body { flex: 1; padding: var(--space-xl); max-width: var(--max-content); width: 100%; margin: 0 auto; }

/* Components */
.card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-lg); }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); font-weight: 500; font-size: 0.95rem; transition: all var(--transition); }
.btn-primary { background: linear-gradient(135deg, var(--root-green), var(--root-green-light)); color: white; }
.btn-primary:hover { box-shadow: 0 4px 20px rgba(45, 90, 71, 0.4); transform: translateY(-1px); }
.btn-secondary { background: var(--hover-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
.btn-secondary:hover { border-color: var(--root-green); }
.btn-ghost { color: var(--text-secondary); }
.btn-ghost:hover { background: var(--hover-bg); color: var(--text-primary); }
.btn-google { background: white; color: #333; border: 1px solid #ddd; }
.btn-google:hover { background: #f5f5f5; box-shadow: var(--shadow-md); }
.btn-sm { padding: var(--space-sm) var(--space-md); font-size: 0.85rem; }
.btn-lg { padding: var(--space-lg) var(--space-xl); font-size: 1.05rem; }
.btn-block { width: 100%; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

.input-group { margin-bottom: var(--space-lg); }
.input-label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); margin-bottom: var(--space-sm); }
.input-field { width: 100%; padding: var(--space-md); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary); font-size: 1rem; transition: all var(--transition); }
.input-field:focus { outline: none; border-color: var(--root-green); box-shadow: 0 0 0 3px rgba(45, 90, 71, 0.15); }
.input-field::placeholder { color: var(--text-tertiary); }
.input-error { border-color: var(--error); }
.error-text { color: var(--error); font-size: 0.85rem; margin-top: var(--space-xs); }

/* Auth Screens */
.auth-container { min-height: 100vh; display: flex; }
.auth-left { flex: 1; background: linear-gradient(135deg, var(--root-green), var(--root-green-dark)); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: var(--space-3xl); color: white; position: relative; overflow: hidden; }
.auth-left::before { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); }
.auth-brand { text-align: center; position: relative; z-index: 1; }
.auth-logo { font-size: 5rem; margin-bottom: var(--space-lg); }
.auth-brand-name { font-family: var(--font-display); font-size: 3.5rem; font-weight: 600; margin-bottom: var(--space-md); }
.auth-tagline { font-size: 1.25rem; opacity: 0.9; }
.auth-right { flex: 1; display: flex; align-items: center; justify-content: center; padding: var(--space-2xl); background: var(--bg-primary); }
.auth-form-container { width: 100%; max-width: 420px; }
.auth-form-title { font-size: 2rem; margin-bottom: var(--space-sm); text-align: center; }
.auth-form-subtitle { color: var(--text-secondary); text-align: center; margin-bottom: var(--space-xl); }
.auth-divider { display: flex; align-items: center; gap: var(--space-md); margin: var(--space-xl) 0; color: var(--text-tertiary); font-size: 0.85rem; }
.auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }
.auth-footer { text-align: center; margin-top: var(--space-xl); color: var(--text-secondary); font-size: 0.9rem; }
.auth-footer a { color: var(--root-green); font-weight: 500; }
.auth-footer a:hover { text-decoration: underline; }

/* Tool Cards */
.tool-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-xl); padding: var(--space-xl); cursor: pointer; transition: all var(--transition); position: relative; overflow: hidden; }
.tool-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--root-green), var(--leaf-green)); opacity: 0; transition: opacity var(--transition); }
.tool-card:hover { border-color: var(--root-green); box-shadow: var(--shadow-lg); transform: translateY(-4px); }
.tool-card:hover::before { opacity: 1; }
.tool-card.coming-soon { opacity: 0.6; cursor: not-allowed; }
.tool-card.coming-soon:hover { transform: none; box-shadow: none; border-color: var(--border-color); }
.tool-icon { width: 56px; height: 56px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; margin-bottom: var(--space-lg); }
.tool-title { font-family: var(--font-display); font-size: 1.15rem; margin-bottom: var(--space-sm); }
.tool-description { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: var(--space-lg); }
.tool-meta { display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap; }
.tool-tag { padding: var(--space-xs) var(--space-sm); background: var(--hover-bg); border-radius: var(--radius-sm); font-size: 0.75rem; color: var(--text-secondary); }

/* Grids */
.grid { display: grid; gap: var(--space-lg); }
.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

/* Stats */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--space-lg); }
.stat-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-lg); }
.stat-label { font-size: 0.8rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-sm); }
.stat-value { font-family: var(--font-display); font-size: 2rem; font-weight: 600; }

/* Welcome Banner */
.welcome-banner { background: linear-gradient(135deg, var(--root-green), var(--root-green-dark)); border-radius: var(--radius-xl); padding: var(--space-2xl); color: white; margin-bottom: var(--space-xl); position: relative; overflow: hidden; }
.welcome-banner::after { content: 'üå±'; position: absolute; right: var(--space-2xl); bottom: -20px; font-size: 8rem; opacity: 0.15; }
.welcome-title { font-size: 1.75rem; margin-bottom: var(--space-sm); }
.welcome-subtitle { opacity: 0.9; max-width: 500px; }

/* Section Headers */
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); }
.section-title { font-family: var(--font-display); font-size: 1.25rem; }

/* Empty State */
.empty-state { text-align: center; padding: var(--space-3xl); }
.empty-state-icon { font-size: 4rem; margin-bottom: var(--space-lg); }
.empty-state-title { font-size: 1.5rem; margin-bottom: var(--space-md); }
.empty-state-description { color: var(--text-secondary); max-width: 400px; margin: 0 auto; }

/* Toast */
.toast-container { position: fixed; bottom: var(--space-lg); right: var(--space-lg); z-index: 2000; }
.toast { background: var(--slate-800); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); margin-top: var(--space-sm); animation: fadeUp 0.3s ease; display: flex; align-items: center; gap: var(--space-sm); }
.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--error); }
.toast.info { border-left: 4px solid var(--info); }

/* Loading */
.loading-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: var(--space-lg); }
.loading-spinner { width: 48px; height: 48px; border: 3px solid var(--border-color); border-top-color: var(--root-green); border-radius: 50%; animation: spin 1s linear infinite; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg); }
.modal { background: var(--bg-secondary); border-radius: var(--radius-xl); max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: fadeUp 0.3s ease; }
.modal-header { padding: var(--space-lg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
.modal-title { font-family: var(--font-display); font-size: 1.25rem; }
.modal-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); color: var(--text-tertiary); }
.modal-close:hover { background: var(--hover-bg); }
.modal-body { padding: var(--space-lg); }
.modal-footer { padding: var(--space-lg); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: var(--space-md); }

/* Coming Soon Badge */
.coming-soon-badge { display: inline-flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); background: linear-gradient(135deg, var(--warning), #fbbf24); color: #333; border-radius: var(--radius-md); font-size: 0.8rem; font-weight: 600; }

/* Sidebar Overlay (mobile) */
.sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
.sidebar-overlay.show { display: block; }

/* Responsive */
@media (max-width: 1024px) {
    .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .auth-left { display: none; }
}
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); width: 85%; max-width: 320px; }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .menu-toggle { display: flex; }
    .main-body { padding: var(--space-md); }
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    .welcome-banner { padding: var(--space-lg); }
    .welcome-banner::after { display: none; }
}
    </style>
</head>
<body data-theme="dark">
    <div id="app"></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
    <div class="toast-container" id="toastContainer"></div>
    <div id="modalContainer"></div>

<script>
// ========== FIREBASE CONFIGURATION ==========
// IMPORTANT: Replace with your own Firebase config from console.firebase.google.com
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
let firebaseInitialized = false;
let auth = null;
let db = null;

function initFirebase() {
    try {
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.warn("Firebase not configured - running in local mode");
            return false;
        }
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        firebaseInitialized = true;
        return true;
    } catch (e) {
        console.error("Firebase init error:", e);
        return false;
    }
}

// ========== AUTH SERVICE ==========
const Auth = {
    currentUser: null,
    
    async init() {
        if (!firebaseInitialized) {
            // Local mode - check localStorage
            const localUser = localStorage.getItem('rooted_user');
            if (localUser) {
                this.currentUser = JSON.parse(localUser);
                return this.currentUser;
            }
            return null;
        }
        
        return new Promise((resolve) => {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    this.currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email?.split('@')[0] || 'User',
                        photoURL: user.photoURL,
                        provider: user.providerData[0]?.providerId || 'email'
                    };
                    // Ensure user document exists
                    await UserDB.ensureUserDoc(this.currentUser);
                    localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
                } else {
                    this.currentUser = null;
                    localStorage.removeItem('rooted_user');
                }
                resolve(this.currentUser);
            });
        });
    },
    
    async signUpWithEmail(email, password, name) {
        if (!firebaseInitialized) {
            // Local mode
            const user = { uid: 'local_' + Date.now(), email, name, photoURL: null, provider: 'local' };
            this.currentUser = user;
            localStorage.setItem('rooted_user', JSON.stringify(user));
            await UserDB.ensureUserDoc(user);
            return user;
        }
        
        const result = await auth.createUserWithEmailAndPassword(email, password);
        await result.user.updateProfile({ displayName: name });
        this.currentUser = {
            uid: result.user.uid,
            email: result.user.email,
            name: name,
            photoURL: null,
            provider: 'email'
        };
        await UserDB.ensureUserDoc(this.currentUser);
        localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
        return this.currentUser;
    },
    
    async signInWithEmail(email, password) {
        if (!firebaseInitialized) {
            // Local mode - check local storage for existing user
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            if (users[email] && users[email].password === password) {
                this.currentUser = users[email].user;
                localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
                return this.currentUser;
            }
            throw new Error('Invalid email or password');
        }
        
        const result = await auth.signInWithEmailAndPassword(email, password);
        this.currentUser = {
            uid: result.user.uid,
            email: result.user.email,
            name: result.user.displayName || result.user.email?.split('@')[0],
            photoURL: result.user.photoURL,
            provider: 'email'
        };
        localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
        return this.currentUser;
    },
    
    async signInWithGoogle() {
        if (!firebaseInitialized) {
            toast('Google Sign-In requires Firebase configuration', 'error');
            throw new Error('Firebase not configured');
        }
        
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        const result = await auth.signInWithPopup(provider);
        this.currentUser = {
            uid: result.user.uid,
            email: result.user.email,
            name: result.user.displayName,
            photoURL: result.user.photoURL,
            provider: 'google.com'
        };
        await UserDB.ensureUserDoc(this.currentUser);
        localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
        return this.currentUser;
    },
    
    async signOut() {
        if (firebaseInitialized) {
            await auth.signOut();
        }
        this.currentUser = null;
        localStorage.removeItem('rooted_user');
        localStorage.removeItem('rooted_nav');
    },
    
    async resetPassword(email) {
        if (!firebaseInitialized) {
            toast('Password reset requires Firebase configuration', 'error');
            throw new Error('Firebase not configured');
        }
        await auth.sendPasswordResetEmail(email);
    },
    
    async updateProfile(updates) {
        if (firebaseInitialized && auth.currentUser) {
            await auth.currentUser.updateProfile(updates);
        }
        Object.assign(this.currentUser, updates);
        localStorage.setItem('rooted_user', JSON.stringify(this.currentUser));
        await UserDB.updateUser(this.currentUser.uid, updates);
    }
};

// ========== USER DATABASE ==========
const UserDB = {
    async ensureUserDoc(user) {
        if (!firebaseInitialized) {
            // Local storage mode
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            if (!users[user.email]) {
                users[user.email] = {
                    user: user,
                    profile: { name: user.name, email: user.email, createdAt: new Date().toISOString() },
                    toolProgress: {},
                    quizResults: {},
                    settings: {}
                };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        const docRef = db.collection('users').doc(user.uid);
        const doc = await docRef.get();
        if (!doc.exists) {
            await docRef.set({
                profile: {
                    name: user.name,
                    email: user.email,
                    photoURL: user.photoURL,
                    provider: user.provider,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                toolProgress: {},
                quizResults: {},
                settings: {}
            });
        }
    },
    
    async getUserData(uid) {
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const user = Object.values(users).find(u => u.user.uid === uid);
            return user || null;
        }
        
        const doc = await db.collection('users').doc(uid).get();
        return doc.exists ? doc.data() : null;
    },
    
    async updateUser(uid, updates) {
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const userKey = Object.keys(users).find(k => users[k].user.uid === uid);
            if (userKey) {
                users[userKey] = { ...users[userKey], ...updates };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        await db.collection('users').doc(uid).update(updates);
    },
    
    async saveToolProgress(uid, toolId, progress) {
        const key = `toolProgress.${toolId}`;
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const userKey = Object.keys(users).find(k => users[k].user.uid === uid);
            if (userKey) {
                if (!users[userKey].toolProgress) users[userKey].toolProgress = {};
                users[userKey].toolProgress[toolId] = { ...progress, updatedAt: new Date().toISOString() };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        await db.collection('users').doc(uid).update({
            [key]: { ...progress, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        });
    },
    
    async getToolProgress(uid, toolId) {
        const data = await this.getUserData(uid);
        return data?.toolProgress?.[toolId] || null;
    },
    
    async getAllToolProgress(uid) {
        const data = await this.getUserData(uid);
        return data?.toolProgress || {};
    },
    
    async saveQuizResult(uid, quizId, result) {
        const key = `quizResults.${quizId}`;
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const userKey = Object.keys(users).find(k => users[k].user.uid === uid);
            if (userKey) {
                if (!users[userKey].quizResults) users[userKey].quizResults = {};
                users[userKey].quizResults[quizId] = { ...result, completedAt: new Date().toISOString() };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        await db.collection('users').doc(uid).update({
            [key]: { ...result, completedAt: firebase.firestore.FieldValue.serverTimestamp() }
        });
    },
    
    async saveSettings(uid, settings) {
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            const userKey = Object.keys(users).find(k => users[k].user.uid === uid);
            if (userKey) {
                users[userKey].settings = { ...users[userKey].settings, ...settings };
                localStorage.setItem('rooted_users', JSON.stringify(users));
            }
            return;
        }
        
        await db.collection('users').doc(uid).update({ settings });
    }
};

// ========== TOOLS REGISTRY ==========
const TOOLS_BASE_PATH = './tools/';

const TOOLS = {
    seasons: { id: 'seasons', name: 'Discover Your Season', description: 'Find which biblical character\'s journey mirrors your current spiritual season.', icon: 'üå±', color: 'linear-gradient(135deg, #2d5a47, #7cb083)', category: 'assessment', duration: '5 min', status: 'active', type: 'internal' },
    formation: { id: 'formation', name: 'Spiritual Formation Dashboard', description: 'A comprehensive 100-question assessment across 25 categories to evaluate your spiritual growth journey.', icon: 'üìä', color: 'linear-gradient(135deg, #f59e0b, #fbbf24)', category: 'assessment', duration: '20 min', status: 'active', type: 'external', path: 'spiritual-formation.html' },
    gifts: { id: 'gifts', name: 'Spiritual Gifts Assessment', description: 'Discover your unique spiritual gifts and how God has equipped you to serve.', icon: 'üéÅ', color: 'linear-gradient(135deg, #7c3aed, #a78bfa)', category: 'assessment', duration: '15 min', status: 'coming', type: 'external', path: '' },
    bible_reading: { id: 'bible_reading', name: 'Bible Reading Plans', description: 'Structured reading plans to journey through Scripture.', icon: 'üìñ', color: 'linear-gradient(135deg, #dc2626, #f87171)', category: 'bible', duration: 'Daily', status: 'coming', type: 'external', path: '' },
    verse_memory: { id: 'verse_memory', name: 'Scripture Memory', description: 'Memorize key verses with flashcards and spaced repetition.', icon: 'üß†', color: 'linear-gradient(135deg, #8b5cf6, #a78bfa)', category: 'bible', duration: '5 min/day', status: 'coming', type: 'external', path: '' },
    bible_study: { id: 'bible_study', name: 'Inductive Bible Study', description: 'Learn the Observation-Interpretation-Application method.', icon: 'üîç', color: 'linear-gradient(135deg, #0891b2, #22d3ee)', category: 'bible', duration: '30 min', status: 'coming', type: 'external', path: '' },
    prayer: { id: 'prayer', name: 'Prayer Journal', description: 'Track prayers using ACTS method. Record answers!', icon: 'üôè', color: 'linear-gradient(135deg, #ec4899, #f472b6)', category: 'devotional', duration: 'Daily', status: 'coming', type: 'external', path: '' },
    lectio: { id: 'lectio', name: 'Lectio Divina', description: 'Ancient practice of divine reading: Read, Reflect, Respond, Rest.', icon: '‚ú®', color: 'linear-gradient(135deg, #6366f1, #818cf8)', category: 'devotional', duration: '15 min', status: 'coming', type: 'external', path: '' },
    psalms: { id: 'psalms', name: 'Praying the Psalms', description: 'Use the Psalms as your prayer guide.', icon: 'üéµ', color: 'linear-gradient(135deg, #f59e0b, #fbbf24)', category: 'devotional', duration: '10 min', status: 'coming', type: 'external', path: '' },
    theology: { id: 'theology', name: 'Core Doctrines', description: 'Learn essential Christian beliefs.', icon: '‚õ™', color: 'linear-gradient(135deg, #475569, #64748b)', category: 'discipleship', duration: '8 weeks', status: 'coming', type: 'external', path: '' },
    growth: { id: 'growth', name: 'New Believer Track', description: 'Foundation course for new believers.', icon: 'üåü', color: 'linear-gradient(135deg, #d97706, #fbbf24)', category: 'discipleship', duration: '6 weeks', status: 'coming', type: 'external', path: '' },
    fruit: { id: 'fruit', name: 'Fruit of the Spirit', description: 'Growth plan for Galatians 5:22-23.', icon: 'üçá', color: 'linear-gradient(135deg, #84cc16, #a3e635)', category: 'discipleship', duration: '9 weeks', status: 'coming', type: 'external', path: '' },
    armor: { id: 'armor', name: 'Armor of God', description: 'Ephesians 6:10-18 study.', icon: 'üõ°Ô∏è', color: 'linear-gradient(135deg, #78716c, #a8a29e)', category: 'discipleship', duration: '7 days', status: 'coming', type: 'external', path: '' },
    community: { id: 'community', name: 'Small Groups', description: 'Connect with others for study and accountability.', icon: 'üë•', color: 'linear-gradient(135deg, #14b8a6, #2dd4bf)', category: 'community', duration: 'Weekly', status: 'coming', type: 'external', path: '' },
    testimony: { id: 'testimony', name: 'Share Your Story', description: 'Craft your testimony: Before, How, After.', icon: 'üì£', color: 'linear-gradient(135deg, #ef4444, #f87171)', category: 'community', duration: '30 min', status: 'coming', type: 'external', path: '' }
};

// ========== STATE ==========
const State = {
    current: { screen: 'loading', user: null, activeNav: 'dashboard', sidebarOpen: false },
    listeners: [],
    set(updates) { this.current = { ...this.current, ...updates }; this.notify(); },
    subscribe(fn) { this.listeners.push(fn); },
    notify() { this.listeners.forEach(fn => fn(this.current)); }
};

// ========== HELPERS ==========
function toast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<span>${message}</span>`;
    container.appendChild(t);
    setTimeout(() => t.remove(), 4000);
}

function toggleSidebar(open) {
    State.set({ sidebarOpen: open });
    document.getElementById('sidebarOverlay')?.classList.toggle('show', open);
    document.querySelector('.sidebar')?.classList.toggle('open', open);
}

function toggleTheme() {
    const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    document.body.dataset.theme = theme;
    localStorage.setItem('rooted_theme', theme);
}

function navigate(nav) {
    State.set({ activeNav: nav });
    toggleSidebar(false);
}

function showModal(content) {
    document.getElementById('modalContainer').innerHTML = `<div class="modal-overlay" onclick="if(event.target===this)closeModal()">${content}</div>`;
}

function closeModal() {
    document.getElementById('modalContainer').innerHTML = '';
}

// ========== RENDER ==========
function render() {
    const app = document.getElementById('app');
    const { screen } = State.current;
    
    switch(screen) {
        case 'loading':
            app.innerHTML = `<div class="loading-screen"><div class="loading-spinner"></div><p style="color:var(--text-secondary)">Loading...</p></div>`;
            break;
        case 'welcome':
            app.innerHTML = renderWelcome();
            break;
        case 'login':
            app.innerHTML = renderLogin();
            break;
        case 'signup':
            app.innerHTML = renderSignup();
            break;
        case 'forgot-password':
            app.innerHTML = renderForgotPassword();
            break;
        case 'app':
            app.innerHTML = renderApp();
            break;
        case 'tool-seasons':
            app.innerHTML = renderSeasonsTool();
            setTimeout(initQuiz, 50);
            break;
    }
}

function renderWelcome() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">Rooted</h1>
                <p class="auth-tagline">Grow Where You're Planted</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <h2 class="auth-form-title">Welcome</h2>
                <p class="auth-form-subtitle">Your personal spiritual growth companion</p>
                
                <button class="btn btn-primary btn-lg btn-block" onclick="State.set({screen:'signup'})">
                    Create Account
                </button>
                
                <div class="auth-divider">or</div>
                
                <button class="btn btn-secondary btn-lg btn-block" onclick="State.set({screen:'login'})">
                    Sign In
                </button>
                
                <div style="margin-top:var(--space-2xl);padding:var(--space-lg);background:var(--hover-bg);border-radius:var(--radius-lg);text-align:center">
                    <div class="coming-soon-badge" style="margin-bottom:var(--space-md)">
                        <span>‚õ™</span> Coming Soon
                    </div>
                    <h4 style="margin-bottom:var(--space-sm)">Church Accounts</h4>
                    <p style="font-size:0.9rem;color:var(--text-secondary)">Connect your entire congregation with shared resources, group studies, and church-wide growth tracking.</p>
                </div>
            </div>
        </div>
    </div>`;
}

function renderLogin() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">Rooted</h1>
                <p class="auth-tagline">Grow Where You're Planted</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'welcome'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
                
                <h2 class="auth-form-title">Welcome Back</h2>
                <p class="auth-form-subtitle">Sign in to continue your journey</p>
                
                <button class="btn btn-google btn-lg btn-block" onclick="handleGoogleSignIn()">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>
                
                <div class="auth-divider">or sign in with email</div>
                
                <form onsubmit="handleEmailSignIn(event)">
                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="loginEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <input type="password" class="input-field" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block" id="loginBtn">Sign In</button>
                </form>
                
                <div class="auth-footer">
                    <a href="#" onclick="State.set({screen:'forgot-password'});return false;">Forgot password?</a>
                    <span style="margin:0 var(--space-sm)">‚Ä¢</span>
                    <a href="#" onclick="State.set({screen:'signup'});return false;">Create account</a>
                </div>
            </div>
        </div>
    </div>`;
}

function renderSignup() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">Rooted</h1>
                <p class="auth-tagline">Grow Where You're Planted</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'welcome'})" style="margin-bottom:var(--space-lg)">‚Üê Back</button>
                
                <h2 class="auth-form-title">Create Account</h2>
                <p class="auth-form-subtitle">Start your spiritual growth journey</p>
                
                <button class="btn btn-google btn-lg btn-block" onclick="handleGoogleSignIn()">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>
                
                <div class="auth-divider">or sign up with email</div>
                
                <form onsubmit="handleEmailSignUp(event)">
                    <div class="input-group">
                        <label class="input-label">Name</label>
                        <input type="text" class="input-field" id="signupName" placeholder="Your name" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <input type="password" class="input-field" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
                        <p style="font-size:0.8rem;color:var(--text-tertiary);margin-top:var(--space-xs)">At least 6 characters</p>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block" id="signupBtn">Create Account</button>
                </form>
                
                <div class="auth-footer">
                    Already have an account? <a href="#" onclick="State.set({screen:'login'});return false;">Sign in</a>
                </div>
            </div>
        </div>
    </div>`;
}

function renderForgotPassword() {
    return `
    <div class="auth-container fade-up">
        <div class="auth-left">
            <div class="auth-brand">
                <div class="auth-logo">üå±</div>
                <h1 class="auth-brand-name">Rooted</h1>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <button class="btn btn-ghost" onclick="State.set({screen:'login'})" style="margin-bottom:var(--space-lg)">‚Üê Back to Sign In</button>
                
                <h2 class="auth-form-title">Reset Password</h2>
                <p class="auth-form-subtitle">Enter your email and we'll send you a reset link</p>
                
                <form onsubmit="handlePasswordReset(event)">
                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="resetEmail" placeholder="your@email.com" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Send Reset Link</button>
                </form>
            </div>
        </div>
    </div>`;
}

// ========== AUTH HANDLERS ==========
async function handleGoogleSignIn() {
    try {
        await Auth.signInWithGoogle();
        toast('Welcome to Rooted! üå±', 'success');
        State.set({ screen: 'app', user: Auth.currentUser, activeNav: 'dashboard' });
    } catch (e) {
        toast(e.message || 'Google sign-in failed', 'error');
    }
}

async function handleEmailSignIn(e) {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    btn.disabled = true;
    btn.textContent = 'Signing in...';
    
    try {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        await Auth.signInWithEmail(email, password);
        toast('Welcome back! üå±', 'success');
        State.set({ screen: 'app', user: Auth.currentUser, activeNav: 'dashboard' });
    } catch (e) {
        toast(e.message || 'Sign in failed', 'error');
        btn.disabled = false;
        btn.textContent = 'Sign In';
    }
}

async function handleEmailSignUp(e) {
    e.preventDefault();
    const btn = document.getElementById('signupBtn');
    btn.disabled = true;
    btn.textContent = 'Creating account...';
    
    try {
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            if (users[email]) {
                throw new Error('Email already exists');
            }
        }
        
        await Auth.signUpWithEmail(email, password, name);
        
        if (!firebaseInitialized) {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            users[email].password = password;
            localStorage.setItem('rooted_users', JSON.stringify(users));
        }
        
        toast('Welcome to Rooted! üå±', 'success');
        State.set({ screen: 'app', user: Auth.currentUser, activeNav: 'dashboard' });
    } catch (e) {
        toast(e.message || 'Sign up failed', 'error');
        btn.disabled = false;
        btn.textContent = 'Create Account';
    }
}

async function handlePasswordReset(e) {
    e.preventDefault();
    try {
        const email = document.getElementById('resetEmail').value;
        await Auth.resetPassword(email);
        toast('Password reset email sent!', 'success');
        State.set({ screen: 'login' });
    } catch (e) {
        toast(e.message || 'Failed to send reset email', 'error');
    }
}

async function handleSignOut() {
    await Auth.signOut();
    toast('Signed out', 'info');
    State.set({ screen: 'welcome', user: null });
}

// ========== MAIN APP ==========
function renderApp() {
    const { user, activeNav } = State.current;
    
    return `
    <aside class="sidebar ${State.current.sidebarOpen ? 'open' : ''}">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üå±</div>
                <span class="sidebar-logo-text">Rooted</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <div class="nav-item ${activeNav === 'dashboard' ? 'active' : ''}" onclick="navigate('dashboard')">
                    <span class="nav-item-icon">üè†</span> Dashboard
                </div>
                <div class="nav-item ${activeNav === 'tools' ? 'active' : ''}" onclick="navigate('tools')">
                    <span class="nav-item-icon">üß∞</span> Growth Tools
                </div>
                <div class="nav-item ${activeNav === 'progress' ? 'active' : ''}" onclick="navigate('progress')">
                    <span class="nav-item-icon">üìà</span> My Progress
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <div class="nav-item ${activeNav === 'profile' ? 'active' : ''}" onclick="navigate('profile')">
                    <span class="nav-item-icon">üë§</span> Profile
                </div>
                <div class="nav-item ${activeNav === 'settings' ? 'active' : ''}" onclick="navigate('settings')">
                    <span class="nav-item-icon">‚öôÔ∏è</span> Settings
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Coming Soon</div>
                <div class="nav-item" style="opacity:0.5;cursor:default">
                    <span class="nav-item-icon">‚õ™</span> Church Account
                    <span class="coming-soon-badge" style="font-size:0.65rem;padding:2px 6px;margin-left:auto">Soon</span>
                </div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-menu" onclick="showUserMenu()">
                <div class="user-avatar">
                    ${user?.photoURL ? `<img src="${user.photoURL}" alt="">` : (user?.name?.charAt(0) || 'U')}
                </div>
                <div class="user-info">
                    <div class="user-name">${user?.name || 'User'}</div>
                    <div class="user-email">${user?.email || ''}</div>
                </div>
            </div>
        </div>
    </aside>
    <main class="main-content">
        <header class="main-header">
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleSidebar(true)">‚ò∞</button>
                <h1 class="page-title">${getPageTitle(activeNav)}</h1>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="toggleTheme()" title="Toggle theme">
                    ${document.body.dataset.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
                </button>
            </div>
        </header>
        <div class="main-body">
            ${renderPage(activeNav)}
        </div>
    </main>`;
}

function getPageTitle(nav) {
    const titles = { dashboard: 'Dashboard', tools: 'Growth Tools', progress: 'My Progress', profile: 'Profile', settings: 'Settings' };
    return titles[nav] || 'Dashboard';
}

function renderPage(page) {
    switch(page) {
        case 'dashboard': return renderDashboard();
        case 'tools': return renderTools();
        case 'progress': return renderProgress();
        case 'profile': return renderProfile();
        case 'settings': return renderSettings();
        default: return renderDashboard();
    }
}

function showUserMenu() {
    showModal(`
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Account</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center;margin-bottom:var(--space-lg)">
                    <div class="user-avatar" style="width:80px;height:80px;font-size:2rem;margin:0 auto var(--space-md)">
                        ${Auth.currentUser?.photoURL ? `<img src="${Auth.currentUser.photoURL}" alt="">` : (Auth.currentUser?.name?.charAt(0) || 'U')}
                    </div>
                    <h3>${Auth.currentUser?.name || 'User'}</h3>
                    <p style="color:var(--text-secondary)">${Auth.currentUser?.email || ''}</p>
                </div>
                <button class="btn btn-secondary btn-block" onclick="closeModal();navigate('profile')">Edit Profile</button>
                <button class="btn btn-secondary btn-block" onclick="closeModal();navigate('settings')" style="margin-top:var(--space-sm)">Settings</button>
                <hr style="border:none;border-top:1px solid var(--border-color);margin:var(--space-lg) 0">
                <button class="btn btn-ghost btn-block" onclick="closeModal();handleSignOut()" style="color:var(--error)">Sign Out</button>
            </div>
        </div>
    `);
}

function renderDashboard() {
    const user = Auth.currentUser;
    return `
    <div class="fade-up">
        <div class="welcome-banner">
            <h2 class="welcome-title">Welcome${user?.name ? ', ' + user.name.split(' ')[0] : ''}! üå±</h2>
            <p class="welcome-subtitle">Continue growing in your faith journey. Your progress is saved automatically.</p>
        </div>
        <div class="stat-grid" style="margin-bottom:var(--space-2xl)">
            <div class="stat-card">
                <div class="stat-label">Tools Available</div>
                <div class="stat-value">${Object.values(TOOLS).filter(t => t.status === 'active').length}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Coming Soon</div>
                <div class="stat-value">${Object.values(TOOLS).filter(t => t.status === 'coming').length}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Account</div>
                <div class="stat-value" style="font-size:1rem">${user?.provider === 'google.com' ? 'üîó Google' : 'üìß Email'}</div>
            </div>
        </div>
        <div class="section-header">
            <h3 class="section-title">Start Growing</h3>
            <button class="btn btn-ghost btn-sm" onclick="navigate('tools')">View All ‚Üí</button>
        </div>
        <div class="grid grid-2">
            ${Object.values(TOOLS).filter(t => t.status === 'active').slice(0, 2).map(t => renderToolCard(t)).join('')}
        </div>
    </div>`;
}

function renderTools() {
    const tools = Object.values(TOOLS);
    const categories = [...new Set(tools.map(t => t.category))];
    return `
    <div class="fade-up">
        <p style="color:var(--text-secondary);margin-bottom:var(--space-xl)">Discover tools designed to help you grow in your faith.</p>
        ${categories.map(cat => `
            <div class="section-header"><h3 class="section-title" style="text-transform:capitalize">${cat}</h3></div>
            <div class="grid grid-3" style="margin-bottom:var(--space-2xl)">
                ${tools.filter(t => t.category === cat).map(t => renderToolCard(t)).join('')}
            </div>
        `).join('')}
    </div>`;
}

function renderToolCard(tool) {
    const isActive = tool.status === 'active';
    return `
    <div class="tool-card ${!isActive ? 'coming-soon' : ''}" onclick="${isActive ? `openTool('${tool.id}')` : ''}">
        <div class="tool-icon" style="background:${tool.color}">${tool.icon}</div>
        <h4 class="tool-title">${tool.name}</h4>
        <p class="tool-description">${tool.description}</p>
        <div class="tool-meta">
            <span class="tool-tag">${tool.duration}</span>
            ${!isActive ? '<span class="tool-tag">Coming Soon</span>' : ''}
        </div>
    </div>`;
}

function openTool(toolId) {
    const tool = TOOLS[toolId];
    if (!tool) return;
    if (tool.type === 'internal') {
        State.set({ screen: 'tool-seasons' });
    } else if (tool.type === 'external' && tool.path) {
        localStorage.setItem('rooted_nav', 'tools');
        window.open(TOOLS_BASE_PATH + tool.path, '_blank');
    }
}

function renderProgress() {
    return `
    <div class="fade-up">
        <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3 class="empty-state-title">Track Your Growth</h3>
            <p class="empty-state-description">Complete tools and assessments to see your progress here.</p>
            <button class="btn btn-primary" style="margin-top:var(--space-lg)" onclick="navigate('tools')">Start a Tool</button>
        </div>
    </div>`;
}

function renderProfile() {
    const user = Auth.currentUser;
    return `
    <div class="fade-up">
        <div class="card" style="max-width:500px">
            <div style="text-align:center;margin-bottom:var(--space-xl)">
                <div class="user-avatar" style="width:100px;height:100px;font-size:2.5rem;margin:0 auto var(--space-md)">
                    ${user?.photoURL ? `<img src="${user.photoURL}" alt="">` : (user?.name?.charAt(0) || 'U')}
                </div>
                ${user?.provider === 'google.com' ? '<p style="color:var(--text-tertiary);font-size:0.85rem">Connected with Google</p>' : ''}
            </div>
            <div class="input-group">
                <label class="input-label">Name</label>
                <input type="text" class="input-field" id="profileName" value="${user?.name || ''}">
            </div>
            <div class="input-group">
                <label class="input-label">Email</label>
                <input type="email" class="input-field" value="${user?.email || ''}" disabled style="opacity:0.6">
                <p style="font-size:0.8rem;color:var(--text-tertiary);margin-top:var(--space-xs)">Email cannot be changed</p>
            </div>
            <button class="btn btn-primary btn-block" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>`;
}

async function saveProfile() {
    const name = document.getElementById('profileName').value.trim();
    if (!name) { toast('Name is required', 'error'); return; }
    await Auth.updateProfile({ name, displayName: name });
    toast('Profile updated!', 'success');
    render();
}

function renderSettings() {
    return `
    <div class="fade-up">
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">üé® Appearance</h3>
            <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                    <p style="font-weight:500">Theme</p>
                    <p style="font-size:0.85rem;color:var(--text-tertiary)">Choose light or dark mode</p>
                </div>
                <button class="btn btn-secondary" onclick="toggleTheme();render()">
                    ${document.body.dataset.theme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode'}
                </button>
            </div>
        </div>
        <div class="card" style="margin-bottom:var(--space-lg)">
            <h3 style="margin-bottom:var(--space-lg)">üì¶ Data</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">Your data is ${firebaseInitialized ? 'synced to the cloud' : 'stored locally on this device'}.</p>
            <button class="btn btn-secondary" onclick="exportUserData()">üì• Export My Data</button>
        </div>
        <div class="card" style="border-color:var(--error)">
            <h3 style="margin-bottom:var(--space-md);color:var(--error)">‚ö†Ô∏è Danger Zone</h3>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg)">Permanently delete your account and all data.</p>
            <button class="btn btn-secondary" style="color:var(--error);border-color:var(--error)" onclick="confirmDeleteAccount()">Delete Account</button>
        </div>
    </div>`;
}

async function exportUserData() {
    const data = await UserDB.getUserData(Auth.currentUser.uid);
    const exportData = { profile: Auth.currentUser, data: data, exportedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rooted-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Data exported!', 'success');
}

function confirmDeleteAccount() {
    showModal(`
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" style="color:var(--error)">‚ö†Ô∏è Delete Account</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:var(--space-lg)">Are you sure? This cannot be undone.</p>
                <div class="input-group">
                    <label class="input-label">Type "DELETE" to confirm</label>
                    <input type="text" class="input-field" id="deleteConfirm" placeholder="DELETE">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" style="background:var(--error)" onclick="deleteAccount()">Delete Forever</button>
            </div>
        </div>
    `);
}

async function deleteAccount() {
    if (document.getElementById('deleteConfirm').value !== 'DELETE') {
        toast('Please type DELETE to confirm', 'error');
        return;
    }
    try {
        if (firebaseInitialized) {
            await db.collection('users').doc(Auth.currentUser.uid).delete();
            await auth.currentUser.delete();
        } else {
            const users = JSON.parse(localStorage.getItem('rooted_users') || '{}');
            delete users[Auth.currentUser.email];
            localStorage.setItem('rooted_users', JSON.stringify(users));
        }
        await Auth.signOut();
        closeModal();
        toast('Account deleted', 'info');
        State.set({ screen: 'welcome', user: null });
    } catch (e) {
        toast(e.message || 'Failed to delete account', 'error');
    }
}

// ========== SEASONS QUIZ ==========
const CHARACTERS = {
    moses: { name: "Moses", title: "The Reluctant Leader", icon: "üî•", color: "#b45309", description: "You're in a season of being called to something bigger than yourself, even though you feel inadequate." },
    david: { name: "David", title: "The Worshiper's Heart", icon: "üéµ", color: "#7c3aed", description: "You're in a season where intimacy with God matters more than success." },
    abraham: { name: "Abraham", title: "The Faith Walker", icon: "‚≠ê", color: "#0284c7", description: "You're in a season of stepping into the unknown, trusting God." },
    esther: { name: "Esther", title: "The Strategic Intercessor", icon: "üëë", color: "#db2777", description: "You're in a season of divine positioning‚Äîfor such a time as this." },
    joseph: { name: "Joseph", title: "The Faithful Sufferer", icon: "üåæ", color: "#059669", description: "You're in a season of private pain and unseen faithfulness." },
    deborah: { name: "Deborah", title: "The Prophetic Leader", icon: "‚öñÔ∏è", color: "#0d9488", description: "You're in a season of bold leadership and speaking truth." },
    peter: { name: "Peter", title: "The Restored Leader", icon: "ü™®", color: "#64748b", description: "You're in a season of restoration after failure." },
    paul: { name: "Paul", title: "The Transformed Missionary", icon: "‚úùÔ∏è", color: "#dc2626", description: "You're in a season of radical transformation." },
    marymagdalene: { name: "Mary Magdalene", title: "The Devoted Witness", icon: "üåÖ", color: "#ec4899", description: "You're in a season of deep devotion born from gratitude." },
    timothy: { name: "Timothy", title: "The Emerging Leader", icon: "üìú", color: "#8b5cf6", description: "You're in a season of learning and being mentored." },
    ruth: { name: "Ruth", title: "The Faithful Outsider", icon: "üåø", color: "#84cc16", description: "You're in a season of loyalty and faithful presence." },
    priscilla: { name: "Priscilla", title: "The Teaching Partner", icon: "üè†", color: "#f97316", description: "You're in a season of partnered ministry and teaching." }
};

const QUESTIONS = [
    { q: "When facing a major decision, what is your primary inner struggle?", a: [
        { text: "I feel unqualified and make excuses", chars: { moses: 3, timothy: 2, peter: 1 } },
        { text: "I'm torn between trusting God's timing and making it happen myself", chars: { abraham: 3, joseph: 2 } },
        { text: "I want to act but fear the cost", chars: { esther: 3, deborah: 2, paul: 1 } },
        { text: "I seek counsel and try to discern God's direction", chars: { ruth: 2, priscilla: 2, david: 1 } }
    ]},
    { q: "How do you most naturally express your faith?", a: [
        { text: "Through worship, music, and emotional expression", chars: { david: 3, marymagdalene: 2 } },
        { text: "Through teaching and explaining truth to others", chars: { priscilla: 3, paul: 2, timothy: 1 } },
        { text: "Through faithful presence and quiet service", chars: { ruth: 3, joseph: 2 } },
        { text: "Through bold action and courageous steps", chars: { deborah: 3, esther: 2, peter: 1 } }
    ]},
    { q: "What best describes your relationship with waiting on God?", a: [
        { text: "I'm holding unfulfilled promises with hope", chars: { abraham: 3, joseph: 2 } },
        { text: "I'm being prepared in hiddenness for something", chars: { moses: 3, david: 2, timothy: 1 } },
        { text: "I sense I'm positioned for a specific purpose", chars: { esther: 3, ruth: 2 } },
        { text: "I'm learning through others' investment in me", chars: { timothy: 3, priscilla: 1, peter: 1 } }
    ]},
    { q: "How do you respond when you've failed?", a: [
        { text: "I return to God in honest, emotional repentance", chars: { david: 3, peter: 2 } },
        { text: "I feel disqualified and wonder if God can still use me", chars: { peter: 3, moses: 2 } },
        { text: "I process privately, trusting God is still working", chars: { joseph: 3, ruth: 2 } },
        { text: "I remember what Jesus delivered me from", chars: { paul: 3, marymagdalene: 3 } }
    ]},
    { q: "When others look to you for leadership, how do you feel?", a: [
        { text: "Inadequate‚Äîwho am I to lead?", chars: { moses: 3, timothy: 2, peter: 1 } },
        { text: "Responsible‚ÄîGod positioned me here", chars: { esther: 3, deborah: 2, joseph: 1 } },
        { text: "Restored‚Äîmy failures give me something to offer", chars: { peter: 3, paul: 2 } },
        { text: "Collaborative‚ÄîI prefer leading alongside others", chars: { priscilla: 3, ruth: 2 } }
    ]},
    { q: "What has suffering produced most in your life?", a: [
        { text: "Deeper intimacy with God", chars: { david: 3, marymagdalene: 2, paul: 1 } },
        { text: "Character and ability to see God's purposes", chars: { joseph: 3, ruth: 2 } },
        { text: "Boldness‚ÄîI'm no longer afraid to risk", chars: { paul: 3, esther: 2, deborah: 1 } },
        { text: "Compassion for others in pain", chars: { moses: 2, peter: 2, timothy: 1 } }
    ]},
    { q: "How do you prefer to serve in God's kingdom?", a: [
        { text: "Behind the scenes, faithfully doing my part", chars: { ruth: 3, joseph: 2, timothy: 1 } },
        { text: "Teaching and discipling others", chars: { priscilla: 3, paul: 2 } },
        { text: "Leading from the front when needed", chars: { deborah: 3, moses: 2, peter: 1 } },
        { text: "Interceding and supporting leaders", chars: { esther: 3, marymagdalene: 2, david: 1 } }
    ]},
    { q: "What is your greatest spiritual struggle right now?", a: [
        { text: "Feeling too young or inexperienced", chars: { timothy: 3, david: 2 } },
        { text: "Dealing with past failures or shame", chars: { peter: 3, paul: 2, marymagdalene: 1 } },
        { text: "Waiting for God's timing", chars: { abraham: 3, joseph: 2, moses: 1 } },
        { text: "Knowing when to speak up", chars: { esther: 3, deborah: 2 } }
    ]},
    { q: "Which statement resonates most with you?", a: [
        { text: "My past disqualifies me, but grace says otherwise", chars: { paul: 3, peter: 2, marymagdalene: 2 } },
        { text: "I'm still learning and need wise mentors", chars: { timothy: 3, ruth: 2 } },
        { text: "God has placed me here for a reason", chars: { esther: 3, joseph: 2 } },
        { text: "I lead best when I'm close to God's heart", chars: { david: 3, deborah: 2, moses: 1 } }
    ]},
    { q: "How do you handle conflict or opposition?", a: [
        { text: "I intercede and wait for God's timing", chars: { esther: 3, abraham: 2 } },
        { text: "I confront it directly with truth", chars: { paul: 3, deborah: 2, peter: 1 } },
        { text: "I trust God to vindicate me in time", chars: { joseph: 3, david: 2 } },
        { text: "I seek wise counsel before acting", chars: { timothy: 2, priscilla: 2, moses: 2 } }
    ]}
];

let quizState = { screen: 'start', qIndex: 0, answer: null, scores: {} };

function renderSeasonsTool() {
    return `<div style="min-height:100vh;background:linear-gradient(145deg,var(--bg-primary),var(--slate-900))"><div style="max-width:600px;margin:0 auto;padding:var(--space-lg)"><button class="btn btn-ghost" onclick="backToTools()" style="margin-bottom:var(--space-lg)">‚Üê Back to Growth Tools</button><div id="quizContent"></div></div></div>`;
}

function backToTools() { State.set({ screen: 'app', activeNav: 'tools' }); }

function initQuiz() {
    quizState = { screen: 'start', qIndex: 0, answer: null, scores: {} };
    renderQuiz();
}

function renderQuiz() {
    const container = document.getElementById('quizContent');
    if (!container) return;
    
    if (quizState.screen === 'start') {
        container.innerHTML = `
            <div class="card fade-up" style="text-align:center;padding:var(--space-2xl)">
                <div style="font-size:4rem;margin-bottom:var(--space-lg)">üå±</div>
                <h2 style="font-size:2rem;margin-bottom:var(--space-md)">Discover Your Season</h2>
                <p style="color:var(--text-secondary);margin-bottom:var(--space-sm)">12 Biblical Characters ‚Ä¢ 10 Questions</p>
                <p style="color:var(--text-secondary);margin-bottom:var(--space-xl)">Find which biblical character's journey mirrors yours.</p>
                <button class="btn btn-primary btn-lg" onclick="startQuiz()">Begin Assessment</button>
            </div>`;
    } else if (quizState.screen === 'quiz') {
        const q = QUESTIONS[quizState.qIndex];
        container.innerHTML = `
            <div class="card fade-up">
                <div style="display:flex;justify-content:space-between;color:var(--text-tertiary);margin-bottom:var(--space-md)">
                    <span>Question ${quizState.qIndex + 1} of ${QUESTIONS.length}</span>
                    <span>${Math.round(((quizState.qIndex + 1) / QUESTIONS.length) * 100)}%</span>
                </div>
                <div style="height:6px;background:var(--border-color);border-radius:3px;margin-bottom:var(--space-xl)">
                    <div style="height:100%;width:${((quizState.qIndex + 1) / QUESTIONS.length) * 100}%;background:linear-gradient(90deg,var(--root-green),var(--leaf-green));border-radius:3px;transition:width 0.3s"></div>
                </div>
                <h3 style="margin-bottom:var(--space-xl);font-size:1.1rem">${q.q}</h3>
                <div style="display:flex;flex-direction:column;gap:var(--space-md)">
                    ${q.a.map((a, i) => `
                        <button class="btn ${quizState.answer === i ? 'btn-primary' : 'btn-secondary'}" style="justify-content:flex-start;text-align:left;padding:var(--space-lg);white-space:normal" onclick="selectAnswer(${i})">${a.text}</button>
                    `).join('')}
                </div>
                <button class="btn btn-primary btn-lg btn-block" style="margin-top:var(--space-xl)" onclick="nextQuestion()" ${quizState.answer === null ? 'disabled' : ''}>${quizState.qIndex === QUESTIONS.length - 1 ? 'See Results' : 'Next Question'}</button>
            </div>`;
    } else if (quizState.screen === 'result') {
        const sorted = Object.entries(quizState.scores).sort((a, b) => b[1] - a[1]);
        const topId = sorted[0][0];
        const char = CHARACTERS[topId];
        
        if (Auth.currentUser) {
            UserDB.saveQuizResult(Auth.currentUser.uid, 'seasons', { character: topId, scores: quizState.scores });
            UserDB.saveToolProgress(Auth.currentUser.uid, 'seasons', { completed: true, character: topId });
        }
        
        container.innerHTML = `
            <div class="card fade-up" style="text-align:center;padding:var(--space-2xl)">
                <div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,${char.color},${char.color}aa);display:flex;align-items:center;justify-content:center;font-size:3rem;margin:0 auto var(--space-lg)">${char.icon}</div>
                <p style="color:var(--root-green);text-transform:uppercase;letter-spacing:2px;font-size:0.85rem">Your Season</p>
                <h2 style="font-size:2rem;margin-bottom:var(--space-xs)">${char.name}</h2>
                <p style="color:var(--leaf-green);margin-bottom:var(--space-lg)">${char.title}</p>
                <p style="color:var(--text-secondary);margin-bottom:var(--space-xl);max-width:400px;margin-left:auto;margin-right:auto">${char.description}</p>
                <div style="display:flex;gap:var(--space-md);justify-content:center;flex-wrap:wrap">
                    <button class="btn btn-secondary" onclick="initQuiz()">Retake Quiz</button>
                    <button class="btn btn-primary" onclick="backToTools()">Back to Tools</button>
                </div>
            </div>`;
    }
}

function startQuiz() { quizState.screen = 'quiz'; renderQuiz(); }
function selectAnswer(i) { quizState.answer = i; renderQuiz(); }

function nextQuestion() {
    if (quizState.answer === null) return;
    const chars = QUESTIONS[quizState.qIndex].a[quizState.answer].chars;
    Object.entries(chars).forEach(([c, s]) => {
        quizState.scores[c] = (quizState.scores[c] || 0) + s;
    });
    if (quizState.qIndex < QUESTIONS.length - 1) {
        quizState.qIndex++;
        quizState.answer = null;
        renderQuiz();
    } else {
        quizState.screen = 'result';
        renderQuiz();
    }
}

// ========== INIT ==========
async function init() {
    document.body.dataset.theme = localStorage.getItem('rooted_theme') || 'dark';
    initFirebase();
    State.subscribe(render);
    const savedNav = localStorage.getItem('rooted_nav');
    const user = await Auth.init();
    if (user) {
        const activeNav = savedNav || 'dashboard';
        localStorage.removeItem('rooted_nav');
        State.set({ screen: 'app', user, activeNav });
    } else {
        State.set({ screen: 'welcome' });
    }
}

init();
</script>
</body>
</html>
